<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∫íÂãïÂºèÁè≠Á¥öÂ∫ß‰ΩçË°®</title>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #718096;
            font-size: 1.1rem;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .classroom {
            background: #f8fafc;
            border-radius: 15px;
            padding: 30px;
            position: relative;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .teacher-desk {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 30px;
            font-size: 1.1rem;
            width: 100%;
            max-width: 400px;
        }

        .seating-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            width: 100%;
            max-width: none;
            margin: 0 auto;
            justify-content: center;
        }

        .seat {
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        .seat:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .seat.occupied {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border-color: #3182ce;
        }

        .seat.occupied:hover {
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
        }

        .seat.on-leave {
            background: linear-gradient(135deg, #fbb6ce 0%, #f093fb 100%);
            color: #2d3748;
            border-color: #ed64a6;
            position: relative;
        }

        .seat.on-leave:hover {
            background: linear-gradient(135deg, #f093fb 0%, #ed64a6 100%);
        }

        .seat.on-leave::before {
            content: 'üè•';
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .seat.drag-source {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .seat.drag-over {
            border-color: #48bb78 !important;
            background: #f0fff4 !important;
            transform: scale(1.05);
        }

        .seat.occupied.drag-over {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%) !important;
        }

        .seat.lottery-selected {
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%) !important;
            border: 4px solid #ff6b35 !important;
            color: #2d3748 !important;
            animation: lotteryPulse 1s ease-in-out infinite alternate;
            box-shadow: 0 0 25px rgba(255, 107, 53, 0.8) !important;
        }

        .seat.lottery-current {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%) !important;
            border: 4px solid #ff3838 !important;
            color: white !important;
            animation: currentPulse 1.2s ease-in-out infinite alternate;
            box-shadow: 0 0 30px rgba(255, 56, 56, 1) !important;
            transform: scale(1.05) !important;
        }

        .seat.lottery-previous {
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%) !important;
            border: 3px solid #ff6b35 !important;
            color: #2d3748 !important;
            box-shadow: 0 0 15px rgba(255, 107, 53, 0.5) !important;
            animation: none !important;
        }

        .seat.lottery-animation {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%) !important;
            border: 3px solid #2b6cb0 !important;
            color: white !important;
            animation: lotteryFlash 0.3s ease-in-out;
            box-shadow: 0 0 15px rgba(66, 153, 225, 0.6) !important;
        }

        @keyframes lotteryPulse {
            from {
                transform: scale(1) translateY(-3px);
                box-shadow: 0 8px 25px rgba(255, 107, 53, 0.6);
            }
            to {
                transform: scale(1.05) translateY(-5px);
                box-shadow: 0 12px 30px rgba(255, 107, 53, 1);
            }
        }

        @keyframes currentPulse {
            from {
                transform: scale(1.05) translateY(-3px);
                box-shadow: 0 10px 30px rgba(255, 56, 56, 0.8);
            }
            to {
                transform: scale(1.1) translateY(-6px);
                box-shadow: 0 15px 40px rgba(255, 56, 56, 1);
            }
        }

        @keyframes lotteryFlash {
            0% {
                transform: scale(1);
                box-shadow: 0 0 15px rgba(66, 153, 225, 0.6);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 25px rgba(66, 153, 225, 1);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 15px rgba(66, 153, 225, 0.6);
            }
        }

        @keyframes resultPop {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        @keyframes timerFinished {
            from {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(245, 101, 101, 0.5);
            }
            to {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(245, 101, 101, 1);
            }
        }

        @keyframes timerNotificationPulse {
            from {
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            }
            to {
                transform: translate(-50%, -50%) scale(1.05);
                box-shadow: 0 25px 50px rgba(0,0,0,0.4);
            }
        }

        .drag-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: grab;
        }

        .drag-indicator:active {
            cursor: grabbing;
        }



        .seat-number {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .student-name {
            font-weight: 600;
            font-size: 1rem;
            text-align: center;
        }

        .student-score {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 0.9rem;
        }

        .score-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.2s ease;
            color: #4a5568;
        }

        .score-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        .score-btn.plus:hover {
            background: #48bb78;
            color: white;
        }

        .score-btn.minus:hover {
            background: #f56565;
            color: white;
        }

        .score-display {
            background: rgba(255,255,255,0.9);
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
            color: #2d3748;
        }

        .score-display.negative {
            color: #e53e3e;
            background: rgba(254, 226, 226, 0.9);
        }

        .empty-seat {
            color: #a0aec0;
            font-style: italic;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            min-width: 300px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .stats {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
            text-align: center;
        }

        .stat-item {
            text-align: center;
            padding: 15px 25px;
            background: #f7fafc;
            border-radius: 10px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .seating-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
            }
            
            .seat {
                padding: 15px 10px;
                min-height: 70px;
            }
            
            .container {
                padding: 20px;
            }
            
            .title {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .seating-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üè´ ‰∫íÂãïÂºèÁè≠Á¥öÂ∫ß‰ΩçË°®</h1>
        </div>

        <!-- Áè≠Á¥öÈÅ∏ÊìáÂçÄÂüü -->
        <div class="class-selector" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 15px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <h3 style="margin: 0; font-size: 1.2rem;">üè´ ÁõÆÂâçÁè≠Á¥öÔºö</h3>
                    <select id="classSelector" onchange="switchClass()" style="padding: 10px 15px; border-radius: 8px; border: none; font-size: 1rem; min-width: 150px; font-weight: 600;">
                        <option value="class1">‰∏ÄÂπ¥‰∏ÄÁè≠</option>
                    </select>
                    <span id="classStats" style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 6px; font-size: 0.9rem;">
                        0 ‰ΩçÂ≠∏Áîü
                    </span>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="showAddClassModal()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                        ‚ûï Êñ∞Â¢ûÁè≠Á¥ö
                    </button>
                    <button class="btn" onclick="showManageClassModal()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                        ‚öôÔ∏è ÁÆ°ÁêÜÁè≠Á¥ö
                    </button>
                    <button id="toggleControlsBtn" class="btn" onclick="toggleControls()" style="background: #4a5568; color: white;">
                        üìã È°ØÁ§∫ÂäüËÉΩË°®
                    </button>
                    <button id="fullscreenBtn" class="btn" onclick="toggleFullscreen()" style="background: #38a169; color: white;">
                        üñ•Ô∏è ÂÖ®Ëû¢ÂπïÈ°ØÁ§∫
                    </button>
                </div>
            </div>
        </div>



        <!-- ÂäüËÉΩË°®Èù¢Êùø -->
        <div class="controls" id="controlsPanel" style="display: none;">
            <button class="btn btn-primary" onclick="showImportModal()">üì• ÂåØÂÖ•Â≠∏Áîü</button>
            <button class="btn btn-primary" onclick="showLayoutModal()">‚öôÔ∏è Ë™øÊï¥ÈÖçÁΩÆ</button>
            <button class="btn btn-primary" onclick="showLotteryControls()">üé≤ ÊäΩÁ±§</button>
            <button class="btn btn-primary" onclick="showTimerModal()">‚è∞ ÂÄíÊï∏Ë®àÊôÇ</button>
            <button class="btn btn-primary" onclick="showLeaveModal()">üè• Ë´ãÂÅá</button>
            <button class="btn btn-secondary" onclick="exportData()">üíæ ÂåØÂá∫Ë≥áÊñô</button>
            <button class="btn btn-secondary" onclick="exportToExcel()">üìä ÂåØÂá∫Excel</button>
            <button class="btn btn-secondary" onclick="showImportDataModal()">üìÇ ÂåØÂÖ•Ë≥áÊñô</button>

        </div>

        <!-- ÊäΩÁ±§ÊéßÂà∂Èù¢Êùø -->
        <div class="lottery-controls" id="lotteryControls" style="display: none;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; font-size: 1.3rem;">üé≤ ÊäΩÁ±§ÊéßÂà∂Âè∞</h3>
                
                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap; justify-content: center;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-weight: 600;">‰∏ÄÊ¨°ÊäΩÂèñÔºö</label>
                        <select id="lotteryCount" style="padding: 8px 12px; border-radius: 8px; border: none; font-size: 1rem; min-width: 80px;">
                            <option value="1">1 ‰∫∫</option>
                            <option value="2">2 ‰∫∫</option>
                            <option value="3">3 ‰∫∫</option>
                            <option value="4">4 ‰∫∫</option>
                            <option value="5">5 ‰∫∫</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-weight: 600;">ÊäΩÁ±§Ê®°ÂºèÔºö</label>
                        <select id="lotteryMode" style="padding: 8px 12px; border-radius: 8px; border: none; font-size: 1rem; min-width: 120px;">
                            <option value="continue">ÈÄ£Á∫åÊäΩÁ±§</option>
                            <option value="reset">ÈáçË§áÊäΩÁ±§</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-weight: 600;">üîä Èü≥ÊïàÔºö</label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="soundEnabled" checked style="transform: scale(1.2);">
                            <span id="soundStatus" style="font-size: 0.9rem;">ÈñãÂïü</span>
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="startDirectLottery()" style="background: #48bb78; color: white; border: none;">
                            üéØ ÈñãÂßãÊäΩÁ±§
                        </button>
                        <button class="btn" onclick="resetLottery()" style="background: #f56565; color: white; border: none;">
                            üîÑ ÈáçË®≠ÊäΩÁ±§
                        </button>
                        <button class="btn" onclick="hideLotteryControls()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                            ‚úï ÈóúÈñâ
                        </button>
                    </div>
                </div>
                
                <div id="lotteryStatus" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center; font-size: 0.9rem;">
                    <span id="availableStudentsInfo">Ê∫ñÂÇôÂ∞±Á∑í</span>
                </div>
            </div>
        </div>

        <div class="classroom">
            <div class="teacher-desk">
                üë©‚Äçüè´ Ë¨õÂè∞ÂçÄÂüü
            </div>
            
            <div class="seating-grid" id="seatingGrid">
                <!-- Â∫ß‰ΩçÂ∞áÁî± JavaScript ÂãïÊÖãÁîüÊàê -->
            </div>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="occupiedCount">0</div>
                <div class="stat-label">Â∑≤ÂÆâÊéíÂ∫ß‰Ωç</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="emptyCount">30</div>
                <div class="stat-label">Á©∫Â∫ß‰Ωç</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalSeatsCount">30</div>
                <div class="stat-label">Á∏ΩÂ∫ß‰ΩçÊï∏</div>
            </div>
        </div>
    </div>

    <!-- Á∑®ËºØÂ∫ß‰ΩçÊ®°ÊÖãÊ°Ü -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h3 class="modal-title">Á∑®ËºØÂ∫ß‰ΩçË≥áË®ä</h3>
            <div class="form-group">
                <label class="form-label">Â≠∏ÁîüÂßìÂêç</label>
                <input type="text" class="form-input" id="studentNameInput" placeholder="Ë´ãËº∏ÂÖ•Â≠∏ÁîüÂßìÂêç">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="saveStudent()">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>

    <!-- ÂåØÂÖ•Â≠∏ÁîüÂêçÂñÆÊ®°ÊÖãÊ°Ü -->
    <div class="modal" id="importModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="modal-title">üì• ÂåØÂÖ•Â≠∏ÁîüÂêçÂñÆ</h3>
            <div class="form-group">
                <label class="form-label">Ëº∏ÂÖ•ÊñπÂºè</label>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-secondary" id="textInputBtn" onclick="switchImportMode('text')" style="flex: 1;">ÊâãÂãïËº∏ÂÖ•</button>
                    <button class="btn btn-secondary" id="fileInputBtn" onclick="switchImportMode('file')" style="flex: 1;">Ê™îÊ°à‰∏äÂÇ≥</button>
                </div>
            </div>
            
            <!-- ÊâãÂãïËº∏ÂÖ•Ê®°Âºè -->
            <div id="textInputMode">
                <div class="form-group">
                    <label class="form-label">Â≠∏ÁîüÂßìÂêç (ÊØèË°å‰∏ÄÂÄãÂßìÂêç)</label>
                    <textarea class="form-input" id="studentListInput" rows="8" placeholder="Ë´ãËº∏ÂÖ•Â≠∏ÁîüÂßìÂêçÔºåÊØèË°å‰∏ÄÂÄãÔºö&#10;&#10;ÁéãÂ∞èÊòé&#10;ÊùéÂ∞èËèØ&#10;ÂºµÂ∞èÁæé&#10;Èô≥Â∞èÂº∑"></textarea>
                </div>
                <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #2c5282;">
                    üí° <strong>‰ΩøÁî®Ë™™ÊòéÔºö</strong><br>
                    ‚Ä¢ ÊØèË°åËº∏ÂÖ•‰∏ÄÂÄãÂ≠∏ÁîüÂßìÂêç<br>
                    ‚Ä¢ Á≥ªÁµ±ÊúÉÊåâÈ†ÜÂ∫èÂàÜÈÖçÂ∫ß‰ΩçÔºàÂæûÂ∫ß‰Ωç1ÈñãÂßãÔºâ<br>
                    ‚Ä¢ ÊúÄÂ§öÊîØÊè¥ <span id="maxStudentsText">30</span> ‰ΩçÂ≠∏Áîü
                </div>
            </div>
            
            <!-- Ê™îÊ°à‰∏äÂÇ≥Ê®°Âºè -->
            <div id="fileInputMode" style="display: none;">
                <div class="form-group">
                    <label class="form-label">ÈÅ∏ÊìáÊñáÂ≠óÊ™îÊ°à (.txt)</label>
                    <input type="file" class="form-input" id="fileInput" accept=".txt" style="padding: 8px;">
                </div>
                <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #2c5282;">
                    üí° <strong>Ê™îÊ°àÊ†ºÂºèÔºö</strong><br>
                    ‚Ä¢ Á¥îÊñáÂ≠óÊ™îÊ°à (.txt)<br>
                    ‚Ä¢ ÊØèË°å‰∏ÄÂÄãÂ≠∏ÁîüÂßìÂêç<br>
                    ‚Ä¢ ‰ΩøÁî® UTF-8 Á∑®Á¢º
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeImportModal()">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="importStudents()">ÂåØÂÖ•‰∏¶ÊåâÈ†ÜÂ∫èÊéíÂ∫ß‰Ωç</button>
            </div>
        </div>
    </div>

    <!-- ÂåØÂÖ•Ë≥áÊñôÊ®°ÊÖãÊ°Ü -->
    <div class="modal" id="importDataModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="modal-title">üìÇ ÂåØÂÖ•Â∫ß‰ΩçË≥áÊñô</h3>
            <div class="form-group">
                <label class="form-label">ÈÅ∏ÊìáË≥áÊñôÊ™îÊ°à (.json)</label>
                <input type="file" class="form-input" id="dataFileInput" accept=".json" style="padding: 8px;">
            </div>
            <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #2c5282;">
                üí° <strong>ÂåØÂÖ•Ë™™ÊòéÔºö</strong><br>
                ‚Ä¢ Ë´ãÈÅ∏Êìá‰πãÂâçÂåØÂá∫ÁöÑ JSON Ë≥áÊñôÊ™îÊ°à<br>
                ‚Ä¢ ÊîØÊè¥ÂñÆÁè≠Á¥öÊàñÂ§öÁè≠Á¥öË≥áÊñôÊ†ºÂºè<br>
                ‚Ä¢ Â∞áÊúÉÂÆåÊï¥ÈÇÑÂéüÊâÄÊúâÁè≠Á¥öÁöÑÂ∫ß‰ΩçÈÖçÁΩÆ„ÄÅÂ≠∏ÁîüÂßìÂêçÂíåÂàÜÊï∏<br>
                ‚Ä¢ ÂåØÂÖ•ÂæåÊúÉË¶ÜËìãÁõÆÂâçÁöÑÊâÄÊúâÁè≠Á¥öË≥áÊñô
            </div>
            <div id="importDataWarning" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #856404; display: none;">
                ‚ö†Ô∏è <strong>Ê≥®ÊÑèÔºö</strong>ÂåØÂÖ•Ë≥áÊñôÂ∞áÊúÉË¶ÜËìãÁõÆÂâçÊâÄÊúâÁè≠Á¥öÁöÑÂ∫ß‰ΩçÂÆâÊéíÂíåÂ≠∏ÁîüË≥áÊñôÔºÅ
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeImportDataModal()">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="importData()">ÂåØÂÖ•Ë≥áÊñô</button>
            </div>
        </div>
    </div>

    <!-- ÊäΩÁ±§Ê®°ÊÖãÊ°Ü -->
    <div class="modal" id="lotteryModal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <h3 class="modal-title">üé≤ ÊäΩÁ±§ÈÅ∏Â≠∏Áîü</h3>
            
            <div id="lotteryWheel" style="margin: 30px 0;">
                <div id="wheelContainer" style="position: relative; width: 300px; height: 300px; margin: 0 auto; border-radius: 50%; border: 8px solid #667eea; background: conic-gradient(from 0deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57, #ff9ff3, #54a0ff, #5f27cd); animation: none; transition: transform 3s cubic-bezier(0.23, 1, 0.32, 1);">
                    <div id="wheelPointer" style="position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-bottom: 30px solid #2d3748; z-index: 10;"></div>
                    <div id="wheelCenter" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: white; border-radius: 50%; border: 4px solid #667eea; display: flex; align-items: center; justify-content: center; font-size: 24px; z-index: 5;">üéØ</div>
                </div>
            </div>
            
            <div id="lotteryResult" style="margin: 20px 0; min-height: 60px; display: flex; align-items: center; justify-content: center;">
                <div id="resultDisplay" style="font-size: 1.5rem; font-weight: bold; color: #667eea; display: none;">
                    üéâ ÊäΩ‰∏≠Ôºö<span id="selectedStudent"></span>
                </div>
                <div id="readyMessage" style="color: #718096;">
                    ÈªûÊìä„ÄåÈñãÂßãÊäΩÁ±§„Äç‰æÜÈö®Ê©üÈÅ∏Êìá‰∏Ä‰ΩçÂ≠∏ÁîüÔºÅ
                </div>
            </div>
            
            <div id="lotteryStats" style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 20px 0; font-size: 0.9rem; color: #2c5282;">
                üìä <strong>ÊäΩÁ±§Ë≥áË®äÔºö</strong><br>
                ‚Ä¢ ÂèÉËàáÂ≠∏ÁîüÔºö<span id="lotteryStudentCount">0</span> ‰Ωç<br>
                ‚Ä¢ ÊØè‰ΩçÂ≠∏Áîü‰∏≠Á±§Ê©üÁéáÁõ∏Á≠â
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeLotteryModal()">ÈóúÈñâ</button>
                <button class="btn btn-primary" id="lotteryBtn" onclick="spinWheel()">üé≤ ÈñãÂßãÊäΩÁ±§</button>
            </div>
        </div>
    </div>

    <!-- Êñ∞Â¢ûÁè≠Á¥öÊ®°ÊÖãÊ°Ü -->
    <div class="modal" id="addClassModal">
        <div class="modal-content" style="max-width: 400px;">
            <h3 class="modal-title">‚ûï Êñ∞Â¢ûÁè≠Á¥ö</h3>
            <div class="form-group">
                <label class="form-label">Áè≠Á¥öÂêçÁ®±</label>
                <input type="text" class="form-input" id="newClassName" placeholder="‰æãÂ¶ÇÔºö‰∫åÂπ¥‰∏âÁè≠">
            </div>
            <div class="form-group">
                <label class="form-label">Â∫ß‰ΩçÈÖçÁΩÆ</label>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div style="flex: 1;">
                        <label style="font-size: 0.9rem; color: #718096;">ÂàóÊï∏</label>
                        <input type="number" class="form-input" id="newClassColumns" value="6" min="1" max="10" style="text-align: center;">
                    </div>
                    <div style="flex: 1;">
                        <label style="font-size: 0.9rem; color: #718096;">Ê¨ÑÊï∏</label>
                        <input type="number" class="form-input" id="newClassRows" value="5" min="1" max="10" style="text-align: center;">
                    </div>
                </div>
            </div>
            <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #2c5282;">
                üí° <strong>Ë™™ÊòéÔºö</strong><br>
                ‚Ä¢ Êñ∞Áè≠Á¥öÂ∞á‰ΩøÁî®ÊåáÂÆöÁöÑÂ∫ß‰ΩçÈÖçÁΩÆ<br>
                ‚Ä¢ ÂèØ‰ª•Á®çÂæåË™øÊï¥Â∫ß‰ΩçÈÖçÁΩÆÂíåÂåØÂÖ•Â≠∏ÁîüÂêçÂñÆ<br>
                ‚Ä¢ ÊØèÂÄãÁè≠Á¥öÁöÑË≥áÊñôÈÉΩÊúÉÁç®Á´ãÂÑ≤Â≠ò
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeAddClassModal()">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="createNewClass()">Âª∫Á´ãÁè≠Á¥ö</button>
            </div>
        </div>
    </div>

    <!-- ÁÆ°ÁêÜÁè≠Á¥öÊ®°ÊÖãÊ°Ü -->
    <div class="modal" id="manageClassModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="modal-title">‚öôÔ∏è ÁÆ°ÁêÜÁè≠Á¥ö</h3>
            <div id="classListContainer" style="max-height: 300px; overflow-y: auto;">
                <!-- Áè≠Á¥öÂàóË°®Â∞áÁî± JavaScript ÂãïÊÖãÁîüÊàê -->
            </div>
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin: 20px 0; font-size: 0.9rem; color: #856404;">
                ‚ö†Ô∏è <strong>Ê≥®ÊÑèÔºö</strong>Âà™Èô§Áè≠Á¥öÂ∞áÊúÉÊ∞∏‰πÖÁßªÈô§Ë©≤Áè≠Á¥öÁöÑÊâÄÊúâÂ≠∏ÁîüË≥áÊñôÂíåÂ∫ß‰ΩçÂÆâÊéíÔºÅ
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeManageClassModal()">ÈóúÈñâ</button>
            </div>
        </div>
    </div>

    <!-- Â≠∏ÁîüË´ãÂÅáÁÆ°ÁêÜÊ®°ÊÖãÊ°Ü -->
    <div class="modal" id="leaveModal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 class="modal-title">üè• Â≠∏ÁîüË´ãÂÅáÁÆ°ÁêÜ</h3>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <button class="btn btn-primary" id="leaveTabBtn" onclick="switchLeaveTab('leave')" style="flex: 1;">Ë®≠ÂÆöË´ãÂÅá</button>
                <button class="btn btn-secondary" id="returnTabBtn" onclick="switchLeaveTab('return')" style="flex: 1;">Èä∑ÂÅáËøîÊ†°</button>
                <button class="btn btn-secondary" id="historyTabBtn" onclick="switchLeaveTab('history')" style="flex: 1;">Ë´ãÂÅáË®òÈåÑ</button>
            </div>
            
            <!-- Ë®≠ÂÆöË´ãÂÅáÈ†ÅÈù¢ -->
            <div id="leaveTab">
                <div class="form-group">
                    <label class="form-label">ÈÅ∏ÊìáË´ãÂÅáÂ≠∏Áîü</label>
                    <select class="form-input" id="leaveStudentSelect">
                        <option value="">Ë´ãÈÅ∏ÊìáÂ≠∏Áîü</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ë´ãÂÅáÈ°ûÂûã</label>
                    <select class="form-input" id="leaveTypeSelect">
                        <option value="sick">ÁóÖÂÅá ü§í</option>
                        <option value="personal">‰∫ãÂÅá üìã</option>
                        <option value="family">ÂÆ∂Â∫≠‰∫ãÂÅá üè†</option>
                        <option value="other">ÂÖ∂‰ªñ üìù</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ë´ãÂÅáÂéüÂõ† (ÈÅ∏Â°´)</label>
                    <textarea class="form-input" id="leaveReasonInput" rows="3" placeholder="Ë´ãËº∏ÂÖ•Ë´ãÂÅáÂéüÂõ†..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ë´ãÂÅáÊó•Êúü</label>
                    <input type="date" class="form-input" id="leaveDateInput">
                </div>
                
                <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #2c5282;">
                    üí° <strong>Ë™™ÊòéÔºö</strong><br>
                    ‚Ä¢ Ë®≠ÂÆöË´ãÂÅáÂæåÔºåË©≤Â≠∏ÁîüÂ∫ß‰ΩçÊúÉÈ°ØÁ§∫ÁÇ∫Á≤âËâ≤‰∏¶Ê®ôÁ§∫Ë´ãÂÅáÂúñÁ§∫<br>
                    ‚Ä¢ Ë´ãÂÅáÂ≠∏Áîü‰∏çÊúÉÂèÉËàáÊäΩÁ±§Ê¥ªÂãï<br>
                    ‚Ä¢ ÂèØÈö®ÊôÇÁÇ∫Â≠∏ÁîüËæ¶ÁêÜÈä∑ÂÅáËøîÊ†°
                </div>
                
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeLeaveModal()">ÂèñÊ∂à</button>
                    <button class="btn btn-primary" onclick="setStudentLeave()">üè• Ë®≠ÂÆöË´ãÂÅá</button>
                </div>
            </div>
            
            <!-- Èä∑ÂÅáËøîÊ†°È†ÅÈù¢ -->
            <div id="returnTab" style="display: none;">
                <div id="onLeaveStudentsList">
                    <!-- Ë´ãÂÅáÂ≠∏ÁîüÂàóË°®Â∞áÁî± JavaScript ÂãïÊÖãÁîüÊàê -->
                </div>
                
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeLeaveModal()">ÈóúÈñâ</button>
                </div>
            </div>
            
            <!-- Ë´ãÂÅáË®òÈåÑÈ†ÅÈù¢ -->
            <div id="historyTab" style="display: none;">
                <div style="max-height: 300px; overflow-y: auto;">
                    <div id="leaveHistoryList">
                        <!-- Ë´ãÂÅáË®òÈåÑÂ∞áÁî± JavaScript ÂãïÊÖãÁîüÊàê -->
                    </div>
                </div>
                
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin: 20px 0; font-size: 0.9rem; color: #856404;">
                    üìä <strong>Áµ±Ë®àË≥áË®äÔºö</strong><br>
                    ‚Ä¢ ÁõÆÂâçË´ãÂÅá‰∫∫Êï∏Ôºö<span id="currentLeaveCount">0</span> ‰∫∫<br>
                    ‚Ä¢ Ê≠∑Âè≤Ë´ãÂÅáË®òÈåÑÔºö<span id="totalLeaveRecords">0</span> Á≠Ü
                </div>
                
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeLeaveModal()">ÈóúÈñâ</button>
                    <button class="btn btn-secondary" onclick="clearLeaveHistory()">üóëÔ∏è Ê∏ÖÈô§Ê≠∑Âè≤Ë®òÈåÑ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂÄíÊï∏Ë®àÊôÇÂô®Ê®°ÊÖãÊ°Ü -->
    <div class="modal" id="timerModal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <h3 class="modal-title">‚è∞ ÂÄíÊï∏Ë®àÊôÇÂô®</h3>
            
            <!-- Ë®àÊôÇÂô®Ë®≠ÂÆöÂçÄÂüü -->
            <div id="timerSetup" style="margin: 20px 0;">
                <div style="display: flex; gap: 15px; justify-content: center; align-items: center; margin-bottom: 20px;">
                    <div style="text-align: center;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">ÂàÜÈêò</label>
                        <input type="number" id="timerMinutes" min="0" max="59" value="5" style="width: 60px; padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; text-align: center; font-size: 1.2rem; font-weight: bold;">
                    </div>
                    <div style="font-size: 2rem; color: #667eea; font-weight: bold;">:</div>
                    <div style="text-align: center;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">ÁßíÈêò</label>
                        <input type="number" id="timerSeconds" min="0" max="59" value="0" style="width: 60px; padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; text-align: center; font-size: 1.2rem; font-weight: bold;">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="setQuickTimer(1, 0)" style="padding: 8px 12px; font-size: 0.9rem;">1ÂàÜÈêò</button>
                    <button class="btn btn-secondary" onclick="setQuickTimer(3, 0)" style="padding: 8px 12px; font-size: 0.9rem;">3ÂàÜÈêò</button>
                    <button class="btn btn-secondary" onclick="setQuickTimer(5, 0)" style="padding: 8px 12px; font-size: 0.9rem;">5ÂàÜÈêò</button>
                    <button class="btn btn-secondary" onclick="setQuickTimer(10, 0)" style="padding: 8px 12px; font-size: 0.9rem;">10ÂàÜÈêò</button>
                    <button class="btn btn-secondary" onclick="setQuickTimer(0, 30)" style="padding: 8px 12px; font-size: 0.9rem;">30Áßí</button>
                </div>
            </div>
            
            <!-- Ë®àÊôÇÂô®È°ØÁ§∫ÂçÄÂüü -->
            <div id="timerDisplay" style="margin: 30px 0;">
                <div id="timerCircle" style="width: 200px; height: 200px; margin: 0 auto; border-radius: 50%; border: 8px solid #e2e8f0; display: flex; align-items: center; justify-content: center; position: relative; background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); transition: all 0.3s ease;">
                    <div id="timerText" style="font-size: 2.5rem; font-weight: bold; color: #667eea;">05:00</div>
                    <svg style="position: absolute; top: -8px; left: -8px; width: 216px; height: 216px; transform: rotate(-90deg);">
                        <circle id="timerProgress" cx="108" cy="108" r="100" fill="none" stroke="#667eea" stroke-width="8" stroke-dasharray="628.32" stroke-dashoffset="628.32" style="transition: stroke-dashoffset 1s linear;"></circle>
                    </svg>
                </div>
                
                <div id="timerStatus" style="margin-top: 20px; font-size: 1.1rem; color: #718096; font-weight: 600;">
                    Ê∫ñÂÇôÈñãÂßãË®àÊôÇ
                </div>
            </div>
            
            <!-- Ë®àÊôÇÂô®ÊéßÂà∂ÊåâÈàï -->
            <div id="timerControls" style="margin: 20px 0;">
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" id="startTimerBtn" onclick="startTimer()" style="background: #48bb78; border: none;">
                        ‚ñ∂Ô∏è ÈñãÂßãË®àÊôÇ
                    </button>
                    <button class="btn btn-secondary" id="pauseTimerBtn" onclick="pauseTimer()" style="display: none;">
                        ‚è∏Ô∏è Êö´ÂÅú
                    </button>
                    <button class="btn btn-secondary" id="resumeTimerBtn" onclick="resumeTimer()" style="display: none;">
                        ‚ñ∂Ô∏è ÁπºÁ∫å
                    </button>
                    <button class="btn btn-secondary" onclick="resetTimer()">
                        üîÑ ÈáçË®≠
                    </button>
                </div>
            </div>
            
            <!-- Èü≥ÊïàË®≠ÂÆö -->
            <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 20px 0; font-size: 0.9rem; color: #2c5282;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="timerSoundEnabled" checked style="transform: scale(1.2);">
                        <span>üîä ÁµêÊùüÊèêÁ§∫Èü≥</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="timerTickEnabled" style="transform: scale(1.2);">
                        <span>‚è±Ô∏è Êª¥Á≠îËÅ≤</span>
                    </label>
                </div>
                <div style="font-size: 0.8rem; color: #4a5568;">
                    üí° Ë®àÊôÇÁµêÊùüÊôÇÊúÉÊí≠ÊîæÊèêÁ§∫Èü≥‰∏¶È°ØÁ§∫ÈÄöÁü•
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeTimerModal()">ÈóúÈñâ</button>
            </div>
        </div>
    </div>

    <!-- Â∫ß‰ΩçÈÖçÁΩÆË™øÊï¥Ê®°ÊÖãÊ°Ü -->
    <div class="modal" id="layoutModal">
        <div class="modal-content" style="max-width: 400px;">
            <h3 class="modal-title">‚öôÔ∏è Ë™øÊï¥Â∫ß‰ΩçÈÖçÁΩÆ</h3>
            
            <div class="form-group">
                <label class="form-label">ÂàóÊï∏ (Ê©´ÂêëÂ∫ß‰ΩçÊï∏)</label>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <input type="range" id="columnsSlider" min="1" max="10" value="6" style="flex: 1;" oninput="updateLayoutPreview()">
                    <span id="columnsValue" style="font-weight: bold; color: #667eea; min-width: 30px;">6</span>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ê¨ÑÊï∏ (Á∏±ÂêëÂ∫ß‰ΩçÊï∏)</label>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <input type="range" id="rowsSlider" min="1" max="10" value="5" style="flex: 1;" oninput="updateLayoutPreview()">
                    <span id="rowsValue" style="font-weight: bold; color: #667eea; min-width: 30px;">5</span>
                </div>
            </div>
            
            <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #2c5282;">
                üìä <strong>ÈÖçÁΩÆÈ†êË¶ΩÔºö</strong><br>
                ‚Ä¢ Á∏ΩÂ∫ß‰ΩçÊï∏Ôºö<span id="totalSeatsPreview" style="font-weight: bold;">30</span> ÂÄã<br>
                ‚Ä¢ ÈÖçÁΩÆÔºö<span id="layoutPreview" style="font-weight: bold;">6 Âàó √ó 5 Ê¨Ñ</span><br>
                ‚Ä¢ ÁèæÊúâÂ≠∏ÁîüÔºö<span id="currentStudentsCount" style="font-weight: bold;">0</span> ‰Ωç
            </div>
            
            <div id="layoutWarning" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #856404; display: none;">
                ‚ö†Ô∏è <strong>Ê≥®ÊÑèÔºö</strong>Êñ∞ÈÖçÁΩÆÁöÑÂ∫ß‰ΩçÊï∏Â∞ëÊñºÁèæÊúâÂ≠∏ÁîüÊï∏ÔºåÈÉ®ÂàÜÂ≠∏ÁîüÂ∞áË¢´ÁßªÈô§ÔºÅ
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeLayoutModal()">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="applyLayoutChanges()">Â•óÁî®ÈÖçÁΩÆ</button>
            </div>
        </div>
    </div>

    <script>
        let currentSeatIndex = null;
        let currentClassId = 'class1'; // ÁõÆÂâçÈÅ∏‰∏≠ÁöÑÁè≠Á¥öID
        
        // Â§öÁè≠Á¥öË≥áÊñôÁµêÊßã
        let classesData = {
            'class1': {
                name: '‰∏ÄÂπ¥‰∏ÄÁè≠',
                columns: 6,
                rows: 5,
                students: new Array(30).fill(null),
                studentScores: new Array(30).fill(0),
                studentLeaveStatus: new Array(30).fill(false), // Ë´ãÂÅáÁãÄÊÖã
                leaveHistory: [] // Ë´ãÂÅáË®òÈåÑ
            }
        };
        
        // ÁõÆÂâçÁè≠Á¥öÁöÑÂø´ÈÄüÂ≠òÂèñËÆäÊï∏ÔºàÁÇ∫‰∫ÜÂêëÂæåÁõ∏ÂÆπÔºâ
        let columns = 6; // ÂàóÊï∏ (Ê©´Âêë)
        let rows = 5;    // Ê¨ÑÊï∏ (Á∏±Âêë)
        let totalSeats = columns * rows;
        let students = new Array(totalSeats).fill(null);
        let studentScores = new Array(totalSeats).fill(0); // Â≠∏ÁîüÂàÜÊï∏Èô£Âàó
        let studentLeaveStatus = new Array(totalSeats).fill(false); // Â≠∏ÁîüË´ãÂÅáÁãÄÊÖãÈô£Âàó

        // ËºâÂÖ•ÁõÆÂâçÁè≠Á¥öË≥áÊñôÂà∞Âø´ÈÄüÂ≠òÂèñËÆäÊï∏
        function loadCurrentClassData() {
            const classData = classesData[currentClassId];
            if (classData) {
                columns = classData.columns;
                rows = classData.rows;
                totalSeats = columns * rows;
                students = [...classData.students];
                studentScores = [...classData.studentScores];
                studentLeaveStatus = [...(classData.studentLeaveStatus || new Array(totalSeats).fill(false))];
                
                // Á¢∫‰øùÈô£ÂàóÈï∑Â∫¶Ê≠£Á¢∫
                while (students.length < totalSeats) students.push(null);
                while (studentScores.length < totalSeats) studentScores.push(0);
                while (studentLeaveStatus.length < totalSeats) studentLeaveStatus.push(false);
                
                // Â¶ÇÊûúÈô£ÂàóÂ§™Èï∑ÔºåÊà™Êñ∑
                if (students.length > totalSeats) {
                    students = students.slice(0, totalSeats);
                    studentScores = studentScores.slice(0, totalSeats);
                    studentLeaveStatus = studentLeaveStatus.slice(0, totalSeats);
                }
                
                // Á¢∫‰øùË´ãÂÅáË®òÈåÑÂ≠òÂú®
                if (!classData.leaveHistory) {
                    classData.leaveHistory = [];
                }
            }
        }

        // ÂÑ≤Â≠òÁõÆÂâçÁè≠Á¥öË≥áÊñô
        function saveCurrentClassData() {
            if (classesData[currentClassId]) {
                classesData[currentClassId].columns = columns;
                classesData[currentClassId].rows = rows;
                classesData[currentClassId].students = [...students];
                classesData[currentClassId].studentScores = [...studentScores];
                classesData[currentClassId].studentLeaveStatus = [...studentLeaveStatus];
                
                // Ëá™ÂãïÂÑ≤Â≠òÂà∞ localStorage
                saveToLocalStorage();
            }
        }

        // ÂÑ≤Â≠òË≥áÊñôÂà∞ localStorage
        function saveToLocalStorage() {
            try {
                const dataToSave = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    currentClassId: currentClassId,
                    classesData: classesData
                };
                
                localStorage.setItem('seatingArrangementData', JSON.stringify(dataToSave));
                console.log('Ë≥áÊñôÂ∑≤Ëá™ÂãïÂÑ≤Â≠òÂà∞Êú¨Âú∞');
            } catch (error) {
                console.error('ÂÑ≤Â≠òÂà∞ localStorage Â§±Êïó:', error);
                // Â¶ÇÊûúÂÑ≤Â≠òÂ§±ÊïóÔºàÂèØËÉΩÊòØÁ©∫Èñì‰∏çË∂≥ÔºâÔºåÂòóË©¶Ê∏ÖÁêÜËàäË≥áÊñô
                if (error.name === 'QuotaExceededError') {
                    alert('Êú¨Âú∞ÂÑ≤Â≠òÁ©∫Èñì‰∏çË∂≥ÔºåË´ãÂåØÂá∫ÈáçË¶ÅË≥áÊñôÂæåÊ∏ÖÁêÜÁÄèË¶ΩÂô®Ë≥áÊñô„ÄÇ');
                }
            }
        }

        // Âæû localStorage ËºâÂÖ•Ë≥áÊñô
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('seatingArrangementData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    // Ê™¢Êü•Ë≥áÊñôÁâàÊú¨
                    if (parsedData.version === '2.0' && parsedData.classesData) {
                        // ËºâÂÖ•Â§öÁè≠Á¥öË≥áÊñô
                        classesData = { ...parsedData.classesData };
                        currentClassId = parsedData.currentClassId || Object.keys(classesData)[0];
                        
                        // Á¢∫‰øùÁõÆÂâçÁè≠Á¥öIDÂ≠òÂú®
                        if (!classesData[currentClassId]) {
                            currentClassId = Object.keys(classesData)[0];
                        }
                        
                        console.log('Â∑≤ÂæûÊú¨Âú∞ËºâÂÖ•Ë≥áÊñô:', Object.keys(classesData).length + ' ÂÄãÁè≠Á¥ö');
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('Âæû localStorage ËºâÂÖ•Ë≥áÊñôÂ§±Êïó:', error);
                return false;
            }
        }

        // Ê∏ÖÈô§ localStorage Ë≥áÊñô
        function clearLocalStorage() {
            try {
                localStorage.removeItem('seatingArrangementData');
                console.log('Êú¨Âú∞Ë≥áÊñôÂ∑≤Ê∏ÖÈô§');
            } catch (error) {
                console.error('Ê∏ÖÈô§Êú¨Âú∞Ë≥áÊñôÂ§±Êïó:', error);
            }
        }

        // Êõ¥Êñ∞Áè≠Á¥öÈÅ∏ÊìáÂô®
        function updateClassSelector() {
            const selector = document.getElementById('classSelector');
            selector.innerHTML = '';
            
            Object.keys(classesData).forEach(classId => {
                const option = document.createElement('option');
                option.value = classId;
                option.textContent = classesData[classId].name;
                if (classId === currentClassId) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
            
            updateClassStats();
        }

        // Êõ¥Êñ∞Áè≠Á¥öÁµ±Ë®à
        function updateClassStats() {
            const classData = classesData[currentClassId];
            if (classData) {
                const studentCount = classData.students.filter(s => s !== null && s !== undefined && s.trim() !== '').length;
                document.getElementById('classStats').textContent = `${studentCount} ‰ΩçÂ≠∏Áîü`;
            }
        }

        // ÂàáÊèõÁè≠Á¥ö
        function switchClass() {
            // ÂÑ≤Â≠òÁõÆÂâçÁè≠Á¥öË≥áÊñô
            saveCurrentClassData();
            
            // ÂàáÊèõÂà∞Êñ∞Áè≠Á¥ö
            const selector = document.getElementById('classSelector');
            currentClassId = selector.value;
            
            // ËºâÂÖ•Êñ∞Áè≠Á¥öË≥áÊñô
            loadCurrentClassData();
            
            // ÈáçÊñ∞ÂàùÂßãÂåñÂ∫ß‰ΩçË°®
            initializeSeating();
            
            // Èö±ËóèÊäΩÁ±§ÊéßÂà∂Èù¢ÊùøÔºàÂ¶ÇÊûúÈñãÂïüÁöÑË©±Ôºâ
            document.getElementById('lotteryControls').style.display = 'none';
            clearAllHighlights();
        }

        // È°ØÁ§∫Êñ∞Â¢ûÁè≠Á¥öÊ®°ÊÖãÊ°Ü
        function showAddClassModal() {
            document.getElementById('addClassModal').style.display = 'block';
            document.getElementById('newClassName').value = '';
            document.getElementById('newClassColumns').value = '6';
            document.getElementById('newClassRows').value = '5';
        }

        // ÈóúÈñâÊñ∞Â¢ûÁè≠Á¥öÊ®°ÊÖãÊ°Ü
        function closeAddClassModal() {
            document.getElementById('addClassModal').style.display = 'none';
        }

        // Âª∫Á´ãÊñ∞Áè≠Á¥ö
        function createNewClass() {
            const className = document.getElementById('newClassName').value.trim();
            const newColumns = parseInt(document.getElementById('newClassColumns').value);
            const newRows = parseInt(document.getElementById('newClassRows').value);
            
            if (!className) {
                alert('Ë´ãËº∏ÂÖ•Áè≠Á¥öÂêçÁ®±ÔºÅ');
                return;
            }
            
            // Ê™¢Êü•Áè≠Á¥öÂêçÁ®±ÊòØÂê¶ÈáçË§á
            const existingNames = Object.values(classesData).map(c => c.name);
            if (existingNames.includes(className)) {
                alert('Áè≠Á¥öÂêçÁ®±Â∑≤Â≠òÂú®ÔºåË´ã‰ΩøÁî®‰∏çÂêåÁöÑÂêçÁ®±ÔºÅ');
                return;
            }
            
            // ÁîüÊàêÊñ∞ÁöÑÁè≠Á¥öID
            let newClassId = 'class' + (Object.keys(classesData).length + 1);
            while (classesData[newClassId]) {
                newClassId = 'class' + (parseInt(newClassId.replace('class', '')) + 1);
            }
            
            // Âª∫Á´ãÊñ∞Áè≠Á¥öË≥áÊñô
            const newTotalSeats = newColumns * newRows;
            classesData[newClassId] = {
                name: className,
                columns: newColumns,
                rows: newRows,
                students: new Array(newTotalSeats).fill(null),
                studentScores: new Array(newTotalSeats).fill(0),
                studentLeaveStatus: new Array(newTotalSeats).fill(false),
                leaveHistory: []
            };
            
            // Êõ¥Êñ∞ÈÅ∏ÊìáÂô®
            updateClassSelector();
            
            // ÂàáÊèõÂà∞Êñ∞Áè≠Á¥ö
            currentClassId = newClassId;
            document.getElementById('classSelector').value = currentClassId;
            loadCurrentClassData();
            initializeSeating();
            
            closeAddClassModal();
            alert(`Áè≠Á¥ö„Äå${className}„ÄçÂª∫Á´ãÊàêÂäüÔºÅ\nÂ∫ß‰ΩçÈÖçÁΩÆÔºö${newColumns} Âàó √ó ${newRows} Ê¨Ñ (ÂÖ± ${newTotalSeats} ÂÄãÂ∫ß‰Ωç)`);
        }

        // È°ØÁ§∫ÁÆ°ÁêÜÁè≠Á¥öÊ®°ÊÖãÊ°Ü
        function showManageClassModal() {
            document.getElementById('manageClassModal').style.display = 'block';
            updateClassList();
        }

        // ÈóúÈñâÁÆ°ÁêÜÁè≠Á¥öÊ®°ÊÖãÊ°Ü
        function closeManageClassModal() {
            document.getElementById('manageClassModal').style.display = 'none';
        }

        // Êõ¥Êñ∞Áè≠Á¥öÂàóË°®
        function updateClassList() {
            const container = document.getElementById('classListContainer');
            container.innerHTML = '';
            
            Object.keys(classesData).forEach(classId => {
                const classData = classesData[classId];
                const studentCount = classData.students.filter(s => s !== null && s !== undefined && s.trim() !== '').length;
                const isCurrentClass = classId === currentClassId;
                
                const classItem = document.createElement('div');
                classItem.style.cssText = `
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 15px;
                    margin-bottom: 10px;
                    background: ${isCurrentClass ? '#e6f3ff' : '#f8fafc'};
                    border: 2px solid ${isCurrentClass ? '#667eea' : '#e2e8f0'};
                    border-radius: 10px;
                `;
                
                classItem.innerHTML = `
                    <div>
                        <div style="font-weight: bold; color: #2d3748; margin-bottom: 5px;">
                            ${classData.name} ${isCurrentClass ? '(ÁõÆÂâçÁè≠Á¥ö)' : ''}
                        </div>
                        <div style="font-size: 0.9rem; color: #718096;">
                            ${classData.columns} Âàó √ó ${classData.rows} Ê¨Ñ | ${studentCount} ‰ΩçÂ≠∏Áîü
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="renameClass('${classId}')" style="padding: 6px 12px; font-size: 0.8rem;">
                            ‚úèÔ∏è ÈáçÊñ∞ÂëΩÂêç
                        </button>
                        ${Object.keys(classesData).length > 1 ? `
                            <button class="btn" onclick="deleteClass('${classId}')" style="background: #f56565; color: white; padding: 6px 12px; font-size: 0.8rem; border: none;">
                                üóëÔ∏è Âà™Èô§
                            </button>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(classItem);
            });
        }

        // ÈáçÊñ∞ÂëΩÂêçÁè≠Á¥ö
        function renameClass(classId) {
            const classData = classesData[classId];
            const newName = prompt(`Ë´ãËº∏ÂÖ•Êñ∞ÁöÑÁè≠Á¥öÂêçÁ®±Ôºö`, classData.name);
            
            if (newName && newName.trim() && newName.trim() !== classData.name) {
                const trimmedName = newName.trim();
                
                // Ê™¢Êü•ÂêçÁ®±ÊòØÂê¶ÈáçË§á
                const existingNames = Object.values(classesData)
                    .filter(c => c !== classData)
                    .map(c => c.name);
                
                if (existingNames.includes(trimmedName)) {
                    alert('Áè≠Á¥öÂêçÁ®±Â∑≤Â≠òÂú®ÔºåË´ã‰ΩøÁî®‰∏çÂêåÁöÑÂêçÁ®±ÔºÅ');
                    return;
                }
                
                classData.name = trimmedName;
                updateClassSelector();
                updateClassList();
                alert(`Áè≠Á¥öÂêçÁ®±Â∑≤Êõ¥Êñ∞ÁÇ∫„Äå${trimmedName}„Äç`);
            }
        }

        // Âà™Èô§Áè≠Á¥ö
        function deleteClass(classId) {
            if (Object.keys(classesData).length <= 1) {
                alert('Ëá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏ÄÂÄãÁè≠Á¥öÔºÅ');
                return;
            }
            
            const classData = classesData[classId];
            const studentCount = classData.students.filter(s => s !== null).length;
            
            const confirmMessage = `Á¢∫ÂÆöË¶ÅÂà™Èô§Áè≠Á¥ö„Äå${classData.name}„ÄçÂóéÔºü\n\n‚Ä¢ Â∞áÊúÉÊ∞∏‰πÖÂà™Èô§ ${studentCount} ‰ΩçÂ≠∏ÁîüÁöÑË≥áÊñô\n‚Ä¢ Ê≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü\n\nË´ãËº∏ÂÖ•Áè≠Á¥öÂêçÁ®±‰ª•Á¢∫Ë™çÂà™Èô§Ôºö`;
            
            const confirmation = prompt(confirmMessage);
            if (confirmation === classData.name) {
                delete classesData[classId];
                
                // Â¶ÇÊûúÂà™Èô§ÁöÑÊòØÁõÆÂâçÁè≠Á¥öÔºåÂàáÊèõÂà∞Á¨¨‰∏ÄÂÄãÂèØÁî®Áè≠Á¥ö
                if (classId === currentClassId) {
                    currentClassId = Object.keys(classesData)[0];
                    loadCurrentClassData();
                    initializeSeating();
                }
                
                updateClassSelector();
                updateClassList();
                alert(`Áè≠Á¥ö„Äå${classData.name}„ÄçÂ∑≤Âà™Èô§`);
            } else if (confirmation !== null) {
                alert('Áè≠Á¥öÂêçÁ®±‰∏çÊ≠£Á¢∫ÔºåÂà™Èô§Êìç‰ΩúÂ∑≤ÂèñÊ∂à');
            }
        }

        // ÂàùÂßãÂåñÂ∫ß‰ΩçË°®
        function initializeSeating() {
            const grid = document.getElementById('seatingGrid');
            grid.innerHTML = '';
            
            // Êõ¥Êñ∞Á∂≤Ê†ºÊ®£Âºè
            grid.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
            
            for (let i = 0; i < totalSeats; i++) {
                const seat = document.createElement('div');
                seat.className = 'seat';
                seat.onclick = () => editSeat(i);
                seat.dataset.seatIndex = i;
                
                // Ë®≠ÂÆöÊãñÊãâÂäüËÉΩ
                seat.draggable = true;
                seat.addEventListener('dragstart', handleDragStart);
                seat.addEventListener('dragover', handleDragOver);
                seat.addEventListener('drop', handleDrop);
                seat.addEventListener('dragend', handleDragEnd);
                seat.addEventListener('dragenter', handleDragEnter);
                seat.addEventListener('dragleave', handleDragLeave);
                
                const seatNumber = document.createElement('div');
                seatNumber.className = 'seat-number';
                seatNumber.textContent = `Â∫ß‰Ωç ${i + 1}`;
                
                const studentName = document.createElement('div');
                studentName.className = 'student-name';
                
                if (students[i]) {
                    if (studentLeaveStatus[i]) {
                        seat.classList.add('on-leave');
                    } else {
                        seat.classList.add('occupied');
                    }
                    studentName.textContent = students[i];
                    
                    // Êñ∞Â¢ûÊãñÊãâÊåáÁ§∫Âô®
                    const dragIndicator = document.createElement('div');
                    dragIndicator.className = 'drag-indicator';
                    dragIndicator.innerHTML = '‚ãÆ‚ãÆ';
                    dragIndicator.title = 'ÊãñÊãâÁßªÂãïÂ≠∏Áîü';
                    seat.appendChild(dragIndicator);
                    

                    
                    // Êñ∞Â¢ûÂàÜÊï∏ÊéßÂà∂ÂçÄÂüü
                    const scoreContainer = document.createElement('div');
                    scoreContainer.className = 'student-score';
                    
                    const minusBtn = document.createElement('button');
                    minusBtn.className = 'score-btn minus';
                    minusBtn.innerHTML = '‚àí';
                    
                    // Â¶ÇÊûúÂ≠∏ÁîüË´ãÂÅáÔºåÁ¶ÅÁî®ÊåâÈàï
                    if (studentLeaveStatus[i]) {
                        minusBtn.disabled = true;
                        minusBtn.style.opacity = '0.3';
                        minusBtn.style.cursor = 'not-allowed';
                        minusBtn.title = 'Ë´ãÂÅáÂ≠∏ÁîüÁÑ°Ê≥ïË™øÊï¥ÂàÜÊï∏';
                    } else {
                        minusBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            changeScore(i, -1);
                        });
                    }
                    
                    const scoreDisplay = document.createElement('div');
                    const score = studentScores[i] || 0;
                    scoreDisplay.className = score < 0 ? 'score-display negative' : 'score-display';
                    scoreDisplay.textContent = score;
                    scoreDisplay.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                    });
                    
                    const plusBtn = document.createElement('button');
                    plusBtn.className = 'score-btn plus';
                    plusBtn.innerHTML = '+';
                    
                    // Â¶ÇÊûúÂ≠∏ÁîüË´ãÂÅáÔºåÁ¶ÅÁî®ÊåâÈàï
                    if (studentLeaveStatus[i]) {
                        plusBtn.disabled = true;
                        plusBtn.style.opacity = '0.3';
                        plusBtn.style.cursor = 'not-allowed';
                        plusBtn.title = 'Ë´ãÂÅáÂ≠∏ÁîüÁÑ°Ê≥ïË™øÊï¥ÂàÜÊï∏';
                    } else {
                        plusBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            changeScore(i, 1);
                        });
                    }
                    
                    scoreContainer.appendChild(minusBtn);
                    scoreContainer.appendChild(scoreDisplay);
                    scoreContainer.appendChild(plusBtn);
                    
                    seat.appendChild(seatNumber);
                    seat.appendChild(studentName);
                    seat.appendChild(scoreContainer);
                } else {
                    studentName.className += ' empty-seat';
                    studentName.textContent = 'ÈªûÊìäÁ∑®ËºØ';
                    seat.appendChild(seatNumber);
                    seat.appendChild(studentName);
                }
                
                grid.appendChild(seat);
            }
            
            updateStats();
        }

        // Á∑®ËºØÂ∫ß‰Ωç
        function editSeat(index) {
            currentSeatIndex = index;
            const modal = document.getElementById('editModal');
            const input = document.getElementById('studentNameInput');
            
            input.value = students[index] || '';
            modal.style.display = 'block';
            input.focus();
        }

        // ÂÑ≤Â≠òÂ≠∏ÁîüË≥áË®ä
        function saveStudent() {
            const input = document.getElementById('studentNameInput');
            const name = input.value.trim();
            
            if (name) {
                students[currentSeatIndex] = name;
                // Â¶ÇÊûúÊòØÊñ∞Â≠∏ÁîüÔºåÂàùÂßãÂåñÂàÜÊï∏ÁÇ∫0
                if (studentScores[currentSeatIndex] === undefined) {
                    studentScores[currentSeatIndex] = 0;
                }
            } else {
                students[currentSeatIndex] = null;
                studentScores[currentSeatIndex] = 0;
            }
            
            // ÂÑ≤Â≠òÂà∞Áè≠Á¥öË≥áÊñô
            saveCurrentClassData();
            
            closeModal();
            initializeSeating();
        }

        // ËÆäÊõ¥Â≠∏ÁîüÂàÜÊï∏
        function changeScore(seatIndex, change) {
            if (students[seatIndex]) {
                studentScores[seatIndex] = (studentScores[seatIndex] || 0) + change;
                // Êõ¥Êñ∞È°ØÁ§∫
                const seat = document.querySelector(`[data-seat-index="${seatIndex}"]`);
                const scoreDisplay = seat.querySelector('.score-display');
                if (scoreDisplay) {
                    const score = studentScores[seatIndex];
                    scoreDisplay.textContent = score;
                    scoreDisplay.className = score < 0 ? 'score-display negative' : 'score-display';
                }
                // ÂÑ≤Â≠òÂà∞Áè≠Á¥öË≥áÊñô
                saveCurrentClassData();
            }
        }



        // ÈóúÈñâÊ®°ÊÖãÊ°Ü
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            currentSeatIndex = null;
        }

        // Èö®Ê©üÊéíÂ∫ß‰Ωç
        function randomizeSeats() {
            console.log('randomizeSeats ÂáΩÊï∏Ë¢´ÂëºÂè´');
            
            const occupiedStudents = students.filter(student => student !== null);
            console.log('ÁèæÊúâÂ≠∏Áîü:', occupiedStudents);
            
            if (occupiedStudents.length === 0) {
                alert('Ë´ãÂÖàÊñ∞Â¢û‰∏Ä‰∫õÂ≠∏ÁîüÂÜçÈÄ≤Ë°åÈö®Ê©üÊéíÂ∫ß‰ΩçÔºÅ');
                return;
            }
            
            // È°ØÁ§∫Á¢∫Ë™çË≠¶Á§∫Ë¶ñÁ™ó
            const confirmMessage = `Á¢∫ÂÆöË¶ÅÈáçÊñ∞Èö®Ê©üÊéíÂàóÊâÄÊúâÂ≠∏ÁîüÁöÑÂ∫ß‰ΩçÂóéÔºü\n\n‚Ä¢ ÁõÆÂâçÊúâ ${occupiedStudents.length} ‰ΩçÂ≠∏Áîü\n‚Ä¢ Â∞áÊúÉÂÆåÂÖ®Êâì‰∫ÇÁèæÊúâÁöÑÂ∫ß‰ΩçÂÆâÊéí\n‚Ä¢ Ê≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü\n\nÈªûÊìä„ÄåÁ¢∫ÂÆö„ÄçÁπºÁ∫åÈö®Ê©üÊéíÂ∫ß‰Ωç`;
            
            if (!confirm(confirmMessage)) {
                console.log('Áî®Êà∂ÂèñÊ∂àÈö®Ê©üÊéíÂ∫ß‰Ωç');
                return;
            }
            
            console.log('ÈñãÂßãÈö®Ê©üÊéíÂ∫ß‰Ωç...');
            
            // ‰øùÂ≠òÁèæÊúâÂ≠∏ÁîüÁöÑÂàÜÊï∏
            const studentScoreMap = {};
            for (let i = 0; i < totalSeats; i++) {
                if (students[i]) {
                    studentScoreMap[students[i]] = studentScores[i] || 0;
                }
            }
            console.log('Â≠∏ÁîüÂàÜÊï∏Â∞çÊáâ:', studentScoreMap);
            
            // Ê∏ÖÁ©∫ÊâÄÊúâÂ∫ß‰Ωç
            students.fill(null);
            studentScores.fill(0);
            
            // ‰ΩøÁî® Fisher-Yates Ê¥óÁâåÁÆóÊ≥ï‰æÜÁ¢∫‰øùÁúüÊ≠£ÁöÑÈö®Ê©ü
            function shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
            
            // Èö®Ê©üÂàÜÈÖçÂ∫ß‰Ωç
            const shuffledStudents = shuffleArray(occupiedStudents);
            const availableSeats = shuffleArray(Array.from({length: totalSeats}, (_, i) => i));
            
            console.log('Èö®Ê©üÂæåÁöÑÂ≠∏ÁîüÈ†ÜÂ∫è:', shuffledStudents);
            console.log('Èö®Ê©üÂæåÁöÑÂ∫ß‰ΩçÈ†ÜÂ∫è:', availableSeats.slice(0, shuffledStudents.length));
            
            shuffledStudents.forEach((student, index) => {
                const seatIndex = availableSeats[index];
                students[seatIndex] = student;
                studentScores[seatIndex] = studentScoreMap[student] || 0;
            });
            
            console.log('ÈáçÊñ∞ÂàÜÈÖçÂæåÁöÑÂ∫ß‰Ωç:', students);
            
            // ÈáçÊñ∞ÂàùÂßãÂåñÂ∫ß‰ΩçË°®
            initializeSeating();
            
            // È°ØÁ§∫ÂÆåÊàêË®äÊÅØ
            alert(`Èö®Ê©üÊéíÂ∫ß‰ΩçÂÆåÊàêÔºÅ\nÂ∑≤ÈáçÊñ∞ÂÆâÊéí ${occupiedStudents.length} ‰ΩçÂ≠∏ÁîüÁöÑÂ∫ß‰Ωç„ÄÇ`);
            console.log('Èö®Ê©üÊéíÂ∫ß‰ΩçÂÆåÊàê');
        }

        // Ê∏ÖÁ©∫ÊâÄÊúâÂ∫ß‰Ωç
        function clearAllSeats() {
            if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂ∫ß‰ΩçÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) {
                students = new Array(totalSeats).fill(null);
                studentScores = new Array(totalSeats).fill(0);
                initializeSeating();
            }
        }

        // ÂåØÂá∫ExcelÊ™îÊ°à
        function exportToExcel() {
            try {
                // ÂÑ≤Â≠òÁõÆÂâçÁè≠Á¥öË≥áÊñô
                saveCurrentClassData();
                
                // Ê∫ñÂÇôExcelË≥áÊñô
                const worksheetData = [];
                
                // Ê®ôÈ°åË°å
                worksheetData.push(['ÊâÄÊúâÁè≠Á¥öÂ∫ß‰ΩçË°®Ë≥áÊñô', '', '', '', '', '', '']);
                worksheetData.push(['ÂåØÂá∫ÊôÇÈñì:', new Date().toLocaleString(), '', '', '', '', '']);
                worksheetData.push(['Áè≠Á¥öÊï∏Èáè:', Object.keys(classesData).length + ' ÂÄãÁè≠Á¥ö', '', '', '', '', '']);
                worksheetData.push(['']); // Á©∫Ë°å
                
                let totalStudentsAllClasses = 0;
                let totalSeatsAllClasses = 0;
                
                // ÈÅçÊ≠∑ÊâÄÊúâÁè≠Á¥ö
                Object.keys(classesData).forEach((classId, classIndex) => {
                    const classData = classesData[classId];
                    const classStudents = classData.students;
                    const classScores = classData.studentScores;
                    const classColumns = classData.columns;
                    const classRows = classData.rows;
                    const classTotalSeats = classColumns * classRows;
                    const classOccupiedCount = classStudents.filter(s => s !== null).length;
                    
                    totalStudentsAllClasses += classOccupiedCount;
                    totalSeatsAllClasses += classTotalSeats;
                    
                    // Áè≠Á¥öÊ®ôÈ°å
                    worksheetData.push([`„Äê${classData.name}„Äë`, '', '', '', '', '', '']);
                    worksheetData.push(['Â∫ß‰ΩçÈÖçÁΩÆ:', `${classColumns} Âàó √ó ${classRows} Ê¨Ñ (ÂÖ± ${classTotalSeats} ÂÄãÂ∫ß‰Ωç)`, '', '', '', '', '']);
                    worksheetData.push(['Â≠∏Áîü‰∫∫Êï∏:', `${classOccupiedCount} ‰Ωç`, '', '', '', '', '']);
                    worksheetData.push(['']); // Á©∫Ë°å
                    
                    // Ë°®È†≠
                    worksheetData.push(['Â∫ß‰ΩçÁ∑®Ëôü', 'Â≠∏ÁîüÂßìÂêç', 'ÂàÜÊï∏', 'Âàó', 'Ê¨Ñ', 'ÁãÄÊÖã', 'Áè≠Á¥ö']);
                    
                    // Â≠∏ÁîüË≥áÊñô
                    for (let i = 0; i < classTotalSeats; i++) {
                        const row = Math.floor(i / classColumns) + 1; // Á¨¨ÂπæÊ¨Ñ
                        const col = (i % classColumns) + 1; // Á¨¨ÂπæÂàó
                        
                        worksheetData.push([
                            i + 1, // Â∫ß‰ΩçÁ∑®Ëôü
                            classStudents[i] || 'Á©∫Â∫ß‰Ωç', // Â≠∏ÁîüÂßìÂêç
                            classStudents[i] ? (classScores[i] || 0) : '', // ÂàÜÊï∏
                            col, // Âàó
                            row, // Ê¨Ñ
                            classStudents[i] ? 'Â∑≤ÂÆâÊéí' : 'Á©∫Â∫ß‰Ωç', // ÁãÄÊÖã
                            classData.name // Áè≠Á¥ö
                        ]);
                    }
                    
                    // Áè≠Á¥öÁµ±Ë®à
                    const classEmptyCount = classTotalSeats - classOccupiedCount;
                    worksheetData.push(['']); // Á©∫Ë°å
                    worksheetData.push(['Áè≠Á¥öÁµ±Ë®à', '', '', '', '', '', '']);
                    worksheetData.push(['Â∑≤ÂÆâÊéíÂ∫ß‰Ωç:', classOccupiedCount, '', '', '', '', '']);
                    worksheetData.push(['Á©∫Â∫ß‰Ωç:', classEmptyCount, '', '', '', '', '']);
                    worksheetData.push(['Á∏ΩÂ∫ß‰ΩçÊï∏:', classTotalSeats, '', '', '', '', '']);
                    
                    // Â¶ÇÊûú‰∏çÊòØÊúÄÂæå‰∏ÄÂÄãÁè≠Á¥öÔºåÊ∑ªÂä†ÂàÜÈöîÁ∑ö
                    if (classIndex < Object.keys(classesData).length - 1) {
                        worksheetData.push(['']); // Á©∫Ë°å
                        worksheetData.push(['='.repeat(50), '', '', '', '', '', '']); // ÂàÜÈöîÁ∑ö
                        worksheetData.push(['']); // Á©∫Ë°å
                    }
                });
                
                // Á∏ΩÁµ±Ë®àË≥áÊñô
                const totalEmptySeats = totalSeatsAllClasses - totalStudentsAllClasses;
                worksheetData.push(['']); // Á©∫Ë°å
                worksheetData.push(['='.repeat(50), '', '', '', '', '', '']); // ÂàÜÈöîÁ∑ö
                worksheetData.push(['Á∏ΩÁµ±Ë®àË≥áÊñô', '', '', '', '', '', '']);
                worksheetData.push(['Á∏ΩÁè≠Á¥öÊï∏:', Object.keys(classesData).length, '', '', '', '', '']);
                worksheetData.push(['Á∏ΩÂ≠∏Áîü‰∫∫Êï∏:', totalStudentsAllClasses, '', '', '', '', '']);
                worksheetData.push(['Á∏ΩÂ∫ß‰ΩçÊï∏:', totalSeatsAllClasses, '', '', '', '', '']);
                worksheetData.push(['Á∏ΩÁ©∫Â∫ß‰Ωç:', totalEmptySeats, '', '', '', '', '']);
                
                // ËΩâÊèõÁÇ∫CSVÊ†ºÂºè
                const csvContent = worksheetData.map(row => 
                    row.map(cell => {
                        // ËôïÁêÜÂåÖÂê´ÈÄóËôüÊàñÂºïËôüÁöÑÂÖßÂÆπ
                        const cellStr = String(cell || '');
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            return '"' + cellStr.replace(/"/g, '""') + '"';
                        }
                        return cellStr;
                    }).join(',')
                ).join('\n');
                
                // Ê∑ªÂä†BOM‰ª•ÊîØÊè¥‰∏≠Êñá
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csvContent;
                
                // ÂâµÂª∫‰∏ãËºâÈÄ£Áµê
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                // ÂâµÂª∫Èö±ËóèÁöÑ‰∏ãËºâÈÄ£Áµê
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = `ÊâÄÊúâÁè≠Á¥öÂ∫ß‰ΩçË°®_${new Date().toISOString().split('T')[0]}.csv`;
                downloadLink.style.display = 'none';
                
                // Ê∑ªÂä†Âà∞È†ÅÈù¢‰∏¶Ëß∏Áôº‰∏ãËºâ
                document.body.appendChild(downloadLink);
                downloadLink.click();
                
                // Ê∏ÖÁêÜ
                setTimeout(() => {
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
                setTimeout(() => {
                    alert(`ÊâÄÊúâÁè≠Á¥öExcelÊ™îÊ°àÂ∑≤ÊàêÂäüÂåØÂá∫ÔºÅ\n\n‚Ä¢ Ê™îÊ°àÊ†ºÂºèÔºöCSV (ÂèØÁî®ExcelÈñãÂïü)\n‚Ä¢ Áè≠Á¥öÊï∏ÈáèÔºö${Object.keys(classesData).length} ÂÄãÁè≠Á¥ö\n‚Ä¢ Á∏ΩÂ≠∏Áîü‰∫∫Êï∏Ôºö${totalStudentsAllClasses} ‰Ωç\n‚Ä¢ Á∏ΩÂ∫ß‰ΩçÊï∏Ôºö${totalSeatsAllClasses} ÂÄã\n‚Ä¢ Ê™îÊ°àÂêçÁ®±ÔºöÊâÄÊúâÁè≠Á¥öÂ∫ß‰ΩçË°®_${new Date().toISOString().split('T')[0]}.csv\n\nüìã ÂåÖÂê´Áè≠Á¥öÔºö\n${Object.values(classesData).map(c => `‚Ä¢ ${c.name}`).join('\n')}\n\nüí° ÊèêÁ§∫ÔºöÁî®ExcelÈñãÂïüCSVÊ™îÊ°àÊôÇÔºåË´ãÁ¢∫‰øùÁ∑®Á¢ºË®≠ÂÆöÁÇ∫UTF-8‰ª•Ê≠£Á¢∫È°ØÁ§∫‰∏≠Êñá„ÄÇ`);
                }, 200);
                
            } catch (error) {
                console.error('ExcelÂåØÂá∫Â§±Êïó:', error);
                alert('ExcelÂåØÂá∫Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ\nÈåØË™§Ë©≥ÊÉÖÔºö' + error.message);
            }
        }

        // ÂåØÂá∫Ë≥áÊñô
        function exportData() {
            try {
                // ÂÑ≤Â≠òÁõÆÂâçÁè≠Á¥öË≥áÊñô
                saveCurrentClassData();
                
                // Ë®àÁÆóÊâÄÊúâÁè≠Á¥öÁöÑÁµ±Ë®àË≥áÊñô
                let totalStudents = 0;
                let totalClasses = Object.keys(classesData).length;
                
                Object.values(classesData).forEach(classData => {
                    totalStudents += classData.students.filter(s => s !== null).length;
                });
                
                // Ê∫ñÂÇôÂåØÂá∫ÁöÑË≥áÊñôÔºàÂåÖÂê´ÊâÄÊúâÁè≠Á¥öÔºâ
                const exportData = {
                    version: '2.0', // ÁâàÊú¨ÂçáÁ¥ö‰ª•ÊîØÊè¥Â§öÁè≠Á¥ö
                    timestamp: new Date().toISOString(),
                    currentClassId: currentClassId,
                    classesData: classesData,
                    // ÁÇ∫‰∫ÜÂêëÂæåÁõ∏ÂÆπÔºå‰øùÁïôËàäÊ†ºÂºèÔºàÁõÆÂâçÁè≠Á¥öÁöÑË≥áÊñôÔºâ
                    seatingConfig: {
                        columns: columns,
                        rows: rows,
                        totalSeats: totalSeats
                    },
                    students: students,
                    studentScores: studentScores
                };
                
                // ËΩâÊèõÁÇ∫ JSON Â≠ó‰∏≤
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // ÂâµÂª∫‰∏ãËºâÈÄ£Áµê
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                // ÂâµÂª∫Èö±ËóèÁöÑ‰∏ãËºâÈÄ£Áµê
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = `ÊâÄÊúâÁè≠Á¥öÂ∫ß‰ΩçË≥áÊñô_${new Date().toISOString().split('T')[0]}.json`;
                downloadLink.style.display = 'none';
                
                // Ê∑ªÂä†Âà∞È†ÅÈù¢‰∏¶Ëß∏Áôº‰∏ãËºâ
                document.body.appendChild(downloadLink);
                downloadLink.click();
                
                // Ê∏ÖÁêÜ
                setTimeout(() => {
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
                setTimeout(() => {
                    alert(`ÊâÄÊúâÁè≠Á¥öË≥áÊñôÂ∑≤ÊàêÂäüÂåØÂá∫ÔºÅ\n\n‚Ä¢ Ê™îÊ°àÊ†ºÂºèÔºöJSON\n‚Ä¢ Áè≠Á¥öÊï∏ÈáèÔºö${totalClasses} ÂÄãÁè≠Á¥ö\n‚Ä¢ Á∏ΩÂ≠∏Áîü‰∫∫Êï∏Ôºö${totalStudents} ‰Ωç\n‚Ä¢ Ê™îÊ°àÂêçÁ®±ÔºöÊâÄÊúâÁè≠Á¥öÂ∫ß‰ΩçË≥áÊñô_${new Date().toISOString().split('T')[0]}.json\n\nüìã ÂåÖÂê´Áè≠Á¥öÔºö\n${Object.values(classesData).map(c => `‚Ä¢ ${c.name}`).join('\n')}`);
                }, 200);
                
            } catch (error) {
                console.error('ÂåØÂá∫Â§±Êïó:', error);
                
                // ÂÇôÁî®ÊñπÊ°àÔºöÈ°ØÁ§∫Ë≥áÊñôËÆìÁî®Êà∂ÊâãÂãïË§áË£Ω
                const exportData = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    currentClassId: currentClassId,
                    classesData: classesData
                };
                
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // È°ØÁ§∫Ë§áË£ΩÂ∞çË©±Ê°Ü
                showExportFallback(jsonString);
            }
        }

        // ÂÇôÁî®ÂåØÂá∫ÊñπÊ°à
        function showExportFallback(jsonString) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <h3 class="modal-title">üíæ ÂåØÂá∫Â∫ß‰ΩçË≥áÊñô</h3>
                    <p style="color: #718096; margin-bottom: 15px;">Ë´ãË§áË£Ω‰ª•‰∏ãÂÖßÂÆπ‰∏¶ÂÑ≤Â≠òÁÇ∫ .json Ê™îÊ°àÔºö</p>
                    <textarea id="exportTextarea" style="width: 100%; height: 300px; font-family: monospace; font-size: 12px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; resize: vertical;">${jsonString}</textarea>
                    <div style="margin: 15px 0; padding: 10px; background: #f0f8ff; border-radius: 8px; font-size: 0.9rem; color: #2c5282;">
                        üí° <strong>‰ΩøÁî®Ë™™ÊòéÔºö</strong><br>
                        1. ÈªûÊìä„ÄåË§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø„ÄçÊåâÈàï<br>
                        2. ÈñãÂïüÊñáÂ≠óÁ∑®ËºØÂô®ÔºàÂ¶ÇË®ò‰∫ãÊú¨Ôºâ<br>
                        3. Ë≤º‰∏äÂÖßÂÆπ‰∏¶ÂÑ≤Â≠òÁÇ∫ .json Ê™îÊ°à
                    </div>
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" onclick="document.body.removeChild(this.closest('.modal'))">ÈóúÈñâ</button>
                        <button class="btn btn-primary" onclick="copyExportData()">üìã Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Ëá™ÂãïÈÅ∏‰∏≠ÊñáÂ≠ó
            const textarea = modal.querySelector('#exportTextarea');
            textarea.select();
        }

        // Ë§áË£ΩÂåØÂá∫Ë≥áÊñôÂà∞Ââ™Ë≤ºÁ∞ø
        function copyExportData() {
            const textarea = document.getElementById('exportTextarea');
            textarea.select();
            
            try {
                document.execCommand('copy');
                alert('Ë≥áÊñôÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºÅË´ãË≤ºÂà∞ÊñáÂ≠óÁ∑®ËºØÂô®‰∏≠ÂÑ≤Â≠òÁÇ∫ .json Ê™îÊ°à„ÄÇ');
            } catch (error) {
                alert('Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïÈÅ∏Âèñ‰∏¶Ë§áË£ΩÊñáÂ≠óÂçÄÂüüÁöÑÂÖßÂÆπ„ÄÇ');
            }
        }

        // Êõ¥Êñ∞Áµ±Ë®àË≥áË®ä
        function updateStats() {
            const occupied = students.filter(student => student !== null && student !== undefined && student.trim() !== '').length;
            const empty = totalSeats - occupied;
            
            document.getElementById('occupiedCount').textContent = occupied;
            document.getElementById('emptyCount').textContent = empty;
            document.getElementById('totalSeatsCount').textContent = totalSeats;
            
            // ÂêåÊôÇÊõ¥Êñ∞Áè≠Á¥öÁµ±Ë®à
            updateClassStats();
        }

        // È°ØÁ§∫ÂåØÂÖ•Ê®°ÊÖãÊ°Ü
        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
            switchImportMode('text'); // È†êË®≠ÁÇ∫ÊâãÂãïËº∏ÂÖ•Ê®°Âºè
        }

        // ÈóúÈñâÂåØÂÖ•Ê®°ÊÖãÊ°Ü
        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('studentListInput').value = '';
            document.getElementById('fileInput').value = '';
        }

        // ÂàáÊèõÂåØÂÖ•Ê®°Âºè
        function switchImportMode(mode) {
            const textMode = document.getElementById('textInputMode');
            const fileMode = document.getElementById('fileInputMode');
            const textBtn = document.getElementById('textInputBtn');
            const fileBtn = document.getElementById('fileInputBtn');

            if (mode === 'text') {
                textMode.style.display = 'block';
                fileMode.style.display = 'none';
                textBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                textBtn.style.color = 'white';
                fileBtn.style.background = '#f7fafc';
                fileBtn.style.color = '#4a5568';
            } else {
                textMode.style.display = 'none';
                fileMode.style.display = 'block';
                fileBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                fileBtn.style.color = 'white';
                textBtn.style.background = '#f7fafc';
                textBtn.style.color = '#4a5568';
            }
        }

        // ÂåØÂÖ•Â≠∏ÁîüÂêçÂñÆ
        function importStudents() {
            const textMode = document.getElementById('textInputMode').style.display !== 'none';
            let studentNames = [];

            if (textMode) {
                // ÊâãÂãïËº∏ÂÖ•Ê®°Âºè
                const input = document.getElementById('studentListInput').value.trim();
                if (!input) {
                    alert('Ë´ãËº∏ÂÖ•Â≠∏ÁîüÂßìÂêçÔºÅ');
                    return;
                }
                studentNames = input.split('\n')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);
            } else {
                // Ê™îÊ°à‰∏äÂÇ≥Ê®°Âºè
                const fileInput = document.getElementById('fileInput');
                if (!fileInput.files[0]) {
                    alert('Ë´ãÈÅ∏Êìá‰∏ÄÂÄãÊñáÂ≠óÊ™îÊ°àÔºÅ');
                    return;
                }

                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const content = e.target.result;
                    studentNames = content.split('\n')
                        .map(name => name.trim())
                        .filter(name => name.length > 0);
                    
                    processImportedStudents(studentNames);
                };
                
                reader.readAsText(file, 'UTF-8');
                return; // Á≠âÂæÖÊ™îÊ°àËÆÄÂèñÂÆåÊàê
            }

            processImportedStudents(studentNames);
        }

        // ËôïÁêÜÂåØÂÖ•ÁöÑÂ≠∏ÁîüÂêçÂñÆ
        function processImportedStudents(studentNames) {
            if (studentNames.length === 0) {
                alert('Ê≤íÊúâÊâæÂà∞ÊúâÊïàÁöÑÂ≠∏ÁîüÂßìÂêçÔºÅ');
                return;
            }

            if (studentNames.length > totalSeats) {
                alert(`Â≠∏Áîü‰∫∫Êï∏Ë∂ÖÈÅéÂ∫ß‰ΩçÊï∏ÈáèÔºÅÂ∞áÂè™ÂåØÂÖ•Ââç ${totalSeats} ‰ΩçÂ≠∏Áîü„ÄÇ\nÔºàÂÖ± ${studentNames.length} ‰ΩçÂ≠∏ÁîüÔºâ`);
                studentNames = studentNames.slice(0, totalSeats);
            }

            // Ê∏ÖÁ©∫ÁèæÊúâÂ∫ß‰ΩçÂíåÂàÜÊï∏
            students = new Array(totalSeats).fill(null);
            studentScores = new Array(totalSeats).fill(0);

            // ÊåâÈ†ÜÂ∫èÂàÜÈÖçÂ∫ß‰ΩçÔºàÂæûÂ∫ß‰Ωç1ÈñãÂßãÔºâ
            studentNames.forEach((name, index) => {
                students[index] = name;
                studentScores[index] = 0; // ÂàùÂßãÂåñÂàÜÊï∏ÁÇ∫0
            });

            // ÂÑ≤Â≠òÂà∞Áè≠Á¥öË≥áÊñô
            saveCurrentClassData();

            closeImportModal();
            initializeSeating();
            
            alert(`ÊàêÂäüÂåØÂÖ• ${studentNames.length} ‰ΩçÂ≠∏Áîü‰∏¶ÊåâÈ†ÜÂ∫èÂàÜÈÖçÂ∫ß‰ΩçÔºÅ`);
        }

        // È°ØÁ§∫Â∫ß‰ΩçÈÖçÁΩÆÊ®°ÊÖãÊ°Ü
        function showLayoutModal() {
            document.getElementById('layoutModal').style.display = 'block';
            document.getElementById('columnsSlider').value = columns;
            document.getElementById('rowsSlider').value = rows;
            updateLayoutPreview();
        }

        // ÈóúÈñâÂ∫ß‰ΩçÈÖçÁΩÆÊ®°ÊÖãÊ°Ü
        function closeLayoutModal() {
            document.getElementById('layoutModal').style.display = 'none';
        }

        // Êõ¥Êñ∞ÈÖçÁΩÆÈ†êË¶Ω
        function updateLayoutPreview() {
            const newColumns = parseInt(document.getElementById('columnsSlider').value);
            const newRows = parseInt(document.getElementById('rowsSlider').value);
            const newTotalSeats = newColumns * newRows;
            const currentStudents = students.filter(s => s !== null).length;

            document.getElementById('columnsValue').textContent = newColumns;
            document.getElementById('rowsValue').textContent = newRows;
            document.getElementById('totalSeatsPreview').textContent = newTotalSeats;
            document.getElementById('layoutPreview').textContent = `${newColumns} Âàó √ó ${newRows} Ê¨Ñ`;
            document.getElementById('currentStudentsCount').textContent = currentStudents;
            document.getElementById('maxStudentsText').textContent = newTotalSeats;

            // È°ØÁ§∫Ë≠¶Âëä
            const warning = document.getElementById('layoutWarning');
            if (newTotalSeats < currentStudents) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }

        // Â•óÁî®ÈÖçÁΩÆËÆäÊõ¥
        function applyLayoutChanges() {
            const newColumns = parseInt(document.getElementById('columnsSlider').value);
            const newRows = parseInt(document.getElementById('rowsSlider').value);
            const newTotalSeats = newColumns * newRows;
            
            // Êî∂ÈõÜÁèæÊúâÂ≠∏ÁîüË≥áÊñôÔºàÊåâÂ∫ß‰ΩçÈ†ÜÂ∫èÔºâ
            const currentStudentData = [];
            for (let i = 0; i < totalSeats; i++) {
                if (students[i]) {
                    currentStudentData.push({
                        name: students[i],
                        score: studentScores[i] || 0,
                        originalSeat: i + 1
                    });
                }
            }

            let removedStudents = [];
            if (newTotalSeats < currentStudentData.length) {
                // Ë®àÁÆóË¶ÅÂà™Èô§ÁöÑÂ≠∏ÁîüÔºàÂæûÊúÄÂæåÈù¢ÈñãÂßãÂà™Èô§Ôºâ
                removedStudents = currentStudentData.slice(newTotalSeats);
                const removedNames = removedStudents.map(s => `${s.name} (ÂéüÂ∫ß‰Ωç${s.originalSeat})`).join('„ÄÅ');
                
                if (!confirm(`Êñ∞ÈÖçÁΩÆÂè™Êúâ ${newTotalSeats} ÂÄãÂ∫ß‰ΩçÔºå‰ΩÜÁõÆÂâçÊúâ ${currentStudentData.length} ‰ΩçÂ≠∏Áîü„ÄÇ\n\nÂ∞áÂà™Èô§‰ª•‰∏ãÂ≠∏ÁîüÔºö\n${removedNames}\n\nÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü`)) {
                    return;
                }
            }

            // Êõ¥Êñ∞ÈÖçÁΩÆ
            columns = newColumns;
            rows = newRows;
            totalSeats = newTotalSeats;

            // ÈáçÊñ∞ÂàÜÈÖçÂ≠∏ÁîüÔºàÊåâÈ†ÜÂ∫èÊéíÂàóÔºåÂè™‰øùÁïôÂâçÈù¢ÁöÑÂ≠∏ÁîüÔºâ
            const newStudents = new Array(totalSeats).fill(null);
            const newStudentScores = new Array(totalSeats).fill(0);
            const studentsToKeep = currentStudentData.slice(0, newTotalSeats);
            
            // ÊåâÈ†ÜÂ∫èÂàÜÈÖçÂ≠∏ÁîüÂà∞Êñ∞Â∫ß‰ΩçÔºàÂæûÂ∫ß‰Ωç1ÈñãÂßãÔºâ
            studentsToKeep.forEach((studentData, index) => {
                newStudents[index] = studentData.name;
                newStudentScores[index] = studentData.score;
            });

            students = newStudents;
            studentScores = newStudentScores;
            
            // ÂÑ≤Â≠òÂà∞Áè≠Á¥öË≥áÊñô
            saveCurrentClassData();
            
            closeLayoutModal();
            initializeSeating();

            let message = `Â∫ß‰ΩçÈÖçÁΩÆÂ∑≤Êõ¥Êñ∞ÁÇ∫ ${columns} Âàó √ó ${rows} Ê¨Ñ (ÂÖ± ${totalSeats} ÂÄãÂ∫ß‰Ωç)\nÂ≠∏ÁîüÂ∑≤ÊåâÂéüÈ†ÜÂ∫èÈáçÊñ∞ÊéíÂàó`;
            if (removedStudents.length > 0) {
                message += `\n\nÂ∑≤Âà™Èô§ ${removedStudents.length} ‰ΩçÂ≠∏ÁîüÔºö\n${removedStudents.map(s => s.name).join('„ÄÅ')}`;
            }
            
            alert(message);
        }

        // È°ØÁ§∫ÂåØÂÖ•Ë≥áÊñôÊ®°ÊÖãÊ°Ü
        function showImportDataModal() {
            document.getElementById('importDataModal').style.display = 'block';
            document.getElementById('dataFileInput').value = '';
            
            // Ê™¢Êü•ÊòØÂê¶Êúâ‰ªª‰ΩïÁè≠Á¥öÊúâË≥áÊñôÔºåÈ°ØÁ§∫Ë≠¶Âëä
            let hasData = false;
            Object.values(classesData).forEach(classData => {
                if (classData.students.some(student => student !== null)) {
                    hasData = true;
                }
            });
            
            const warning = document.getElementById('importDataWarning');
            if (hasData) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }

        // ÈóúÈñâÂåØÂÖ•Ë≥áÊñôÊ®°ÊÖãÊ°Ü
        function closeImportDataModal() {
            document.getElementById('importDataModal').style.display = 'none';
            document.getElementById('dataFileInput').value = '';
        }

        // ÂåØÂÖ•Ë≥áÊñô
        function importData() {
            const fileInput = document.getElementById('dataFileInput');
            if (!fileInput.files[0]) {
                alert('Ë´ãÈÅ∏Êìá‰∏ÄÂÄã JSON Ë≥áÊñôÊ™îÊ°àÔºÅ');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Êñ∞ÁâàÊú¨ÔºàÂ§öÁè≠Á¥öÔºâÊ†ºÂºè
                    if (importedData.version === '2.0' && importedData.classesData) {
                        // Êñ∞ÁâàÊú¨Â§öÁè≠Á¥öÊ†ºÂºè
                        const classCount = Object.keys(importedData.classesData).length;
                        const totalStudents = Object.values(importedData.classesData)
                            .reduce((total, classData) => total + classData.students.filter(s => s !== null).length, 0);
                        
                        if (!confirm(`Âç≥Â∞áÂåØÂÖ•Â§öÁè≠Á¥öË≥áÊñôÔºö\n‚Ä¢ ${classCount} ÂÄãÁè≠Á¥ö\n‚Ä¢ Á∏ΩÂÖ± ${totalStudents} ‰ΩçÂ≠∏Áîü\n\nÈÄôÂ∞áÊúÉË¶ÜËìãÁõÆÂâçÊâÄÊúâÁöÑÁè≠Á¥öÂíåÂ≠∏ÁîüË≥áÊñôÔºåÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü`)) {
                            return;
                        }
                        
                        // ÂåØÂÖ•ÊâÄÊúâÁè≠Á¥öË≥áÊñô
                        classesData = { ...importedData.classesData };
                        currentClassId = importedData.currentClassId || Object.keys(classesData)[0];
                        
                        // ËºâÂÖ•ÁõÆÂâçÁè≠Á¥öË≥áÊñô
                        loadCurrentClassData();
                        
                        // Êõ¥Êñ∞‰ªãÈù¢
                        updateClassSelector();
                        initializeSeating();
                        
                        // Ëá™ÂãïÂÑ≤Â≠òÂà∞ localStorage
                        saveToLocalStorage();
                        
                        alert(`Â§öÁè≠Á¥öË≥áÊñôÂåØÂÖ•ÊàêÂäüÔºÅ\n‚Ä¢ ÂåØÂÖ•Áè≠Á¥öÊï∏Ôºö${classCount} ÂÄã\n‚Ä¢ Á∏ΩÂ≠∏Áîü‰∫∫Êï∏Ôºö${totalStudents} ‰Ωç\n‚Ä¢ ÁõÆÂâçÁè≠Á¥öÔºö${classesData[currentClassId].name}\n‚Ä¢ Ë≥áÊñôÂ∑≤Ëá™ÂãïÂÑ≤Â≠òÂà∞Êú¨Âú∞`);
                        
                    } else if (importedData.seatingConfig && importedData.students && importedData.studentScores) {
                        // ËàäÁâàÊú¨ÂñÆÁè≠Á¥öÊ†ºÂºè
                        const importedStudents = importedData.students.filter(s => s !== null).length;
                        
                        if (!confirm(`Âç≥Â∞áÂåØÂÖ•ÂñÆÁè≠Á¥öË≥áÊñôÔºö\n‚Ä¢ 1 ÂÄãÁè≠Á¥ö\n‚Ä¢ ${importedStudents} ‰ΩçÂ≠∏Áîü\n\nÈÄôÂ∞áÊúÉË¶ÜËìãÁõÆÂâçÁè≠Á¥öÁöÑÂ∫ß‰ΩçÂÆâÊéíÂíåÂ≠∏ÁîüË≥áÊñôÔºåÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü`)) {
                            return;
                        }
                        
                        // ÂåØÂÖ•Âà∞ÁõÆÂâçÁè≠Á¥ö
                        columns = importedData.seatingConfig.columns;
                        rows = importedData.seatingConfig.rows;
                        totalSeats = importedData.seatingConfig.totalSeats;
                        
                        students = [...importedData.students];
                        studentScores = [...importedData.studentScores];
                        
                        // Á¢∫‰øùÈô£ÂàóÈï∑Â∫¶Ê≠£Á¢∫
                        while (students.length < totalSeats) students.push(null);
                        while (studentScores.length < totalSeats) studentScores.push(0);
                        
                        // ÂÑ≤Â≠òÂà∞Áè≠Á¥öË≥áÊñô
                        saveCurrentClassData();
                        
                        // Êõ¥Êñ∞‰ªãÈù¢
                        updateClassSelector();
                        initializeSeating();
                        
                        // Ëá™ÂãïÂÑ≤Â≠òÂà∞ localStorage
                        saveToLocalStorage();
                        
                        alert(`Ë≥áÊñôÂåØÂÖ•ÊàêÂäüÔºÅ\n‚Ä¢ Â∫ß‰ΩçÈÖçÁΩÆÔºö${columns} Âàó √ó ${rows} Ê¨Ñ\n‚Ä¢ Â≠∏Áîü‰∫∫Êï∏Ôºö${importedStudents} ‰Ωç\n‚Ä¢ ÂåØÂÖ•ÊôÇÈñìÔºö${importedData.timestamp ? new Date(importedData.timestamp).toLocaleString() : 'Êú™Áü•'}\n‚Ä¢ Ë≥áÊñôÂ∑≤Ëá™ÂãïÂÑ≤Â≠òÂà∞Êú¨Âú∞`);
                        
                    } else {
                        throw new Error('‰∏çÊîØÊè¥ÁöÑË≥áÊñôÊ†ºÂºè');
                    }
                    
                    closeImportDataModal();
                    
                } catch (error) {
                    alert('Ê™îÊ°àÊ†ºÂºèÈåØË™§ÊàñË≥áÊñôÊêçÂ£ûÔºåË´ãÁ¢∫Ë™çÈÅ∏ÊìáÁöÑÊòØÊ≠£Á¢∫ÁöÑÂ∫ß‰ΩçË≥áÊñôÊ™îÊ°àÔºÅ\nÈåØË™§Ë©≥ÊÉÖÔºö' + error.message);
                }
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        // ÊäΩÁ±§ÂäüËÉΩËÆäÊï∏
        let isSpinning = false;
        let availableStudents = [];
        let selectedStudents = []; // Â∑≤ÊäΩ‰∏≠ÁöÑÂ≠∏Áîü
        let lotteryHistory = []; // ÊäΩÁ±§Ê≠∑Âè≤

        // Èü≥ÊïàÂäüËÉΩ
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Ê™¢Êü•Èü≥ÊïàÊòØÂê¶ÈñãÂïü
        function isSoundEnabled() {
            const soundCheckbox = document.getElementById('soundEnabled');
            return soundCheckbox && soundCheckbox.checked;
        }

        // ÂâµÂª∫‰∏çÂêåÈ†ªÁéáÁöÑÈü≥Êïà
        function playSound(frequency, duration, type = 'sine') {
            if (!isSoundEnabled()) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (error) {
                console.log('Èü≥ÊïàÊí≠ÊîæÂ§±Êïó:', error);
            }
        }

        // Êí≠ÊîæÊäΩÁ±§ÂãïÁï´Èü≥ÊïàÔºàÂø´ÈÄüÂó∂Âó∂ËÅ≤Ôºâ
        function playLotteryTickSound() {
            playSound(800, 0.1, 'square');
        }

        // Êí≠ÊîæÁµêÊûúÈü≥ÊïàÔºàÊàêÂäüÈü≥ÊïàÔºâ
        function playResultSound() {
            if (!isSoundEnabled()) return;
            // Êí≠Êîæ‰∏ÄÂÄã‰∏äÂçáÁöÑÈü≥Èöé
            setTimeout(() => playSound(523, 0.2), 0);    // C5
            setTimeout(() => playSound(659, 0.2), 100);  // E5
            setTimeout(() => playSound(784, 0.3), 200);  // G5
            setTimeout(() => playSound(1047, 0.4), 300); // C6
        }

        // Êí≠ÊîæÈáçË®≠Èü≥Êïà
        function playResetSound() {
            playSound(400, 0.3, 'sawtooth');
        }

        // È°ØÁ§∫ÊäΩÁ±§ÊéßÂà∂Èù¢Êùø
        function showLotteryControls() {
            // Áç≤ÂèñÊâÄÊúâÊúâÂ≠∏ÁîüÁöÑÂ∫ß‰Ωç
            updateAvailableStudents();
            
            if (availableStudents.length === 0) {
                alert('ÁõÆÂâçÊ≤íÊúâÂ≠∏ÁîüÂèØ‰ª•ÊäΩÁ±§ÔºÅË´ãÂÖàÊñ∞Â¢û‰∏Ä‰∫õÂ≠∏Áîü„ÄÇ');
                return;
            }

            document.getElementById('lotteryControls').style.display = 'block';
            updateLotteryStatus();
        }

        // Èö±ËóèÊäΩÁ±§ÊéßÂà∂Èù¢Êùø
        function hideLotteryControls() {
            document.getElementById('lotteryControls').style.display = 'none';
            // Ê∏ÖÈô§ÊâÄÊúâÈ´ò‰∫Æ
            clearAllHighlights();
        }

        // Êõ¥Êñ∞ÂèØÁî®Â≠∏ÁîüÂàóË°®
        function updateAvailableStudents() {
            const mode = document.getElementById('lotteryMode').value;
            
            if (mode === 'reset') {
                // ÈáçË§áÊäΩÁ±§Ê®°ÂºèÔºöÊâÄÊúâÂ≠∏ÁîüÈÉΩÂèØ‰ª•Ë¢´ÊäΩÂà∞ÔºàÊéíÈô§Ë´ãÂÅáÂ≠∏ÁîüÔºâ
                availableStudents = [];
                for (let i = 0; i < totalSeats; i++) {
                    if (students[i] && !studentLeaveStatus[i]) {
                        availableStudents.push({
                            name: students[i],
                            seatIndex: i
                        });
                    }
                }
            } else {
                // ÈÄ£Á∫åÊäΩÁ±§Ê®°ÂºèÔºöÊéíÈô§Â∑≤ÊäΩ‰∏≠ÁöÑÂ≠∏ÁîüÂíåË´ãÂÅáÂ≠∏Áîü
                availableStudents = [];
                for (let i = 0; i < totalSeats; i++) {
                    if (students[i] && !selectedStudents.includes(i) && !studentLeaveStatus[i]) {
                        availableStudents.push({
                            name: students[i],
                            seatIndex: i
                        });
                    }
                }
            }
        }

        // Êõ¥Êñ∞ÊäΩÁ±§ÁãÄÊÖãÈ°ØÁ§∫
        function updateLotteryStatus() {
            const mode = document.getElementById('lotteryMode').value;
            const totalStudents = students.filter(s => s !== null).length;
            const selectedCount = selectedStudents.length;
            const availableCount = availableStudents.length;
            
            let statusText = '';
            if (mode === 'reset') {
                statusText = `Á∏ΩÂ≠∏ÁîüÔºö${totalStudents} ‰∫∫ | ÊØèÊ¨°ÈÉΩÂæûÂÖ®ÈÉ®Â≠∏Áîü‰∏≠ÊäΩÂèñ`;
            } else {
                statusText = `Á∏ΩÂ≠∏ÁîüÔºö${totalStudents} ‰∫∫ | Â∑≤ÊäΩ‰∏≠Ôºö${selectedCount} ‰∫∫ | Ââ©È§òÔºö${availableCount} ‰∫∫`;
            }
            
            document.getElementById('availableStudentsInfo').textContent = statusText;
        }

        // ÈñãÂßãÁõ¥Êé•ÊäΩÁ±§
        function startDirectLottery() {
            updateAvailableStudents();
            
            if (availableStudents.length === 0) {
                alert('Ê≤íÊúâÂèØÊäΩÁ±§ÁöÑÂ≠∏Áîü‰∫ÜÔºÅË´ãÈáçË®≠ÊäΩÁ±§ÊàñÂàáÊèõÂà∞ÈáçË§áÊäΩÁ±§Ê®°Âºè„ÄÇ');
                return;
            }

            const count = parseInt(document.getElementById('lotteryCount').value);
            const actualCount = Math.min(count, availableStudents.length);
            
            if (actualCount < count) {
                if (!confirm(`Ââ©È§òÂ≠∏Áîü‰∏çË∂≥ ${count} ‰∫∫ÔºåÂ∞áÊäΩÂèñ ${actualCount} ‰∫∫ÔºåÁ¢∫ÂÆöÁπºÁ∫åÂóéÔºü`)) {
                    return;
                }
            }

            const mode = document.getElementById('lotteryMode').value;
            
            // Ê†πÊìöÊ®°ÂºèÊ±∫ÂÆöÊòØÂê¶Ê∏ÖÈô§‰πãÂâçÁöÑÈ´ò‰∫Æ
            if (mode === 'reset') {
                // ÈáçË§áÊäΩÁ±§Ê®°ÂºèÔºöÊ∏ÖÈô§ÊâÄÊúâÈ´ò‰∫Æ
                clearAllHighlights();
            } else {
                // ÈÄ£Á∫åÊäΩÁ±§Ê®°ÂºèÔºöÂè™Ê∏ÖÈô§ÂãïÁï´È´ò‰∫ÆÔºå‰øùÁïôÂ∑≤ÈÅ∏‰∏≠ÁöÑ
                clearAnimationHighlights();
            }

            // Èö®Ê©üÈÅ∏ÊìáÂ≠∏Áîü
            const selectedInThisRound = [];
            const shuffled = [...availableStudents].sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < actualCount; i++) {
                selectedInThisRound.push(shuffled[i]);
            }

            // È°ØÁ§∫ÊäΩÁ±§ÂãïÁï´
            showLotteryAnimation(selectedInThisRound);
        }

        // È°ØÁ§∫ÊäΩÁ±§ÂãïÁï´
        function showLotteryAnimation(selectedInThisRound) {
            const seats = document.querySelectorAll('.seat');
            let animationStep = 0;
            const maxSteps = 20; // ÂãïÁï´Ê≠•Êï∏
            
            const animationInterval = setInterval(() => {
                // Ê∏ÖÈô§‰πãÂâçÁöÑËá®ÊôÇÈ´ò‰∫ÆÔºà‰ΩÜ‰øùÁïôÂ∑≤ÈÅ∏‰∏≠ÁöÑÔºâ
                seats.forEach(seat => {
                    if (!seat.classList.contains('lottery-selected')) {
                        seat.classList.remove('lottery-animation');
                    }
                });
                
                if (animationStep < maxSteps) {
                    // Êí≠ÊîæÊäΩÁ±§Èü≥Êïà
                    playLotteryTickSound();
                    
                    // Èö®Ê©üÈ´ò‰∫Æ‰∏Ä‰∫õÂ∫ß‰ΩçÔºàÊéíÈô§Â∑≤ÈÅ∏‰∏≠ÁöÑÔºâ
                    const randomSeats = [...seats]
                        .filter(seat => {
                            const seatIndex = parseInt(seat.dataset.seatIndex);
                            return students[seatIndex] && !seat.classList.contains('lottery-selected');
                        })
                        .sort(() => Math.random() - 0.5)
                        .slice(0, selectedInThisRound.length);
                    
                    randomSeats.forEach(seat => {
                        seat.classList.add('lottery-animation');
                    });
                    
                    animationStep++;
                } else {
                    // ÂãïÁï´ÁµêÊùüÔºåÈ°ØÁ§∫ÊúÄÁµÇÁµêÊûú
                    clearInterval(animationInterval);
                    showFinalLotteryResult(selectedInThisRound);
                }
            }, 100);
        }

        // È°ØÁ§∫ÊúÄÁµÇÊäΩÁ±§ÁµêÊûú
        function showFinalLotteryResult(selectedInThisRound) {
            // Ê∏ÖÈô§ÂãïÁï´Ê®£Âºè
            const seats = document.querySelectorAll('.seat');
            seats.forEach(seat => {
                seat.classList.remove('lottery-animation');
            });

            const mode = document.getElementById('lotteryMode').value;

            // ÂÖàÂ∞á‰πãÂâçÁöÑ lottery-current ÊîπÁÇ∫ lottery-previous
            seats.forEach(seat => {
                if (seat.classList.contains('lottery-current')) {
                    seat.classList.remove('lottery-current');
                    seat.classList.add('lottery-previous');
                }
            });

            // Êõ¥Êñ∞ÈÅ∏‰∏≠Â≠∏ÁîüÂàóË°®ÔºàÈÄ£Á∫åÊäΩÁ±§Ê®°ÂºèÔºâ
            if (mode === 'continue') {
                selectedInThisRound.forEach(student => {
                    if (!selectedStudents.includes(student.seatIndex)) {
                        selectedStudents.push(student.seatIndex);
                    }
                });
            } else {
                // ÈáçË§áÊäΩÁ±§Ê®°ÂºèÔºöÊ∏ÖÈô§‰πãÂâçÁöÑÈÅ∏‰∏≠ÁãÄÊÖã
                seats.forEach(seat => {
                    seat.classList.remove('lottery-previous', 'lottery-selected');
                });
            }

            // È´ò‰∫ÆÊú¨Ê¨°Êñ∞ÈÅ∏‰∏≠ÁöÑÂ≠∏ÁîüÔºàÁ¥ÖËâ≤ÈñÉÁàçÔºâ
            selectedInThisRound.forEach(student => {
                const seat = document.querySelector(`[data-seat-index="${student.seatIndex}"]`);
                if (seat) {
                    seat.classList.remove('lottery-previous', 'lottery-selected');
                    seat.classList.add('lottery-current');
                }
            });

            // Ë®òÈåÑÊäΩÁ±§Ê≠∑Âè≤
            lotteryHistory.push({
                timestamp: new Date(),
                students: selectedInThisRound.map(s => s.name),
                mode: mode
            });

            // Êõ¥Êñ∞ÁãÄÊÖã
            updateLotteryStatus();

            // Êí≠ÊîæÊàêÂäüÈü≥Êïà
            playResultSound();
            
            // È°ØÁ§∫ÁµêÊûúË®äÊÅØ
            const names = selectedInThisRound.map(s => s.name).join('„ÄÅ');
            const message = `üéâ Êú¨Ê¨°ÊäΩ‰∏≠Ôºö${names}`;
            
            // ÂâµÂª∫ÁµêÊûúÊèêÁ§∫
            showLotteryResultMessage(message);

            // 5ÁßíÂæåÂ∞áÊú¨Ê¨°ÊäΩ‰∏≠ÁöÑÊîπÁÇ∫ÊôÆÈÄöÈÅ∏‰∏≠ÁãÄÊÖãÔºàÈÄ£Á∫åÊäΩÁ±§Ê®°ÂºèÔºâ
            if (mode === 'continue') {
                setTimeout(() => {
                    selectedInThisRound.forEach(student => {
                        const seat = document.querySelector(`[data-seat-index="${student.seatIndex}"]`);
                        if (seat && seat.classList.contains('lottery-current')) {
                            seat.classList.remove('lottery-current');
                            seat.classList.add('lottery-previous');
                        }
                    });
                }, 5000);
            }
        }

        // È°ØÁ§∫ÊäΩÁ±§ÁµêÊûúË®äÊÅØ
        function showLotteryResultMessage(message) {
            // ÂâµÂª∫ÁµêÊûúÈ°ØÁ§∫ÂÖÉÁ¥†
            const resultDiv = document.createElement('div');
            resultDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
                color: #2d3748;
                padding: 20px 30px;
                border-radius: 15px;
                font-size: 1.5rem;
                font-weight: bold;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 2000;
                animation: resultPop 0.5s ease-out;
                text-align: center;
                border: 3px solid #ff6b35;
            `;
            
            resultDiv.innerHTML = message;
            document.body.appendChild(resultDiv);
            
            // 3ÁßíÂæåËá™ÂãïÁßªÈô§
            setTimeout(() => {
                if (resultDiv.parentNode) {
                    resultDiv.parentNode.removeChild(resultDiv);
                }
            }, 3000);
        }

        // È°ØÁ§∫Ê∏ÖÈô§Ë≥áÊñôÁ¢∫Ë™çÂ∞çË©±Ê°Ü
        function showClearDataModal() {
            const totalClasses = Object.keys(classesData).length;
            const totalStudents = Object.values(classesData)
                .reduce((total, classData) => total + classData.students.filter(s => s !== null).length, 0);
            
            const confirmMessage = `‚ö†Ô∏è Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâË≥áÊñôÂóéÔºü\n\nÂ∞áÊúÉÊ∞∏‰πÖÂà™Èô§Ôºö\n‚Ä¢ ${totalClasses} ÂÄãÁè≠Á¥ö\n‚Ä¢ ${totalStudents} ‰ΩçÂ≠∏ÁîüÁöÑË≥áÊñô\n‚Ä¢ ÊâÄÊúâÂ∫ß‰ΩçÂÆâÊéíÂíåÂàÜÊï∏Ë®òÈåÑ\n‚Ä¢ Êú¨Âú∞ÂÑ≤Â≠òÁöÑË≥áÊñô\n\nÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ\n\nË´ãËº∏ÂÖ•„ÄåÊ∏ÖÈô§ÊâÄÊúâË≥áÊñô„Äç‰æÜÁ¢∫Ë™çÔºö`;
            
            const userInput = prompt(confirmMessage);
            
            if (userInput === 'Ê∏ÖÈô§ÊâÄÊúâË≥áÊñô') {
                // Ê∏ÖÈô§ÊâÄÊúâË≥áÊñô
                clearAllData();
                alert('ÊâÄÊúâË≥áÊñôÂ∑≤Ê∏ÖÈô§ÔºÅÁ≥ªÁµ±Â∑≤ÈáçË®≠ÁÇ∫ÂàùÂßãÁãÄÊÖã„ÄÇ');
            } else if (userInput !== null) {
                alert('Ëº∏ÂÖ•‰∏çÊ≠£Á¢∫ÔºåÊ∏ÖÈô§Êìç‰ΩúÂ∑≤ÂèñÊ∂à„ÄÇ');
            }
        }

        // Ê∏ÖÈô§ÊâÄÊúâË≥áÊñô
        function clearAllData() {
            // Ê∏ÖÈô§ localStorage
            clearLocalStorage();
            
            // ÈáçË®≠ÁÇ∫ÂàùÂßãÁãÄÊÖã
            currentClassId = 'class1';
            classesData = {
                'class1': {
                    name: '‰∏ÄÂπ¥‰∏ÄÁè≠',
                    columns: 6,
                    rows: 5,
                    students: new Array(30).fill(null),
                    studentScores: new Array(30).fill(0)
                }
            };
            
            // ËºâÂÖ•È†êË®≠Áè≠Á¥öË≥áÊñô
            loadCurrentClassData();
            
            // Êõ¥Êñ∞‰ªãÈù¢
            updateClassSelector();
            initializeSeating();
            
            // Èö±ËóèÊäΩÁ±§ÊéßÂà∂Èù¢Êùø
            document.getElementById('lotteryControls').style.display = 'none';
            clearAllHighlights();
        }

        // ÈáçË®≠ÊäΩÁ±§
        function resetLottery() {
            playResetSound();
            selectedStudents = [];
            lotteryHistory = [];
            clearAllHighlights();
            updateAvailableStudents();
            updateLotteryStatus();
            
            alert('ÊäΩÁ±§Â∑≤ÈáçË®≠ÔºÅÊâÄÊúâÂ≠∏ÁîüÈÉΩÂèØ‰ª•ÈáçÊñ∞ÂèÉËàáÊäΩÁ±§„ÄÇ');
        }

        // Ê∏ÖÈô§ÊâÄÊúâÈ´ò‰∫Æ
        function clearAllHighlights() {
            const seats = document.querySelectorAll('.seat');
            seats.forEach(seat => {
                seat.classList.remove('lottery-selected', 'lottery-animation', 'lottery-current', 'lottery-previous');
            });
        }

        // Ê∏ÖÈô§ÂÉÖÂãïÁï´È´ò‰∫ÆÔºà‰øùÁïôÈÅ∏‰∏≠ÁãÄÊÖãÔºâ
        function clearAnimationHighlights() {
            const seats = document.querySelectorAll('.seat');
            seats.forEach(seat => {
                seat.classList.remove('lottery-animation');
            });
        }

        // ÈñãÂßãÊäΩÁ±§Ôºà‰øùÁïôÂéüÊúâÁöÑËº™Áõ§ÊäΩÁ±§ÂäüËÉΩÔºâ
        function startLottery() {
            // Áç≤ÂèñÊâÄÊúâÊúâÂ≠∏ÁîüÁöÑÂ∫ß‰Ωç
            availableStudents = [];
            for (let i = 0; i < totalSeats; i++) {
                if (students[i]) {
                    availableStudents.push({
                        name: students[i],
                        seatIndex: i
                    });
                }
            }

            if (availableStudents.length === 0) {
                alert('ÁõÆÂâçÊ≤íÊúâÂ≠∏ÁîüÂèØ‰ª•ÊäΩÁ±§ÔºÅË´ãÂÖàÊñ∞Â¢û‰∏Ä‰∫õÂ≠∏Áîü„ÄÇ');
                return;
            }

            // È°ØÁ§∫ÊäΩÁ±§Ê®°ÊÖãÊ°Ü
            document.getElementById('lotteryModal').style.display = 'block';
            document.getElementById('lotteryStudentCount').textContent = availableStudents.length;
            
            // ÈáçÁΩÆÊäΩÁ±§ÁãÄÊÖã
            resetLotteryDisplay();
        }

        // ÈáçÁΩÆÊäΩÁ±§È°ØÁ§∫
        function resetLotteryDisplay() {
            const wheelContainer = document.getElementById('wheelContainer');
            const resultDisplay = document.getElementById('resultDisplay');
            const readyMessage = document.getElementById('readyMessage');
            const lotteryBtn = document.getElementById('lotteryBtn');

            wheelContainer.style.transform = 'rotate(0deg)';
            resultDisplay.style.display = 'none';
            readyMessage.style.display = 'block';
            lotteryBtn.textContent = 'üé≤ ÈñãÂßãÊäΩÁ±§';
            lotteryBtn.onclick = spinWheel;
            isSpinning = false;
        }

        // ËΩâÂãïËº™Áõ§
        function spinWheel() {
            if (isSpinning || availableStudents.length === 0) return;

            isSpinning = true;
            const lotteryBtn = document.getElementById('lotteryBtn');
            const wheelContainer = document.getElementById('wheelContainer');
            const readyMessage = document.getElementById('readyMessage');

            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            lotteryBtn.textContent = 'üé≤ ÊäΩÁ±§‰∏≠...';
            lotteryBtn.disabled = true;
            readyMessage.textContent = 'Ê≠£Âú®ÊäΩÁ±§‰∏≠ÔºåË´ãÁ®çÂÄô...';

            // Êí≠ÊîæËº™Áõ§ËΩâÂãïÈü≥ÊïàÔºàÈÄ£Á∫åÁöÑÂó∂Âó∂ËÅ≤Ôºâ
            let tickCount = 0;
            const tickInterval = setInterval(() => {
                playLotteryTickSound();
                tickCount++;
                if (tickCount >= 25) { // Êí≠Êîæ2.5ÁßíÁöÑÈü≥Êïà
                    clearInterval(tickInterval);
                }
            }, 100);

            // Èö®Ê©üÈÅ∏ÊìáÂ≠∏Áîü
            const selectedIndex = Math.floor(Math.random() * availableStudents.length);
            const selectedStudent = availableStudents[selectedIndex];

            // Ë®àÁÆóËΩâÂãïËßíÂ∫¶ÔºàÂ§öËΩâÂπæÂúàÂ¢ûÂä†ÊïàÊûúÔºâ
            const baseRotation = 1440; // 4Âúà
            const randomRotation = Math.floor(Math.random() * 360);
            const totalRotation = baseRotation + randomRotation;

            // ÈñãÂßãËΩâÂãï
            wheelContainer.style.transform = `rotate(${totalRotation}deg)`;

            // 3ÁßíÂæåÈ°ØÁ§∫ÁµêÊûú
            setTimeout(() => {
                showLotteryResult(selectedStudent);
            }, 3000);
        }

        // È°ØÁ§∫ÊäΩÁ±§ÁµêÊûú
        function showLotteryResult(selectedStudent) {
            const resultDisplay = document.getElementById('resultDisplay');
            const readyMessage = document.getElementById('readyMessage');
            const selectedStudentSpan = document.getElementById('selectedStudent');
            const lotteryBtn = document.getElementById('lotteryBtn');

            // Êí≠ÊîæÊàêÂäüÈü≥Êïà
            playResultSound();

            // È°ØÁ§∫ÁµêÊûú
            selectedStudentSpan.textContent = selectedStudent.name;
            resultDisplay.style.display = 'block';
            readyMessage.style.display = 'none';

            // È´ò‰∫ÆÈ°ØÁ§∫Ë¢´ÈÅ∏‰∏≠ÁöÑÂ≠∏ÁîüÂ∫ß‰Ωç
            highlightSelectedSeat(selectedStudent.seatIndex);

            // Êõ¥Êñ∞ÊåâÈàï
            lotteryBtn.textContent = 'üé≤ ÂÜçÊ¨°ÊäΩÁ±§';
            lotteryBtn.disabled = false;
            lotteryBtn.onclick = () => {
                resetLotteryDisplay();
                setTimeout(spinWheel, 100);
            };

            isSpinning = false;
        }

        // È´ò‰∫ÆÈ°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÂ∫ß‰Ωç
        function highlightSelectedSeat(seatIndex) {
            // ÁßªÈô§‰πãÂâçÁöÑÈ´ò‰∫Æ
            const allSeats = document.querySelectorAll('.seat');
            allSeats.forEach(seat => {
                seat.classList.remove('lottery-current', 'lottery-previous');
            });

            // Ê∑ªÂä†Êñ∞ÁöÑÈ´ò‰∫ÆÔºà‰ΩøÁî®Á¥ÖËâ≤ÈñÉÁàçÊïàÊûúÔºâ
            const selectedSeat = document.querySelector(`[data-seat-index="${seatIndex}"]`);
            if (selectedSeat) {
                selectedSeat.classList.add('lottery-current');
                
                // 8ÁßíÂæåÁßªÈô§È´ò‰∫Æ
                setTimeout(() => {
                    selectedSeat.classList.remove('lottery-current');
                }, 8000);
            }
        }

        // ÈóúÈñâÊäΩÁ±§Ê®°ÊÖãÊ°Ü
        function closeLotteryModal() {
            document.getElementById('lotteryModal').style.display = 'none';
            
            // ÁßªÈô§ÊâÄÊúâÂ∫ß‰ΩçÈ´ò‰∫Æ
            const allSeats = document.querySelectorAll('.seat');
            allSeats.forEach(seat => {
                seat.classList.remove('lottery-selected', 'lottery-current', 'lottery-previous');
            });
            
            resetLotteryDisplay();
        }

        // ÈªûÊìäÊ®°ÊÖãÊ°ÜÂ§ñÈÉ®ÈóúÈñâ
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const importModal = document.getElementById('importModal');
            const layoutModal = document.getElementById('layoutModal');
            const importDataModal = document.getElementById('importDataModal');
            const lotteryModal = document.getElementById('lotteryModal');
            const addClassModal = document.getElementById('addClassModal');
            const manageClassModal = document.getElementById('manageClassModal');
            const leaveModal = document.getElementById('leaveModal');
            
            if (event.target === editModal) {
                closeModal();
            } else if (event.target === importModal) {
                closeImportModal();
            } else if (event.target === layoutModal) {
                closeLayoutModal();
            } else if (event.target === importDataModal) {
                closeImportDataModal();
            } else if (event.target === lotteryModal) {
                closeLotteryModal();
            } else if (event.target === addClassModal) {
                closeAddClassModal();
            } else if (event.target === manageClassModal) {
                closeManageClassModal();
            } else if (event.target === leaveModal) {
                closeLeaveModal();
            }
            
            const timerModal = document.getElementById('timerModal');
            if (event.target === timerModal) {
                closeTimerModal();
            }
        }

        // Enter ÈçµÂÑ≤Â≠ò
        document.getElementById('studentNameInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                saveStudent();
            }
        });

        // ÊãñÊãâÂäüËÉΩËÆäÊï∏
        let dragSourceIndex = null;

        // ÊãñÊãâÈñãÂßã
        function handleDragStart(e) {
            dragSourceIndex = parseInt(e.target.dataset.seatIndex);
            e.target.classList.add('drag-source');
            
            // Âè™ÂÖÅË®±ÊãñÊãâÊúâÂ≠∏ÁîüÁöÑÂ∫ß‰Ωç
            if (!students[dragSourceIndex]) {
                e.preventDefault();
                return false;
            }
            
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
        }

        // ÊãñÊãâÁ∂ìÈÅé
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        // ÊãñÊãâÈÄ≤ÂÖ•
        function handleDragEnter(e) {
            e.target.classList.add('drag-over');
        }

        // ÊãñÊãâÈõ¢Èñã
        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        // Êîæ‰∏ã
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const dropTargetIndex = parseInt(e.target.closest('.seat').dataset.seatIndex);
            
            if (dragSourceIndex !== dropTargetIndex) {
                // ‰∫§ÊèõÂ≠∏Áîü‰ΩçÁΩÆÂíåÂàÜÊï∏
                const sourceStudent = students[dragSourceIndex];
                const targetStudent = students[dropTargetIndex];
                const sourceScore = studentScores[dragSourceIndex];
                const targetScore = studentScores[dropTargetIndex];
                
                students[dragSourceIndex] = targetStudent;
                students[dropTargetIndex] = sourceStudent;
                studentScores[dragSourceIndex] = targetScore;
                studentScores[dropTargetIndex] = sourceScore;
                
                initializeSeating();
            }

            return false;
        }

        // ÊãñÊãâÁµêÊùü
        function handleDragEnd(e) {
            // Ê∏ÖÈô§ÊâÄÊúâÊãñÊãâÊ®£Âºè
            const seats = document.querySelectorAll('.seat');
            seats.forEach(seat => {
                seat.classList.remove('drag-source', 'drag-over');
            });
            
            dragSourceIndex = null;
        }

        // Èü≥ÊïàÈñãÈóú‰∫ã‰ª∂Áõ£ËÅΩÂô®
        document.addEventListener('DOMContentLoaded', function() {
            const soundCheckbox = document.getElementById('soundEnabled');
            const soundStatus = document.getElementById('soundStatus');
            
            if (soundCheckbox && soundStatus) {
                soundCheckbox.addEventListener('change', function() {
                    soundStatus.textContent = this.checked ? 'ÈñãÂïü' : 'ÈóúÈñâ';
                    
                    // Êí≠ÊîæÊ∏¨Ë©¶Èü≥ÊïàÔºàÂ¶ÇÊûúÈñãÂïüÔºâ
                    if (this.checked) {
                        setTimeout(() => playSound(523, 0.2), 100);
                    }
                });
            }
        });

        // È°ØÁ§∫Ë´ãÂÅáÁÆ°ÁêÜÊ®°ÊÖãÊ°Ü
        function showLeaveModal() {
            document.getElementById('leaveModal').style.display = 'block';
            switchLeaveTab('leave');
            updateLeaveStudentSelect();
        }

        // ÈóúÈñâË´ãÂÅáÁÆ°ÁêÜÊ®°ÊÖãÊ°Ü
        function closeLeaveModal() {
            document.getElementById('leaveModal').style.display = 'none';
        }

        // ÂàáÊèõË´ãÂÅáÁÆ°ÁêÜÈ†ÅÁ±§
        function switchLeaveTab(tab) {
            // Èö±ËóèÊâÄÊúâÈ†ÅÁ±§ÂÖßÂÆπ
            document.getElementById('leaveTab').style.display = 'none';
            document.getElementById('returnTab').style.display = 'none';
            document.getElementById('historyTab').style.display = 'none';
            
            // ÈáçË®≠ÊåâÈàïÊ®£Âºè
            document.getElementById('leaveTabBtn').className = 'btn btn-secondary';
            document.getElementById('returnTabBtn').className = 'btn btn-secondary';
            document.getElementById('historyTabBtn').className = 'btn btn-secondary';
            
            // È°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÈ†ÅÁ±§
            if (tab === 'leave') {
                document.getElementById('leaveTab').style.display = 'block';
                document.getElementById('leaveTabBtn').className = 'btn btn-primary';
                updateLeaveStudentSelect();
            } else if (tab === 'return') {
                document.getElementById('returnTab').style.display = 'block';
                document.getElementById('returnTabBtn').className = 'btn btn-primary';
                updateOnLeaveStudentsList();
            } else if (tab === 'history') {
                document.getElementById('historyTab').style.display = 'block';
                document.getElementById('historyTabBtn').className = 'btn btn-primary';
                updateLeaveHistoryList();
            }
        }

        // Êõ¥Êñ∞Ë´ãÂÅáÂ≠∏ÁîüÈÅ∏ÊìáÂàóË°®
        function updateLeaveStudentSelect() {
            const select = document.getElementById('leaveStudentSelect');
            select.innerHTML = '<option value="">Ë´ãÈÅ∏ÊìáÂ≠∏Áîü</option>';
            
            for (let i = 0; i < totalSeats; i++) {
                if (students[i] && !studentLeaveStatus[i]) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${students[i]} (Â∫ß‰Ωç ${i + 1})`;
                    select.appendChild(option);
                }
            }
            
            // Ë®≠ÂÆö‰ªäÂ§©ÁöÑÊó•ÊúüÁÇ∫È†êË®≠ÂÄº
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('leaveDateInput').value = today;
        }

        // Ë®≠ÂÆöÂ≠∏ÁîüË´ãÂÅá
        function setStudentLeave() {
            const seatIndex = parseInt(document.getElementById('leaveStudentSelect').value);
            const leaveType = document.getElementById('leaveTypeSelect').value;
            const leaveReason = document.getElementById('leaveReasonInput').value.trim();
            const leaveDate = document.getElementById('leaveDateInput').value;
            
            if (isNaN(seatIndex)) {
                alert('Ë´ãÈÅ∏ÊìáË¶ÅË´ãÂÅáÁöÑÂ≠∏ÁîüÔºÅ');
                return;
            }
            
            if (!leaveDate) {
                alert('Ë´ãÈÅ∏ÊìáË´ãÂÅáÊó•ÊúüÔºÅ');
                return;
            }
            
            const studentName = students[seatIndex];
            
            // Ë®≠ÂÆöË´ãÂÅáÁãÄÊÖã
            studentLeaveStatus[seatIndex] = true;
            
            // Á¢∫‰øùÁè≠Á¥öË≥áÊñôÁµêÊßã‰∏≠ÁöÑË´ãÂÅáÁãÄÊÖãÈô£ÂàóÂ≠òÂú®‰∏¶Êõ¥Êñ∞
            if (!classesData[currentClassId].studentLeaveStatus) {
                classesData[currentClassId].studentLeaveStatus = new Array(totalSeats).fill(false);
            }
            classesData[currentClassId].studentLeaveStatus[seatIndex] = true;
            
            // Ë®òÈåÑË´ãÂÅáË≥áË®ä
            const leaveRecord = {
                id: Date.now(),
                studentName: studentName,
                seatIndex: seatIndex,
                leaveType: leaveType,
                leaveReason: leaveReason,
                leaveDate: leaveDate,
                leaveTime: new Date().toISOString(),
                returnTime: null,
                status: 'on-leave'
            };
            
            // Ê∑ªÂä†Âà∞Ë´ãÂÅáË®òÈåÑ
            if (!classesData[currentClassId].leaveHistory) {
                classesData[currentClassId].leaveHistory = [];
            }
            classesData[currentClassId].leaveHistory.push(leaveRecord);
            
            // ÂÑ≤Â≠òË≥áÊñô
            saveCurrentClassData();
            
            // Êõ¥Êñ∞Â∫ß‰ΩçÈ°ØÁ§∫
            initializeSeating();
            
            // Ê∏ÖÁ©∫Ë°®ÂñÆ
            document.getElementById('leaveStudentSelect').value = '';
            document.getElementById('leaveReasonInput').value = '';
            
            // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
            const typeNames = {
                'sick': 'ÁóÖÂÅá',
                'personal': '‰∫ãÂÅá',
                'family': 'ÂÆ∂Â∫≠‰∫ãÂÅá',
                'other': 'ÂÖ∂‰ªñ'
            };
            
            alert(`${studentName} ÁöÑ${typeNames[leaveType]}Â∑≤Ë®≠ÂÆöÂÆåÊàêÔºÅ\nË´ãÂÅáÊó•ÊúüÔºö${leaveDate}\nÂ∫ß‰ΩçÂ∞áÈ°ØÁ§∫ÁÇ∫Ë´ãÂÅáÁãÄÊÖã„ÄÇ`);
            
            // Êõ¥Êñ∞Â≠∏ÁîüÈÅ∏ÊìáÂàóË°®
            updateLeaveStudentSelect();
        }

        // Êõ¥Êñ∞Ë´ãÂÅáÂ≠∏ÁîüÂàóË°®
        function updateOnLeaveStudentsList() {
            const container = document.getElementById('onLeaveStudentsList');
            container.innerHTML = '';
            
            const onLeaveStudents = [];
            for (let i = 0; i < totalSeats; i++) {
                if (students[i] && studentLeaveStatus[i]) {
                    // ÊâæÂà∞ÊúÄÊñ∞ÁöÑË´ãÂÅáË®òÈåÑ
                    const leaveRecord = classesData[currentClassId].leaveHistory
                        .filter(record => record.seatIndex === i && record.status === 'on-leave')
                        .sort((a, b) => new Date(b.leaveTime) - new Date(a.leaveTime))[0];
                    
                    if (leaveRecord) {
                        onLeaveStudents.push({
                            seatIndex: i,
                            studentName: students[i],
                            leaveRecord: leaveRecord
                        });
                    }
                }
            }
            
            if (onLeaveStudents.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #718096;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üòä</div>
                        <div style="font-size: 1.1rem; font-weight: 600;">ÁõÆÂâçÊ≤íÊúâÂ≠∏ÁîüË´ãÂÅá</div>
                        <div style="font-size: 0.9rem; margin-top: 8px;">ÊâÄÊúâÂ≠∏ÁîüÈÉΩÂú®Ê†°‰∏äË™≤</div>
                    </div>
                `;
                return;
            }
            
            onLeaveStudents.forEach(student => {
                const typeNames = {
                    'sick': 'ÁóÖÂÅá ü§í',
                    'personal': '‰∫ãÂÅá üìã',
                    'family': 'ÂÆ∂Â∫≠‰∫ãÂÅá üè†',
                    'other': 'ÂÖ∂‰ªñ üìù'
                };
                
                const leaveItem = document.createElement('div');
                leaveItem.style.cssText = `
                    background: #fbb6ce;
                    border: 2px solid #ed64a6;
                    border-radius: 10px;
                    padding: 15px;
                    margin-bottom: 15px;
                    position: relative;
                `;
                
                leaveItem.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="font-weight: bold; color: #2d3748; margin-bottom: 8px; font-size: 1.1rem;">
                                üè• ${student.studentName} (Â∫ß‰Ωç ${student.seatIndex + 1})
                            </div>
                            <div style="color: #4a5568; font-size: 0.9rem; margin-bottom: 5px;">
                                <strong>Ë´ãÂÅáÈ°ûÂûãÔºö</strong>${typeNames[student.leaveRecord.leaveType]}
                            </div>
                            <div style="color: #4a5568; font-size: 0.9rem; margin-bottom: 5px;">
                                <strong>Ë´ãÂÅáÊó•ÊúüÔºö</strong>${student.leaveRecord.leaveDate}
                            </div>
                            ${student.leaveRecord.leaveReason ? `
                                <div style="color: #4a5568; font-size: 0.9rem; margin-bottom: 5px;">
                                    <strong>Ë´ãÂÅáÂéüÂõ†Ôºö</strong>${student.leaveRecord.leaveReason}
                                </div>
                            ` : ''}
                            <div style="color: #718096; font-size: 0.8rem;">
                                Ë´ãÂÅáÊôÇÈñìÔºö${new Date(student.leaveRecord.leaveTime).toLocaleString()}
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="returnStudentFromLeave(${student.seatIndex})" style="background: #48bb78; border: none; padding: 8px 16px;">
                                ‚úÖ Èä∑ÂÅáËøîÊ†°
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(leaveItem);
            });
        }

        // Â≠∏ÁîüÈä∑ÂÅáËøîÊ†°
        function returnStudentFromLeave(seatIndex) {
            const studentName = students[seatIndex];
            
            if (!confirm(`Á¢∫ÂÆöË¶ÅÁÇ∫ ${studentName} Ëæ¶ÁêÜÈä∑ÂÅáËøîÊ†°ÂóéÔºü`)) {
                return;
            }
            
            // ÂèñÊ∂àË´ãÂÅáÁãÄÊÖã
            studentLeaveStatus[seatIndex] = false;
            
            // Êõ¥Êñ∞Ë´ãÂÅáË®òÈåÑÁãÄÊÖã
            const leaveHistory = classesData[currentClassId].leaveHistory || [];
            for (let i = leaveHistory.length - 1; i >= 0; i--) {
                if (leaveHistory[i].seatIndex === seatIndex && leaveHistory[i].status === 'on-leave') {
                    leaveHistory[i].status = 'returned';
                    leaveHistory[i].returnTime = new Date().toISOString();
                    break;
                }
            }
            
            // Á¢∫‰øùÁè≠Á¥öË≥áÊñôÁµêÊßã‰∏≠ÁöÑË´ãÂÅáÁãÄÊÖãÈô£ÂàóÂ≠òÂú®‰∏¶Êõ¥Êñ∞
            if (!classesData[currentClassId].studentLeaveStatus) {
                classesData[currentClassId].studentLeaveStatus = new Array(totalSeats).fill(false);
            }
            classesData[currentClassId].studentLeaveStatus[seatIndex] = false;
            
            // ÂÑ≤Â≠òÊâÄÊúâË≥áÊñôÂà∞Áè≠Á¥öË≥áÊñôÁµêÊßã
            saveCurrentClassData();
            
            // ÈáçÊñ∞ËºâÂÖ•ÁõÆÂâçÁè≠Á¥öË≥áÊñô‰ª•Á¢∫‰øùÂêåÊ≠•
            loadCurrentClassData();
            
            // ÈáçÊñ∞ÂàùÂßãÂåñÂ∫ß‰ΩçË°®‰ª•Êõ¥Êñ∞ÊâÄÊúâÁãÄÊÖã
            initializeSeating();
            
            // Êõ¥Êñ∞ÂèØÁî®Â≠∏ÁîüÂàóË°®ÔºàÊäΩÁ±§ÂäüËÉΩÔºâ
            if (typeof updateAvailableStudents === 'function') {
                updateAvailableStudents();
            }
            if (typeof updateLotteryStatus === 'function') {
                updateLotteryStatus();
            }
            
            // Êõ¥Êñ∞Ë´ãÂÅáÂ≠∏ÁîüÂàóË°®
            updateOnLeaveStudentsList();
            
            // Â¶ÇÊûúÁõÆÂâçÂú®Ë´ãÂÅáË®òÈåÑÈ†ÅÁ±§Ôºå‰πüË¶ÅÊõ¥Êñ∞
            if (document.getElementById('historyTab').style.display !== 'none') {
                updateLeaveHistoryList();
            }
            
            // Êõ¥Êñ∞Ë´ãÂÅáË®≠ÂÆöÈ†ÅÈù¢ÁöÑÂ≠∏ÁîüÈÅ∏ÊìáÂàóË°®
            if (document.getElementById('leaveTab').style.display !== 'none') {
                updateLeaveStudentSelect();
            }
            
            alert(`${studentName} Â∑≤ÊàêÂäüÈä∑ÂÅáËøîÊ†°ÔºÅ\nÂ∫ß‰ΩçÁãÄÊÖãÂ∑≤ÊÅ¢Âæ©Ê≠£Â∏∏ÔºåÂèØ‰ª•ÈáçÊñ∞ÂèÉËàáÊäΩÁ±§Ê¥ªÂãï„ÄÇ`);
        }

        // Êõ¥Êñ∞Ë´ãÂÅáË®òÈåÑÂàóË°®
        function updateLeaveHistoryList() {
            const container = document.getElementById('leaveHistoryList');
            const leaveHistory = classesData[currentClassId].leaveHistory || [];
            
            // Êõ¥Êñ∞Áµ±Ë®àË≥áË®ä
            const currentLeaveCount = studentLeaveStatus.filter(status => status).length;
            document.getElementById('currentLeaveCount').textContent = currentLeaveCount;
            document.getElementById('totalLeaveRecords').textContent = leaveHistory.length;
            
            container.innerHTML = '';
            
            if (leaveHistory.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #718096;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üìã</div>
                        <div style="font-size: 1.1rem; font-weight: 600;">Êö´ÁÑ°Ë´ãÂÅáË®òÈåÑ</div>
                        <div style="font-size: 0.9rem; margin-top: 8px;">Â≠∏ÁîüÁöÑË´ãÂÅáË®òÈåÑÂ∞áÊúÉÈ°ØÁ§∫Âú®ÈÄôË£°</div>
                    </div>
                `;
                return;
            }
            
            // ÊåâÊôÇÈñìÂÄíÂ∫èÊéíÂàó
            const sortedHistory = [...leaveHistory].sort((a, b) => new Date(b.leaveTime) - new Date(a.leaveTime));
            
            sortedHistory.forEach(record => {
                const typeNames = {
                    'sick': 'ÁóÖÂÅá ü§í',
                    'personal': '‰∫ãÂÅá üìã',
                    'family': 'ÂÆ∂Â∫≠‰∫ãÂÅá üè†',
                    'other': 'ÂÖ∂‰ªñ üìù'
                };
                
                const statusNames = {
                    'on-leave': 'Ë´ãÂÅá‰∏≠',
                    'returned': 'Â∑≤ËøîÊ†°'
                };
                
                const statusColors = {
                    'on-leave': '#fbb6ce',
                    'returned': '#c6f6d5'
                };
                
                const historyItem = document.createElement('div');
                historyItem.style.cssText = `
                    background: ${statusColors[record.status]};
                    border: 2px solid ${record.status === 'on-leave' ? '#ed64a6' : '#48bb78'};
                    border-radius: 10px;
                    padding: 15px;
                    margin-bottom: 10px;
                `;
                
                historyItem.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <div style="font-weight: bold; color: #2d3748; font-size: 1.1rem;">
                            ${record.studentName} (Â∫ß‰Ωç ${record.seatIndex + 1})
                        </div>
                        <div style="background: ${record.status === 'on-leave' ? '#ed64a6' : '#48bb78'}; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">
                            ${statusNames[record.status]}
                        </div>
                    </div>
                    <div style="color: #4a5568; font-size: 0.9rem; margin-bottom: 5px;">
                        <strong>Ë´ãÂÅáÈ°ûÂûãÔºö</strong>${typeNames[record.leaveType]}
                    </div>
                    <div style="color: #4a5568; font-size: 0.9rem; margin-bottom: 5px;">
                        <strong>Ë´ãÂÅáÊó•ÊúüÔºö</strong>${record.leaveDate}
                    </div>
                    ${record.leaveReason ? `
                        <div style="color: #4a5568; font-size: 0.9rem; margin-bottom: 5px;">
                            <strong>Ë´ãÂÅáÂéüÂõ†Ôºö</strong>${record.leaveReason}
                        </div>
                    ` : ''}
                    <div style="color: #718096; font-size: 0.8rem; margin-bottom: 3px;">
                        Ë´ãÂÅáÊôÇÈñìÔºö${new Date(record.leaveTime).toLocaleString()}
                    </div>
                    ${record.returnTime ? `
                        <div style="color: #718096; font-size: 0.8rem;">
                            ËøîÊ†°ÊôÇÈñìÔºö${new Date(record.returnTime).toLocaleString()}
                        </div>
                    ` : ''}
                `;
                
                container.appendChild(historyItem);
            });
        }

        // Ê∏ÖÈô§Ë´ãÂÅáË®òÈåÑ
        function clearLeaveHistory() {
            const leaveHistory = classesData[currentClassId].leaveHistory || [];
            
            if (leaveHistory.length === 0) {
                alert('ÁõÆÂâçÊ≤íÊúâË´ãÂÅáË®òÈåÑÂèØ‰ª•Ê∏ÖÈô§„ÄÇ');
                return;
            }
            
            // ÂàÜÈ°ûË®òÈåÑÔºöË´ãÂÅá‰∏≠ vs Â∑≤Èä∑ÂÅá
            const onLeaveRecords = leaveHistory.filter(record => record.status === 'on-leave');
            const returnedRecords = leaveHistory.filter(record => record.status === 'returned');
            
            if (returnedRecords.length === 0) {
                alert('ÁõÆÂâçÊ≤íÊúâÂ∑≤Èä∑ÂÅáÁöÑË®òÈåÑÂèØ‰ª•Ê∏ÖÈô§„ÄÇ\n\nÊ≥®ÊÑèÔºöÂè™ËÉΩÊ∏ÖÈô§Â∑≤Èä∑ÂÅáÁöÑÊ≠∑Âè≤Ë®òÈåÑÔºåÁõÆÂâçË´ãÂÅá‰∏≠ÁöÑË®òÈåÑ‰∏çÊúÉË¢´Ê∏ÖÈô§„ÄÇ');
                return;
            }
            
            const confirmMessage = `Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§Â∑≤Èä∑ÂÅáÁöÑÊ≠∑Âè≤Ë®òÈåÑÂóéÔºü\n\n‚Ä¢ Â∞áÊ∏ÖÈô§Ôºö${returnedRecords.length} Á≠ÜÂ∑≤Èä∑ÂÅáË®òÈåÑ\n‚Ä¢ ‰øùÁïôÔºö${onLeaveRecords.length} Á≠ÜË´ãÂÅá‰∏≠Ë®òÈåÑ\n\nÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Âè™‰øùÁïôË´ãÂÅá‰∏≠ÁöÑË®òÈåÑÔºåÊ∏ÖÈô§Â∑≤Èä∑ÂÅáÁöÑË®òÈåÑ
            classesData[currentClassId].leaveHistory = onLeaveRecords;
            
            // ÂÑ≤Â≠òË≥áÊñô
            saveCurrentClassData();
            
            // Êõ¥Êñ∞È°ØÁ§∫
            updateLeaveHistoryList();
            
            alert(`Â∑≤Ê∏ÖÈô§ ${returnedRecords.length} Á≠ÜÂ∑≤Èä∑ÂÅáÁöÑÊ≠∑Âè≤Ë®òÈåÑÔºÅ\n\nÁõÆÂâçË´ãÂÅá‰∏≠ÁöÑ ${onLeaveRecords.length} Á≠ÜË®òÈåÑÂ∑≤‰øùÁïô„ÄÇ`);
        }

        // ÂàùÂßãÂåñÊáâÁî®Á®ãÂºè
        function initializeApp() {
            // ÂòóË©¶Âæû localStorage ËºâÂÖ•Ë≥áÊñô
            const hasLocalData = loadFromLocalStorage();
            
            if (hasLocalData) {
                // ËºâÂÖ•ÁõÆÂâçÁè≠Á¥öË≥áÊñô
                loadCurrentClassData();
                console.log('Â∑≤ËºâÂÖ•Êú¨Âú∞ÂÑ≤Â≠òÁöÑË≥áÊñô');
            } else {
                console.log('‰ΩøÁî®È†êË®≠Ë≥áÊñô');
            }
            
            // Êõ¥Êñ∞‰ªãÈù¢
            updateClassSelector();
            initializeSeating();
            
            // È°ØÁ§∫ËºâÂÖ•ÁãÄÊÖã
            if (hasLocalData) {
                const totalStudents = Object.values(classesData)
                    .reduce((total, classData) => total + classData.students.filter(s => s !== null).length, 0);
                
                console.log(`Â∑≤ËºâÂÖ• ${Object.keys(classesData).length} ÂÄãÁè≠Á¥öÔºåÂÖ± ${totalStudents} ‰ΩçÂ≠∏Áîü`);
            }
        }

        // È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // È†ÅÈù¢Âç∏ËºâÂâçËá™ÂãïÂÑ≤Â≠ò
        window.addEventListener('beforeunload', function() {
            saveCurrentClassData();
        });

        // ÂàáÊèõÂäüËÉΩË°®È°ØÁ§∫/Èö±Ëóè
        function toggleControls() {
            const controlsPanel = document.getElementById('controlsPanel');
            const toggleBtn = document.getElementById('toggleControlsBtn');
            
            if (controlsPanel.style.display === 'none') {
                controlsPanel.style.display = 'flex';
                toggleBtn.innerHTML = 'üìã Èö±ËóèÂäüËÉΩË°®';
                toggleBtn.style.background = '#f56565';
            } else {
                controlsPanel.style.display = 'none';
                toggleBtn.innerHTML = 'üìã È°ØÁ§∫ÂäüËÉΩË°®';
                toggleBtn.style.background = '#4a5568';
            }
        }

        // ÂàáÊèõÂÖ®Ëû¢ÂπïÈ°ØÁ§∫
        function toggleFullscreen() {
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            
            if (!document.fullscreenElement) {
                // ÈÄ≤ÂÖ•ÂÖ®Ëû¢Âπï
                document.documentElement.requestFullscreen().then(() => {
                    fullscreenBtn.innerHTML = 'üñ•Ô∏è ÈÄÄÂá∫ÂÖ®Ëû¢Âπï';
                    fullscreenBtn.style.background = '#f56565';
                }).catch(err => {
                    console.error('ÁÑ°Ê≥ïÈÄ≤ÂÖ•ÂÖ®Ëû¢ÂπïÊ®°Âºè:', err);
                    alert('ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ÂÖ®Ëû¢ÂπïÂäüËÉΩÔºåÊàñË¢´ÂÆâÂÖ®Ë®≠ÂÆöÈòªÊìã„ÄÇ');
                });
            } else {
                // ÈÄÄÂá∫ÂÖ®Ëû¢Âπï
                document.exitFullscreen().then(() => {
                    fullscreenBtn.innerHTML = 'üñ•Ô∏è ÂÖ®Ëû¢ÂπïÈ°ØÁ§∫';
                    fullscreenBtn.style.background = '#38a169';
                }).catch(err => {
                    console.error('ÁÑ°Ê≥ïÈÄÄÂá∫ÂÖ®Ëû¢ÂπïÊ®°Âºè:', err);
                });
            }
        }

        // Áõ£ËÅΩÂÖ®Ëû¢ÂπïÁãÄÊÖãËÆäÂåñ
        document.addEventListener('fullscreenchange', function() {
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            
            if (!document.fullscreenElement) {
                // Â∑≤ÈÄÄÂá∫ÂÖ®Ëû¢Âπï
                fullscreenBtn.innerHTML = 'üñ•Ô∏è ÂÖ®Ëû¢ÂπïÈ°ØÁ§∫';
                fullscreenBtn.style.background = '#38a169';
            }
        });

        // ÂÄíÊï∏Ë®àÊôÇÂô®ÂäüËÉΩËÆäÊï∏
        let timerInterval = null;
        let timerTotalSeconds = 0;
        let timerRemainingSeconds = 0;
        let timerIsRunning = false;
        let timerIsPaused = false;

        // È°ØÁ§∫Ë®àÊôÇÂô®Ê®°ÊÖãÊ°Ü
        function showTimerModal() {
            document.getElementById('timerModal').style.display = 'block';
            resetTimer();
        }

        // ÈóúÈñâË®àÊôÇÂô®Ê®°ÊÖãÊ°Ü
        function closeTimerModal() {
            document.getElementById('timerModal').style.display = 'none';
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            timerIsRunning = false;
            timerIsPaused = false;
        }

        // Ë®≠ÂÆöÂø´ÈÄüË®àÊôÇÂô®
        function setQuickTimer(minutes, seconds) {
            document.getElementById('timerMinutes').value = minutes;
            document.getElementById('timerSeconds').value = seconds;
            updateTimerDisplay();
        }

        // Êõ¥Êñ∞Ë®àÊôÇÂô®È°ØÁ§∫
        function updateTimerDisplay() {
            const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
            
            timerTotalSeconds = minutes * 60 + seconds;
            timerRemainingSeconds = timerTotalSeconds;
            
            const displayMinutes = Math.floor(timerRemainingSeconds / 60);
            const displaySeconds = timerRemainingSeconds % 60;
            
            document.getElementById('timerText').textContent = 
                `${displayMinutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
            
            // Êõ¥Êñ∞ÈÄ≤Â∫¶ÂúìÂúà
            updateTimerProgress();
        }

        // Êõ¥Êñ∞Ë®àÊôÇÂô®ÈÄ≤Â∫¶ÂúìÂúà
        function updateTimerProgress() {
            const progressCircle = document.getElementById('timerProgress');
            const timerCircle = document.getElementById('timerCircle');
            
            if (timerTotalSeconds === 0) {
                progressCircle.style.strokeDashoffset = '628.32';
                timerCircle.style.borderColor = '#e2e8f0';
                return;
            }
            
            const progress = (timerTotalSeconds - timerRemainingSeconds) / timerTotalSeconds;
            const offset = 628.32 - (progress * 628.32);
            progressCircle.style.strokeDashoffset = offset;
            
            // Ê†πÊìöÂâ©È§òÊôÇÈñìÊîπËÆäÈ°èËâ≤
            if (timerRemainingSeconds <= 10 && timerRemainingSeconds > 0) {
                progressCircle.style.stroke = '#f56565';
                timerCircle.style.borderColor = '#f56565';
                timerCircle.style.background = 'linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%)';
            } else if (timerRemainingSeconds <= 30) {
                progressCircle.style.stroke = '#ed8936';
                timerCircle.style.borderColor = '#ed8936';
                timerCircle.style.background = 'linear-gradient(135deg, #feebc8 0%, #fbd38d 100%)';
            } else {
                progressCircle.style.stroke = '#667eea';
                timerCircle.style.borderColor = '#667eea';
                timerCircle.style.background = 'linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%)';
            }
        }

        // ÈñãÂßãË®àÊôÇÂô®
        function startTimer() {
            const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
            
            if (minutes === 0 && seconds === 0) {
                alert('Ë´ãË®≠ÂÆöË®àÊôÇÊôÇÈñìÔºÅ');
                return;
            }
            
            timerTotalSeconds = minutes * 60 + seconds;
            timerRemainingSeconds = timerTotalSeconds;
            timerIsRunning = true;
            timerIsPaused = false;
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            document.getElementById('startTimerBtn').style.display = 'none';
            document.getElementById('pauseTimerBtn').style.display = 'inline-block';
            document.getElementById('resumeTimerBtn').style.display = 'none';
            
            // Êõ¥Êñ∞ÁãÄÊÖãÊñáÂ≠ó
            document.getElementById('timerStatus').textContent = 'Ë®àÊôÇÈÄ≤Ë°å‰∏≠...';
            document.getElementById('timerStatus').style.color = '#48bb78';
            
            // ÈñãÂßãÂÄíÊï∏
            timerInterval = setInterval(() => {
                timerRemainingSeconds--;
                
                const displayMinutes = Math.floor(timerRemainingSeconds / 60);
                const displaySeconds = timerRemainingSeconds % 60;
                
                document.getElementById('timerText').textContent = 
                    `${displayMinutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
                
                updateTimerProgress();
                
                // Êí≠ÊîæÊª¥Á≠îËÅ≤ÔºàÂ¶ÇÊûúÂïüÁî®Ôºâ
                if (document.getElementById('timerTickEnabled').checked && timerRemainingSeconds <= 10 && timerRemainingSeconds > 0) {
                    playTimerTickSound();
                }
                
                // Ë®àÊôÇÁµêÊùü
                if (timerRemainingSeconds <= 0) {
                    timerFinished();
                }
            }, 1000);
        }

        // Êö´ÂÅúË®àÊôÇÂô®
        function pauseTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            timerIsPaused = true;
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            document.getElementById('pauseTimerBtn').style.display = 'none';
            document.getElementById('resumeTimerBtn').style.display = 'inline-block';
            
            // Êõ¥Êñ∞ÁãÄÊÖãÊñáÂ≠ó
            document.getElementById('timerStatus').textContent = 'Ë®àÊôÇÂ∑≤Êö´ÂÅú';
            document.getElementById('timerStatus').style.color = '#ed8936';
        }

        // ÁπºÁ∫åË®àÊôÇÂô®
        function resumeTimer() {
            if (timerRemainingSeconds <= 0) return;
            
            timerIsPaused = false;
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            document.getElementById('pauseTimerBtn').style.display = 'inline-block';
            document.getElementById('resumeTimerBtn').style.display = 'none';
            
            // Êõ¥Êñ∞ÁãÄÊÖãÊñáÂ≠ó
            document.getElementById('timerStatus').textContent = 'Ë®àÊôÇÈÄ≤Ë°å‰∏≠...';
            document.getElementById('timerStatus').style.color = '#48bb78';
            
            // ÁπºÁ∫åÂÄíÊï∏
            timerInterval = setInterval(() => {
                timerRemainingSeconds--;
                
                const displayMinutes = Math.floor(timerRemainingSeconds / 60);
                const displaySeconds = timerRemainingSeconds % 60;
                
                document.getElementById('timerText').textContent = 
                    `${displayMinutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
                
                updateTimerProgress();
                
                // Êí≠ÊîæÊª¥Á≠îËÅ≤ÔºàÂ¶ÇÊûúÂïüÁî®Ôºâ
                if (document.getElementById('timerTickEnabled').checked && timerRemainingSeconds <= 10 && timerRemainingSeconds > 0) {
                    playTimerTickSound();
                }
                
                // Ë®àÊôÇÁµêÊùü
                if (timerRemainingSeconds <= 0) {
                    timerFinished();
                }
            }, 1000);
        }

        // ÈáçË®≠Ë®àÊôÇÂô®
        function resetTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            timerIsRunning = false;
            timerIsPaused = false;
            
            // ÈáçË®≠ÊåâÈàïÁãÄÊÖã
            document.getElementById('startTimerBtn').style.display = 'inline-block';
            document.getElementById('pauseTimerBtn').style.display = 'none';
            document.getElementById('resumeTimerBtn').style.display = 'none';
            
            // ÈáçË®≠ÁãÄÊÖãÊñáÂ≠ó
            document.getElementById('timerStatus').textContent = 'Ê∫ñÂÇôÈñãÂßãË®àÊôÇ';
            document.getElementById('timerStatus').style.color = '#718096';
            
            // ÈáçË®≠È°ØÁ§∫
            updateTimerDisplay();
        }

        // Ë®àÊôÇÁµêÊùü
        function timerFinished() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            timerIsRunning = false;
            timerRemainingSeconds = 0;
            
            // Êõ¥Êñ∞È°ØÁ§∫
            document.getElementById('timerText').textContent = '00:00';
            document.getElementById('timerStatus').textContent = '‚è∞ Ë®àÊôÇÁµêÊùüÔºÅ';
            document.getElementById('timerStatus').style.color = '#f56565';
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            document.getElementById('startTimerBtn').style.display = 'inline-block';
            document.getElementById('pauseTimerBtn').style.display = 'none';
            document.getElementById('resumeTimerBtn').style.display = 'none';
            
            // Êí≠ÊîæÁµêÊùüÈü≥Êïà
            if (document.getElementById('timerSoundEnabled').checked) {
                playTimerFinishedSound();
            }
            
            // È°ØÁ§∫ÁµêÊùüÈÄöÁü•
            showTimerFinishedNotification();
            
            // ËÆìÂúìÂúàÈñÉÁàç
            const timerCircle = document.getElementById('timerCircle');
            timerCircle.style.animation = 'timerFinished 1s ease-in-out infinite alternate';
            
            setTimeout(() => {
                timerCircle.style.animation = 'none';
            }, 5000);
        }

        // Êí≠ÊîæË®àÊôÇÂô®Êª¥Á≠îËÅ≤
        function playTimerTickSound() {
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                oscillator.type = 'square';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (error) {
                console.log('Êª¥Á≠îËÅ≤Êí≠ÊîæÂ§±Êïó:', error);
            }
        }

        // Êí≠ÊîæË®àÊôÇÁµêÊùüÈü≥Êïà
        function playTimerFinishedSound() {
            try {
                // Êí≠Êîæ‰∏ÄÈÄ£‰∏≤‰∏äÂçáÈü≥Èöé
                const notes = [523, 659, 784, 1047, 1319]; // C5, E5, G5, C6, E6
                notes.forEach((frequency, index) => {
                    setTimeout(() => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.3);
                    }, index * 150);
                });
            } catch (error) {
                console.log('ÁµêÊùüÈü≥ÊïàÊí≠ÊîæÂ§±Êïó:', error);
            }
        }

        // È°ØÁ§∫Ë®àÊôÇÁµêÊùüÈÄöÁü•
        function showTimerFinishedNotification() {
            // ÂâµÂª∫ÈÄöÁü•ÂÖÉÁ¥†
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
                color: white;
                padding: 30px 40px;
                border-radius: 20px;
                font-size: 2rem;
                font-weight: bold;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                z-index: 3000;
                text-align: center;
                border: 4px solid #c53030;
                animation: timerNotificationPulse 1s ease-in-out infinite alternate;
            `;
            
            notification.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 10px;">‚è∞</div>
                <div>Ë®àÊôÇÁµêÊùüÔºÅ</div>
                <div style="font-size: 1rem; margin-top: 10px; opacity: 0.9;">Time's Up!</div>
            `;
            
            document.body.appendChild(notification);
            
            // 5ÁßíÂæåËá™ÂãïÁßªÈô§
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
            
            // ÈªûÊìäÁßªÈô§
            notification.addEventListener('click', () => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            });
        }

        // Áõ£ËÅΩË®àÊôÇÂô®Ëº∏ÂÖ•ËÆäÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            const minutesInput = document.getElementById('timerMinutes');
            const secondsInput = document.getElementById('timerSeconds');
            
            if (minutesInput && secondsInput) {
                minutesInput.addEventListener('input', updateTimerDisplay);
                secondsInput.addEventListener('input', updateTimerDisplay);
                
                // ÂàùÂßãÂåñÈ°ØÁ§∫
                updateTimerDisplay();
            }
        });

        // ÂàùÂßãÂåñÔºàÂêëÂæåÁõ∏ÂÆπÔºâ
        initializeApp();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9882185f06cd8098',t:'MTc1OTM4NjA0MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
