<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼ç­ç´šåº§ä½è¡¨</title>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #718096;
            font-size: 1.1rem;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .classroom {
            background: #f8fafc;
            border-radius: 15px;
            padding: 30px;
            position: relative;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .teacher-desk {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 30px;
            font-size: 1.1rem;
            width: 100%;
            max-width: 400px;
        }

        .seating-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            width: 100%;
            max-width: none;
            margin: 0 auto;
            justify-content: center;
        }

        .seat {
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        .seat:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .seat.occupied {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border-color: #3182ce;
        }

        .seat.occupied:hover {
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
        }

        .seat.on-leave {
            background: linear-gradient(135deg, #fbb6ce 0%, #f093fb 100%);
            color: #2d3748;
            border-color: #ed64a6;
            position: relative;
        }

        .seat.on-leave:hover {
            background: linear-gradient(135deg, #f093fb 0%, #ed64a6 100%);
        }

        .seat.on-leave::before {
            content: 'ğŸ¥';
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .seat.drag-source {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .seat.drag-over {
            border-color: #48bb78 !important;
            background: #f0fff4 !important;
            transform: scale(1.05);
        }

        .seat.occupied.drag-over {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%) !important;
        }

        .seat.lottery-selected {
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%) !important;
            border: 4px solid #ff6b35 !important;
            color: #2d3748 !important;
            animation: lotteryPulse 1s ease-in-out infinite alternate;
            box-shadow: 0 0 25px rgba(255, 107, 53, 0.8) !important;
        }

        .seat.lottery-current {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%) !important;
            border: 4px solid #ff3838 !important;
            color: white !important;
            animation: currentPulse 1.2s ease-in-out infinite alternate;
            box-shadow: 0 0 30px rgba(255, 56, 56, 1) !important;
            transform: scale(1.05) !important;
        }

        .seat.lottery-previous {
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%) !important;
            border: 3px solid #ff6b35 !important;
            color: #2d3748 !important;
            box-shadow: 0 0 15px rgba(255, 107, 53, 0.5) !important;
            animation: none !important;
        }

        .seat.lottery-animation {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%) !important;
            border: 3px solid #2b6cb0 !important;
            color: white !important;
            animation: lotteryFlash 0.3s ease-in-out;
            box-shadow: 0 0 15px rgba(66, 153, 225, 0.6) !important;
        }

        @keyframes lotteryPulse {
            from {
                transform: scale(1) translateY(-3px);
                box-shadow: 0 8px 25px rgba(255, 107, 53, 0.6);
            }
            to {
                transform: scale(1.05) translateY(-5px);
                box-shadow: 0 12px 30px rgba(255, 107, 53, 1);
            }
        }

        @keyframes currentPulse {
            from {
                transform: scale(1.05) translateY(-3px);
                box-shadow: 0 10px 30px rgba(255, 56, 56, 0.8);
            }
            to {
                transform: scale(1.1) translateY(-6px);
                box-shadow: 0 15px 40px rgba(255, 56, 56, 1);
            }
        }

        @keyframes lotteryFlash {
            0% {
                transform: scale(1);
                box-shadow: 0 0 15px rgba(66, 153, 225, 0.6);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 25px rgba(66, 153, 225, 1);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 15px rgba(66, 153, 225, 0.6);
            }
        }

        @keyframes resultPop {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        @keyframes timerFinished {
            from {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(245, 101, 101, 0.5);
            }
            to {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(245, 101, 101, 1);
            }
        }

        @keyframes timerNotificationPulse {
            from {
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            }
            to {
                transform: translate(-50%, -50%) scale(1.05);
                box-shadow: 0 25px 50px rgba(0,0,0,0.4);
            }
        }

        .drag-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: grab;
        }

        .drag-indicator:active {
            cursor: grabbing;
        }



        .seat-number {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .student-name {
            font-weight: 600;
            font-size: 1rem;
            text-align: center;
        }

        .student-score {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 0.9rem;
        }

        .score-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.2s ease;
            color: #4a5568;
        }

        .score-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        .score-btn.plus:hover {
            background: #48bb78;
            color: white;
        }

        .score-btn.minus:hover {
            background: #f56565;
            color: white;
        }

        .score-display {
            background: rgba(255,255,255,0.9);
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
            color: #2d3748;
        }

        .score-display.negative {
            color: #e53e3e;
            background: rgba(254, 226, 226, 0.9);
        }

        .empty-seat {
            color: #a0aec0;
            font-style: italic;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            min-width: 300px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .stats {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
            text-align: center;
        }

        .stat-item {
            text-align: center;
            padding: 15px 25px;
            background: #f7fafc;
            border-radius: 10px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .seating-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
            }
            
            .seat {
                padding: 15px 10px;
                min-height: 70px;
            }
            
            .container {
                padding: 20px;
            }
            
            .title {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .seating-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">ğŸ« äº’å‹•å¼ç­ç´šåº§ä½è¡¨</h1>
        </div>

        <!-- ç­ç´šé¸æ“‡å€åŸŸ -->
        <div class="class-selector" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 15px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <h3 style="margin: 0; font-size: 1.2rem;">ğŸ« ç›®å‰ç­ç´šï¼š</h3>
                    <select id="classSelector" onchange="switchClass()" style="padding: 10px 15px; border-radius: 8px; border: none; font-size: 1rem; min-width: 150px; font-weight: 600;">
                        <option value="class1">ä¸€å¹´ä¸€ç­</option>
                    </select>
                    <span id="classStats" style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 6px; font-size: 0.9rem;">
                        0 ä½å­¸ç”Ÿ
                    </span>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="showAddClassModal()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                        â• æ–°å¢ç­ç´š
                    </button>
                    <button class="btn" onclick="showManageClassModal()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                        âš™ï¸ ç®¡ç†ç­ç´š
                    </button>
                    <button id="toggleControlsBtn" class="btn" onclick="toggleControls()" style="background: #4a5568; color: white;">
                        ğŸ“‹ é¡¯ç¤ºåŠŸèƒ½è¡¨
                    </button>
                    <button id="fullscreenBtn" class="btn" onclick="toggleFullscreen()" style="background: #38a169; color: white;">
                        ğŸ–¥ï¸ å…¨è¢å¹•é¡¯ç¤º
                    </button>
                </div>
            </div>
        </div>



        <!-- åŠŸèƒ½è¡¨é¢æ¿ -->
        <div class="controls" id="controlsPanel" style="display: none;">
            <button class="btn btn-primary" onclick="showImportModal()">ğŸ“¥ åŒ¯å…¥å­¸ç”Ÿ</button>
            <button class="btn btn-primary" onclick="showLayoutModal()">âš™ï¸ èª¿æ•´é…ç½®</button>
            <button class="btn btn-primary" onclick="showLotteryControls()">ğŸ² æŠ½ç±¤</button>
            <button class="btn btn-primary" onclick="showTimerModal()">â° å€’æ•¸è¨ˆæ™‚</button>
            <button class="btn btn-primary" onclick="showLeaveModal()">ğŸ¥ è«‹å‡</button>
            <button class="btn btn-secondary" onclick="exportData()">ğŸ’¾ åŒ¯å‡ºè³‡æ–™</button>
            <button class="btn btn-secondary" onclick="exportToExcel()">ğŸ“Š åŒ¯å‡ºExcel</button>
            <button class="btn btn-secondary" onclick="showImportDataModal()">ğŸ“‚ åŒ¯å…¥è³‡æ–™</button>

        </div>

        <!-- æŠ½ç±¤æ§åˆ¶é¢æ¿ -->
        <div class="lottery-controls" id="lotteryControls" style="display: none;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; font-size: 1.3rem;">ğŸ² æŠ½ç±¤æ§åˆ¶å°</h3>
                
                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap; justify-content: center;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-weight: 600;">ä¸€æ¬¡æŠ½å–ï¼š</label>
                        <select id="lotteryCount" style="padding: 8px 12px; border-radius: 8px; border: none; font-size: 1rem; min-width: 80px;">
                            <option value="1">1 äºº</option>
                            <option value="2">2 äºº</option>
                            <option value="3">3 äºº</option>
                            <option value="4">4 äºº</option>
                            <option value="5">5 äºº</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-weight: 600;">æŠ½ç±¤æ¨¡å¼ï¼š</label>
                        <select id="lotteryMode" style="padding: 8px 12px; border-radius: 8px; border: none; font-size: 1rem; min-width: 120px;">
                            <option value="continue">é€£çºŒæŠ½ç±¤</option>
                            <option value="reset">é‡è¤‡æŠ½ç±¤</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-weight: 600;">ğŸ”Š éŸ³æ•ˆï¼š</label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="soundEnabled" checked style="transform: scale(1.2);">
                            <span id="soundStatus" style="font-size: 0.9rem;">é–‹å•Ÿ</span>
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="startDirectLottery()" style="background: #48bb78; color: white; border: none;">
                            ğŸ¯ é–‹å§‹æŠ½ç±¤
                        </button>
                        <button class="btn" onclick="resetLottery()" style="background: #f56565; color: white; border: none;">
                            ğŸ”„ é‡è¨­æŠ½ç±¤
                        </button>
                        <button class="btn" onclick="hideLotteryControls()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                            âœ• é—œé–‰
                        </button>
                    </div>
                </div>
                
                <div id="lotteryStatus" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center; font-size: 0.9rem;">
                    <span id="availableStudentsInfo">æº–å‚™å°±ç·’</span>
                </div>
            </div>
        </div>

        <div class="classroom">
            <div class="teacher-desk">
                ğŸ‘©â€ğŸ« è¬›å°å€åŸŸ
            </div>
            
            <div class="seating-grid" id="seatingGrid">
                <!-- åº§ä½å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="occupiedCount">0</div>
                <div class="stat-label">å·²å®‰æ’åº§ä½</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="emptyCount">30</div>
                <div class="stat-label">ç©ºåº§ä½</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalSeatsCount">30</div>
                <div class="stat-label">ç¸½åº§ä½æ•¸</div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯åº§ä½æ¨¡æ…‹æ¡† -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h3 class="modal-title">ç·¨è¼¯åº§ä½è³‡è¨Š</h3>
            <div class="form-group">
                <label class="form-label">å­¸ç”Ÿå§“å</label>
                <input type="text" class="form-input" id="studentNameInput" placeholder="è«‹è¼¸å…¥å­¸ç”Ÿå§“å">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveStudent()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- åŒ¯å…¥å­¸ç”Ÿåå–®æ¨¡æ…‹æ¡† -->
    <div class="modal" id="importModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="modal-title">ğŸ“¥ åŒ¯å…¥å­¸ç”Ÿåå–®</h3>
            <div class="form-group">
                <label class="form-label">è¼¸å…¥æ–¹å¼</label>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-secondary" id="textInputBtn" onclick="switchImportMode('text')" style="flex: 1;">æ‰‹å‹•è¼¸å…¥</button>
                    <button class="btn btn-secondary" id="fileInputBtn" onclick="switchImportMode('file')" style="flex: 1;">æª”æ¡ˆä¸Šå‚³</button>
                </div>
            </div>
            
            <!-- æ‰‹å‹•è¼¸å…¥æ¨¡å¼ -->
            <div id="textInputMode">
                <div class="form-group">
                    <label class="form-label">å­¸ç”Ÿå§“å (æ¯è¡Œä¸€å€‹å§“å)</label>
                    <textarea class="form-input" id="studentListInput" rows="8" placeholder="è«‹è¼¸å…¥å­¸ç”Ÿå§“åï¼Œæ¯è¡Œä¸€å€‹ï¼š&#10;&#10;ç‹å°æ˜&#10;æå°è¯&#10;å¼µå°ç¾&#10;é™³å°å¼·"></textarea>
                </div>
                <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #2c5282;">
                    ğŸ’¡ <strong>ä½¿ç”¨èªªæ˜ï¼š</strong><br>
                    â€¢ æ¯è¡Œè¼¸å…¥ä¸€å€‹å­¸ç”Ÿå§“å<br>
                    â€¢ ç³»çµ±æœƒæŒ‰é †åºåˆ†é…åº§ä½ï¼ˆå¾åº§ä½1é–‹å§‹ï¼‰<br>
                    â€¢ æœ€å¤šæ”¯æ´ <span id="maxStudentsText">30</span> ä½å­¸ç”Ÿ
                </div>
            </div>
            
            <!-- æª”æ¡ˆä¸Šå‚³æ¨¡å¼ -->
            <div id="fileInputMode" style="display: none;">
                <div class="form-group">
                    <label class="form-label">é¸æ“‡æ–‡å­—æª”æ¡ˆ (.txt)</label>
                    <input type="file" class="form-input" id="fileInput" accept=".txt" style="padding: 8px;">
                </div>
                <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #2c5282;">
                    ğŸ’¡ <strong>æª”æ¡ˆæ ¼å¼ï¼š</strong><br>
                    â€¢ ç´”æ–‡å­—æª”æ¡ˆ (.txt)<br>
                    â€¢ æ¯è¡Œä¸€å€‹å­¸ç”Ÿå§“å<br>
                    â€¢ ä½¿ç”¨ UTF-8 ç·¨ç¢¼
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeImportModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="importStudents()">åŒ¯å…¥ä¸¦æŒ‰é †åºæ’åº§ä½</button>
            </div>
        </div>
    </div>

    <!-- åŒ¯å…¥è³‡æ–™æ¨¡æ…‹æ¡† -->
    <div class="modal" id="importDataModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="modal-title">ğŸ“‚ åŒ¯å…¥åº§ä½è³‡æ–™</h3>
            <div class="form-group">
                <label class="form-label">é¸æ“‡è³‡æ–™æª”æ¡ˆ (.json)</label>
                <input type="file" class="form-input" id="dataFileInput" accept=".json" style="padding: 8px;">
            </div>
            <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #2c5282;">
                ğŸ’¡ <strong>åŒ¯å…¥èªªæ˜ï¼š</strong><br>
                â€¢ è«‹é¸æ“‡ä¹‹å‰åŒ¯å‡ºçš„ JSON è³‡æ–™æª”æ¡ˆ<br>
                â€¢ æ”¯æ´å–®ç­ç´šæˆ–å¤šç­ç´šè³‡æ–™æ ¼å¼<br>
                â€¢ å°‡æœƒå®Œæ•´é‚„åŸæ‰€æœ‰ç­ç´šçš„åº§ä½é…ç½®ã€å­¸ç”Ÿå§“åå’Œåˆ†æ•¸<br>
                â€¢ åŒ¯å…¥å¾Œæœƒè¦†è“‹ç›®å‰çš„æ‰€æœ‰ç­ç´šè³‡æ–™
            </div>
            <div id="importDataWarning" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #856404; display: none;">
                âš ï¸ <strong>æ³¨æ„ï¼š</strong>åŒ¯å…¥è³‡æ–™å°‡æœƒè¦†è“‹ç›®å‰æ‰€æœ‰ç­ç´šçš„åº§ä½å®‰æ’å’Œå­¸ç”Ÿè³‡æ–™ï¼
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeImportDataModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="importData()">åŒ¯å…¥è³‡æ–™</button>
            </div>
        </div>
    </div>

    <!-- æŠ½ç±¤æ¨¡æ…‹æ¡† -->
    <div class="modal" id="lotteryModal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <h3 class="modal-title">ğŸ² æŠ½ç±¤é¸å­¸ç”Ÿ</h3>
            
            <div id="lotteryWheel" style="margin: 30px 0;">
                <div id="wheelContainer" style="position: relative; width: 300px; height: 300px; margin: 0 auto; border-radius: 50%; border: 8px solid #667eea; background: conic-gradient(from 0deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57, #ff9ff3, #54a0ff, #5f27cd); animation: none; transition: transform 3s cubic-bezier(0.23, 1, 0.32, 1);">
                    <div id="wheelPointer" style="position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-bottom: 30px solid #2d3748; z-index: 10;"></div>
                    <div id="wheelCenter" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: white; border-radius: 50%; border: 4px solid #667eea; display: flex; align-items: center; justify-content: center; font-size: 24px; z-index: 5;">ğŸ¯</div>
                </div>
            </div>
            
            <div id="lotteryResult" style="margin: 20px 0; min-height: 60px; display: flex; align-items: center; justify-content: center;">
                <div id="resultDisplay" style="font-size: 1.5rem; font-weight: bold; color: #667eea; display: none;">
                    ğŸ‰ æŠ½ä¸­ï¼š<span id="selectedStudent"></span>
                </div>
                <div id="readyMessage" style="color: #718096;">
                    é»æ“Šã€Œé–‹å§‹æŠ½ç±¤ã€ä¾†éš¨æ©Ÿé¸æ“‡ä¸€ä½å­¸ç”Ÿï¼
                </div>
            </div>
            
            <div id="lotteryStats" style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 20px 0; font-size: 0.9rem; color: #2c5282;">
                ğŸ“Š <strong>æŠ½ç±¤è³‡è¨Šï¼š</strong><br>
                â€¢ åƒèˆ‡å­¸ç”Ÿï¼š<span id="lotteryStudentCount">0</span> ä½<br>
                â€¢ æ¯ä½å­¸ç”Ÿä¸­ç±¤æ©Ÿç‡ç›¸ç­‰
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeLotteryModal()">é—œé–‰</button>
                <button class="btn btn-primary" id="lotteryBtn" onclick="spinWheel()">ğŸ² é–‹å§‹æŠ½ç±¤</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ç­ç´šæ¨¡æ…‹æ¡† -->
    <div class="modal" id="addClassModal">
        <div class="modal-content" style="max-width: 400px;">
            <h3 class="modal-title">â• æ–°å¢ç­ç´š</h3>
            <div class="form-group">
                <label class="form-label">ç­ç´šåç¨±</label>
                <input type="text" class="form-input" id="newClassName" placeholder="ä¾‹å¦‚ï¼šäºŒå¹´ä¸‰ç­">
            </div>
            <div class="form-group">
                <label class="form-label">åº§ä½é…ç½®</label>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div style="flex: 1;">
                        <label style="font-size: 0.9rem; color: #718096;">åˆ—æ•¸</label>
                        <input type="number" class="form-input" id="newClassColumns" value="6" min="1" max="10" style="text-align: center;">
                    </div>
                    <div style="flex: 1;">
                        <label style="font-size: 0.9rem; color: #718096;">æ¬„æ•¸</label>
                        <input type="number" class="form-input" id="newClassRows" value="5" min="1" max="10" style="text-align: center;">
                    </div>
                </div>
            </div>
            <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #2c5282;">
                ğŸ’¡ <strong>èªªæ˜ï¼š</strong><br>
                â€¢ æ–°ç­ç´šå°‡ä½¿ç”¨æŒ‡å®šçš„åº§ä½é…ç½®<br>
                â€¢ å¯ä»¥ç¨å¾Œèª¿æ•´åº§ä½é…ç½®å’ŒåŒ¯å…¥å­¸ç”Ÿåå–®<br>
                â€¢ æ¯å€‹ç­ç´šçš„è³‡æ–™éƒ½æœƒç¨ç«‹å„²å­˜
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeAddClassModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createNewClass()">å»ºç«‹ç­ç´š</button>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†ç­ç´šæ¨¡æ…‹æ¡† -->
    <div class="modal" id="manageClassModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="modal-title">âš™ï¸ ç®¡ç†ç­ç´š</h3>
            <div id="classListContainer" style="max-height: 300px; overflow-y: auto;">
                <!-- ç­ç´šåˆ—è¡¨å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin: 20px 0; font-size: 0.9rem; color: #856404;">
                âš ï¸ <strong>æ³¨æ„ï¼š</strong>åˆªé™¤ç­ç´šå°‡æœƒæ°¸ä¹…ç§»é™¤è©²ç­ç´šçš„æ‰€æœ‰å­¸ç”Ÿè³‡æ–™å’Œåº§ä½å®‰æ’ï¼
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeManageClassModal()">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- å­¸ç”Ÿè«‹å‡ç®¡ç†æ¨¡æ…‹æ¡† -->
    <div class="modal" id="leaveModal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 class="modal-title">ğŸ¥ å­¸ç”Ÿè«‹å‡ç®¡ç†</h3>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <button class="btn btn-primary" id="leaveTabBtn" onclick="switchLeaveTab('leave')" style="flex: 1;">è¨­å®šè«‹å‡</button>
                <button class="btn btn-secondary" id="returnTabBtn" onclick="switchLeaveTab('return')" style="flex: 1;">éŠ·å‡è¿”æ ¡</button>
                <button class="btn btn-secondary" id="historyTabBtn" onclick="switchLeaveTab('history')" style="flex: 1;">è«‹å‡è¨˜éŒ„</button>
            </div>
            
            <!-- è¨­å®šè«‹å‡é é¢ -->
            <div id="leaveTab">
                <div class="form-group">
                    <label class="form-label">é¸æ“‡è«‹å‡å­¸ç”Ÿ</label>
                    <select class="form-input" id="leaveStudentSelect">
                        <option value="">è«‹é¸æ“‡å­¸ç”Ÿ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">è«‹å‡é¡å‹</label>
                    <select class="form-input" id="leaveTypeSelect">
                        <option value="sick">ç—…å‡ ğŸ¤’</option>
                        <option value="personal">äº‹å‡ ğŸ“‹</option>
                        <option value="family">å®¶åº­äº‹å‡ ğŸ </option>
                        <option value="other">å…¶ä»– ğŸ“</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">è«‹å‡åŸå›  (é¸å¡«)</label>
                    <textarea class="form-input" id="leaveReasonInput" rows="3" placeholder="è«‹è¼¸å…¥è«‹å‡åŸå› ..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">è«‹å‡æ—¥æœŸ</label>
                    <input type="date" class="form-input" id="leaveDateInput">
                </div>
                
                <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #2c5282;">
                    ğŸ’¡ <strong>èªªæ˜ï¼š</strong><br>
                    â€¢ è¨­å®šè«‹å‡å¾Œï¼Œè©²å­¸ç”Ÿåº§ä½æœƒé¡¯ç¤ºç‚ºç²‰è‰²ä¸¦æ¨™ç¤ºè«‹å‡åœ–ç¤º<br>
                    â€¢ è«‹å‡å­¸ç”Ÿä¸æœƒåƒèˆ‡æŠ½ç±¤æ´»å‹•<br>
                    â€¢ å¯éš¨æ™‚ç‚ºå­¸ç”Ÿè¾¦ç†éŠ·å‡è¿”æ ¡
                </div>
                
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeLeaveModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="setStudentLeave()">ğŸ¥ è¨­å®šè«‹å‡</button>
                </div>
            </div>
            
            <!-- éŠ·å‡è¿”æ ¡é é¢ -->
            <div id="returnTab" style="display: none;">
                <div id="onLeaveStudentsList">
                    <!-- è«‹å‡å­¸ç”Ÿåˆ—è¡¨å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </div>
                
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeLeaveModal()">é—œé–‰</button>
                </div>
            </div>
            
            <!-- è«‹å‡è¨˜éŒ„é é¢ -->
            <div id="historyTab" style="display: none;">
                <div style="max-height: 300px; overflow-y: auto;">
                    <div id="leaveHistoryList">
                        <!-- è«‹å‡è¨˜éŒ„å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin: 20px 0; font-size: 0.9rem; color: #856404;">
                    ğŸ“Š <strong>çµ±è¨ˆè³‡è¨Šï¼š</strong><br>
                    â€¢ ç›®å‰è«‹å‡äººæ•¸ï¼š<span id="currentLeaveCount">0</span> äºº<br>
                    â€¢ æ­·å²è«‹å‡è¨˜éŒ„ï¼š<span id="totalLeaveRecords">0</span> ç­†
                </div>
                
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeLeaveModal()">é—œé–‰</button>
                    <button class="btn btn-secondary" onclick="clearLeaveHistory()">ğŸ—‘ï¸ æ¸…é™¤æ­·å²è¨˜éŒ„</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å€’æ•¸è¨ˆæ™‚å™¨æ¨¡æ…‹æ¡† -->
    <div class="modal" id="timerModal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <h3 class="modal-title">â° å€’æ•¸è¨ˆæ™‚å™¨</h3>
            
            <!-- è¨ˆæ™‚å™¨è¨­å®šå€åŸŸ -->
            <div id="timerSetup" style="margin: 20px 0;">
                <div style="display: flex; gap: 15px; justify-content: center; align-items: center; margin-bottom: 20px;">
                    <div style="text-align: center;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">åˆ†é˜</label>
                        <input type="number" id="timerMinutes" min="0" max="59" value="5" style="width: 60px; padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; text-align: center; font-size: 1.2rem; font-weight: bold;">
                    </div>
                    <div style="font-size: 2rem; color: #667eea; font-weight: bold;">:</div>
                    <div style="text-align: center;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">ç§’é˜</label>
                        <input type="number" id="timerSeconds" min="0" max="59" value="0" style="width: 60px; padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; text-align: center; font-size: 1.2rem; font-weight: bold;">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="setQuickTimer(1, 0)" style="padding: 8px 12px; font-size: 0.9rem;">1åˆ†é˜</button>
                    <button class="btn btn-secondary" onclick="setQuickTimer(3, 0)" style="padding: 8px 12px; font-size: 0.9rem;">3åˆ†é˜</button>
                    <button class="btn btn-secondary" onclick="setQuickTimer(5, 0)" style="padding: 8px 12px; font-size: 0.9rem;">5åˆ†é˜</button>
                    <button class="btn btn-secondary" onclick="setQuickTimer(10, 0)" style="padding: 8px 12px; font-size: 0.9rem;">10åˆ†é˜</button>
                    <button class="btn btn-secondary" onclick="setQuickTimer(0, 30)" style="padding: 8px 12px; font-size: 0.9rem;">30ç§’</button>
                </div>
            </div>
            
            <!-- è¨ˆæ™‚å™¨é¡¯ç¤ºå€åŸŸ -->
            <div id="timerDisplay" style="margin: 30px 0;">
                <div id="timerCircle" style="width: 200px; height: 200px; margin: 0 auto; border-radius: 50%; border: 8px solid #e2e8f0; display: flex; align-items: center; justify-content: center; position: relative; background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); transition: all 0.3s ease;">
                    <div id="timerText" style="font-size: 2.5rem; font-weight: bold; color: #667eea;">05:00</div>
                    <svg style="position: absolute; top: -8px; left: -8px; width: 216px; height: 216px; transform: rotate(-90deg);">
                        <circle id="timerProgress" cx="108" cy="108" r="100" fill="none" stroke="#667eea" stroke-width="8" stroke-dasharray="628.32" stroke-dashoffset="628.32" style="transition: stroke-dashoffset 1s linear;"></circle>
                    </svg>
                </div>
                
                <div id="timerStatus" style="margin-top: 20px; font-size: 1.1rem; color: #718096; font-weight: 600;">
                    æº–å‚™é–‹å§‹è¨ˆæ™‚
                </div>
            </div>
            
            <!-- è¨ˆæ™‚å™¨æ§åˆ¶æŒ‰éˆ• -->
            <div id="timerControls" style="margin: 20px 0;">
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" id="startTimerBtn" onclick="startTimer()" style="background: #48bb78; border: none;">
                        â–¶ï¸ é–‹å§‹è¨ˆæ™‚
                    </button>
                    <button class="btn btn-secondary" id="pauseTimerBtn" onclick="pauseTimer()" style="display: none;">
                        â¸ï¸ æš«åœ
                    </button>
                    <button class="btn btn-secondary" id="resumeTimerBtn" onclick="resumeTimer()" style="display: none;">
                        â–¶ï¸ ç¹¼çºŒ
                    </button>
                    <button class="btn btn-secondary" onclick="resetTimer()">
                        ğŸ”„ é‡è¨­
                    </button>
                </div>
            </div>
            
            <!-- éŸ³æ•ˆè¨­å®š -->
            <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 20px 0; font-size: 0.9rem; color: #2c5282;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="timerSoundEnabled" checked style="transform: scale(1.2);">
                        <span>ğŸ”Š çµæŸæç¤ºéŸ³</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="timerTickEnabled" style="transform: scale(1.2);">
                        <span>â±ï¸ æ»´ç­”è²</span>
                    </label>
                </div>
                <div style="font-size: 0.8rem; color: #4a5568;">
                    ğŸ’¡ è¨ˆæ™‚çµæŸæ™‚æœƒæ’­æ”¾æç¤ºéŸ³ä¸¦é¡¯ç¤ºé€šçŸ¥
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeTimerModal()">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- åº§ä½é…ç½®èª¿æ•´æ¨¡æ…‹æ¡† -->
    <div class="modal" id="layoutModal">
        <div class="modal-content" style="max-width: 400px;">
            <h3 class="modal-title">âš™ï¸ èª¿æ•´åº§ä½é…ç½®</h3>
            
            <div class="form-group">
                <label class="form-label">åˆ—æ•¸ (æ©«å‘åº§ä½æ•¸)</label>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <input type="range" id="columnsSlider" min="1" max="10" value="6" style="flex: 1;" oninput="updateLayoutPreview()">
                    <span id="columnsValue" style="font-weight: bold; color: #667eea; min-width: 30px;">6</span>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">æ¬„æ•¸ (ç¸±å‘åº§ä½æ•¸)</label>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <input type="range" id="rowsSlider" min="1" max="10" value="5" style="flex: 1;" oninput="updateLayoutPreview()">
                    <span id="rowsValue" style="font-weight: bold; color: #667eea; min-width: 30px;">5</span>
                </div>
            </div>
            
            <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #2c5282;">
                ğŸ“Š <strong>é…ç½®é è¦½ï¼š</strong><br>
                â€¢ ç¸½åº§ä½æ•¸ï¼š<span id="totalSeatsPreview" style="font-weight: bold;">30</span> å€‹<br>
                â€¢ é…ç½®ï¼š<span id="layoutPreview" style="font-weight: bold;">6 åˆ— Ã— 5 æ¬„</span><br>
                â€¢ ç¾æœ‰å­¸ç”Ÿï¼š<span id="currentStudentsCount" style="font-weight: bold;">0</span> ä½
            </div>
            
            <div id="layoutWarning" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #856404; display: none;">
                âš ï¸ <strong>æ³¨æ„ï¼š</strong>æ–°é…ç½®çš„åº§ä½æ•¸å°‘æ–¼ç¾æœ‰å­¸ç”Ÿæ•¸ï¼Œéƒ¨åˆ†å­¸ç”Ÿå°‡è¢«ç§»é™¤ï¼
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeLayoutModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="applyLayoutChanges()">å¥—ç”¨é…ç½®</button>
            </div>
        </div>
    </div>

    <script>
        let currentSeatIndex = null;
        let currentClassId = 'class1'; // ç›®å‰é¸ä¸­çš„ç­ç´šID
        
        // å¤šç­ç´šè³‡æ–™çµæ§‹
        let classesData = {
            'class1': {
                name: 'ä¸€å¹´ä¸€ç­',
                columns: 6,
                rows: 5,
                students: new Array(30).fill(null),
                studentScores: new Array(30).fill(0),
                studentLeaveStatus: new Array(30).fill(false), // è«‹å‡ç‹€æ…‹
                leaveHistory: [] // è«‹å‡è¨˜éŒ„
            }
        };
        
        // ç›®å‰ç­ç´šçš„å¿«é€Ÿå­˜å–è®Šæ•¸ï¼ˆç‚ºäº†å‘å¾Œç›¸å®¹ï¼‰
        let columns = 6; // åˆ—æ•¸ (æ©«å‘)
        let rows = 5;    // æ¬„æ•¸ (ç¸±å‘)
        let totalSeats = columns * rows;
        let students = new Array(totalSeats).fill(null);
        let studentScores = new Array(totalSeats).fill(0); // å­¸ç”Ÿåˆ†æ•¸é™£åˆ—
        let studentLeaveStatus = new Array(totalSeats).fill(false); // å­¸ç”Ÿè«‹å‡ç‹€æ…‹é™£åˆ—

        // è¼‰å…¥ç›®å‰ç­ç´šè³‡æ–™åˆ°å¿«é€Ÿå­˜å–è®Šæ•¸
        function loadCurrentClassData() {
            const classData = classesData[currentClassId];
            if (classData) {
                columns = classData.columns;
                rows = classData.rows;
                totalSeats = columns * rows;
                students = [...classData.students];
                studentScores = [...classData.studentScores];
                studentLeaveStatus = [...(classData.studentLeaveStatus || new Array(totalSeats).fill(false))];
                
                // ç¢ºä¿é™£åˆ—é•·åº¦æ­£ç¢º
                while (students.length < totalSeats) students.push(null);
                while (studentScores.length < totalSeats) studentScores.push(0);
                while (studentLeaveStatus.length < totalSeats) studentLeaveStatus.push(false);
                
                // å¦‚æœé™£åˆ—å¤ªé•·ï¼Œæˆªæ–·
                if (students.length > totalSeats) {
                    students = students.slice(0, totalSeats);
                    studentScores = studentScores.slice(0, totalSeats);
                    studentLeaveStatus = studentLeaveStatus.slice(0, totalSeats);
                }
                
                // ç¢ºä¿è«‹å‡è¨˜éŒ„å­˜åœ¨
                if (!classData.leaveHistory) {
                    classData.leaveHistory = [];
                }
            }
        }

        // å„²å­˜ç›®å‰ç­ç´šè³‡æ–™
        function saveCurrentClassData() {
            if (classesData[currentClassId]) {
                classesData[currentClassId].columns = columns;
                classesData[currentClassId].rows = rows;
                classesData[currentClassId].students = [...students];
                classesData[currentClassId].studentScores = [...studentScores];
                classesData[currentClassId].studentLeaveStatus = [...studentLeaveStatus];
                
                // è‡ªå‹•å„²å­˜åˆ° localStorage
                saveToLocalStorage();
            }
        }

        // å„²å­˜è³‡æ–™åˆ° localStorage
        function saveToLocalStorage() {
            try {
                const dataToSave = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    currentClassId: currentClassId,
                    classesData: classesData
                };
                
                localStorage.setItem('seatingArrangementData', JSON.stringify(dataToSave));
                console.log('è³‡æ–™å·²è‡ªå‹•å„²å­˜åˆ°æœ¬åœ°');
            } catch (error) {
                console.error('å„²å­˜åˆ° localStorage å¤±æ•—:', error);
                // å¦‚æœå„²å­˜å¤±æ•—ï¼ˆå¯èƒ½æ˜¯ç©ºé–“ä¸è¶³ï¼‰ï¼Œå˜—è©¦æ¸…ç†èˆŠè³‡æ–™
                if (error.name === 'QuotaExceededError') {
                    alert('æœ¬åœ°å„²å­˜ç©ºé–“ä¸è¶³ï¼Œè«‹åŒ¯å‡ºé‡è¦è³‡æ–™å¾Œæ¸…ç†ç€è¦½å™¨è³‡æ–™ã€‚');
                }
            }
        }

        // å¾ localStorage è¼‰å…¥è³‡æ–™
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('seatingArrangementData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    // æª¢æŸ¥è³‡æ–™ç‰ˆæœ¬
                    if (parsedData.version === '2.0' && parsedData.classesData) {
                        // è¼‰å…¥å¤šç­ç´šè³‡æ–™
                        classesData = { ...parsedData.classesData };
                        currentClassId = parsedData.currentClassId || Object.keys(classesData)[0];
                        
                        // ç¢ºä¿ç›®å‰ç­ç´šIDå­˜åœ¨
                        if (!classesData[currentClassId]) {
                            currentClassId = Object.keys(classesData)[0];
                        }
                        
                        console.log('å·²å¾æœ¬åœ°è¼‰å…¥è³‡æ–™:', Object.keys(classesData).length + ' å€‹ç­ç´š');
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('å¾ localStorage è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                return false;
            }
        }

        // æ¸…é™¤ localStorage è³‡æ–™
        function clearLocalStorage() {
            try {
                localStorage.removeItem('seatingArrangementData');
                console.log('æœ¬åœ°è³‡æ–™å·²æ¸…é™¤');
            } catch (error) {
                console.error('æ¸…é™¤æœ¬åœ°è³‡æ–™å¤±æ•—:', error);
            }
        }

        // æ›´æ–°ç­ç´šé¸æ“‡å™¨
        function updateClassSelector() {
            const selector = document.getElementById('classSelector');
            selector.innerHTML = '';
            
            Object.keys(classesData).forEach(classId => {
                const option = document.createElement('option');
                option.value = classId;
                option.textContent = classesData[classId].name;
                if (classId === currentClassId) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
            
            updateClassStats();
        }

        // æ›´æ–°ç­ç´šçµ±è¨ˆ
        function updateClassStats() {
            const classData = classesData[currentClassId];
            if (classData) {
                const studentCount = classData.students.filter(s => s !== null && s !== undefined && s.trim() !== '').length;
                document.getElementById('classStats').textContent = `${studentCount} ä½å­¸ç”Ÿ`;
            }
        }

        // åˆ‡æ›ç­ç´š
        function switchClass() {
            // å„²å­˜ç›®å‰ç­ç´šè³‡æ–™
            saveCurrentClassData();
            
            // åˆ‡æ›åˆ°æ–°ç­ç´š
            const selector = document.getElementById('classSelector');
            currentClassId = selector.value;
            
            // è¼‰å…¥æ–°ç­ç´šè³‡æ–™
            loadCurrentClassData();
            
            // é‡æ–°åˆå§‹åŒ–åº§ä½è¡¨
            initializeSeating();
            
            // éš±è—æŠ½ç±¤æ§åˆ¶é¢æ¿ï¼ˆå¦‚æœé–‹å•Ÿçš„è©±ï¼‰
            document.getElementById('lotteryControls').style.display = 'none';
            clearAllHighlights();
        }

        // é¡¯ç¤ºæ–°å¢ç­ç´šæ¨¡æ…‹æ¡†
        function showAddClassModal() {
            document.getElementById('addClassModal').style.display = 'block';
            document.getElementById('newClassName').value = '';
            document.getElementById('newClassColumns').value = '6';
            document.getElementById('newClassRows').value = '5';
        }

        // é—œé–‰æ–°å¢ç­ç´šæ¨¡æ…‹æ¡†
        function closeAddClassModal() {
            document.getElementById('addClassModal').style.display = 'none';
        }

        // å»ºç«‹æ–°ç­ç´š
        function createNewClass() {
            const className = document.getElementById('newClassName').value.trim();
            const newColumns = parseInt(document.getElementById('newClassColumns').value);
            const newRows = parseInt(document.getElementById('newClassRows').value);
            
            if (!className) {
                alert('è«‹è¼¸å…¥ç­ç´šåç¨±ï¼');
                return;
            }
            
            // æª¢æŸ¥ç­ç´šåç¨±æ˜¯å¦é‡è¤‡
            const existingNames = Object.values(classesData).map(c => c.name);
            if (existingNames.includes(className)) {
                alert('ç­ç´šåç¨±å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨ä¸åŒçš„åç¨±ï¼');
                return;
            }
            
            // ç”Ÿæˆæ–°çš„ç­ç´šID
            let newClassId = 'class' + (Object.keys(classesData).length + 1);
            while (classesData[newClassId]) {
                newClassId = 'class' + (parseInt(newClassId.replace('class', '')) + 1);
            }
            
            // å»ºç«‹æ–°ç­ç´šè³‡æ–™
            const newTotalSeats = newColumns * newRows;
            classesData[newClassId] = {
                name: className,
                columns: newColumns,
                rows: newRows,
                students: new Array(newTotalSeats).fill(null),
                studentScores: new Array(newTotalSeats).fill(0),
                studentLeaveStatus: new Array(newTotalSeats).fill(false),
                leaveHistory: []
            };
            
            // æ›´æ–°é¸æ“‡å™¨
            updateClassSelector();
            
            // åˆ‡æ›åˆ°æ–°ç­ç´š
            currentClassId = newClassId;
            document.getElementById('classSelector').value = currentClassId;
            loadCurrentClassData();
            initializeSeating();
            
            closeAddClassModal();
            alert(`ç­ç´šã€Œ${className}ã€å»ºç«‹æˆåŠŸï¼\nåº§ä½é…ç½®ï¼š${newColumns} åˆ— Ã— ${newRows} æ¬„ (å…± ${newTotalSeats} å€‹åº§ä½)`);
        }

        // é¡¯ç¤ºç®¡ç†ç­ç´šæ¨¡æ…‹æ¡†
        function showManageClassModal() {
            document.getElementById('manageClassModal').style.display = 'block';
            updateClassList();
        }

        // é—œé–‰ç®¡ç†ç­ç´šæ¨¡æ…‹æ¡†
        function closeManageClassModal() {
            document.getElementById('manageClassModal').style.display = 'none';
        }

        // æ›´æ–°ç­ç´šåˆ—è¡¨
        function updateClassList() {
            const container = document.getElementById('classListContainer');
            container.innerHTML = '';
            
            Object.keys(classesData).forEach(classId => {
                const classData = classesData[classId];
                const studentCount = classData.students.filter(s => s !== null && s !== undefined && s.trim() !== '').length;
                const isCurrentClass = classId === currentClassId;
                
                const classItem = document.createElement('div');
                classItem.style.cssText = `
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 15px;
                    margin-bottom: 10px;
                    background: ${isCurrentClass ? '#e6f3ff' : '#f8fafc'};
                    border: 2px solid ${isCurrentClass ? '#667eea' : '#e2e8f0'};
                    border-radius: 10px;
                `;
                
                classItem.innerHTML = `
                    <div>
                        <div style="font-weight: bold; color: #2d3748; margin-bottom: 5px;">
                            ${classData.name} ${isCurrentClass ? '(ç›®å‰ç­ç´š)' : ''}
                        </div>
                        <div style="font-size: 0.9rem; color: #718096;">
                            ${classData.columns} åˆ— Ã— ${classData.rows} æ¬„ | ${studentCount} ä½å­¸ç”Ÿ
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="renameClass('${classId}')" style="padding: 6px 12px; font-size: 0.8rem;">
                            âœï¸ é‡æ–°å‘½å
                        </button>
                        ${Object.keys(classesData).length > 1 ? `
                            <button class="btn" onclick="deleteClass('${classId}')" style="background: #f56565; color: white; padding: 6px 12px; font-size: 0.8rem; border: none;">
                                ğŸ—‘ï¸ åˆªé™¤
                            </button>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(classItem);
            });
        }

        // é‡æ–°å‘½åç­ç´š
        function renameClass(classId) {
            const classData = classesData[classId];
            const newName = prompt(`è«‹è¼¸å…¥æ–°çš„ç­ç´šåç¨±ï¼š`, classData.name);
            
            if (newName && newName.trim() && newName.trim() !== classData.name) {
                const trimmedName = newName.trim();
                
                // æª¢æŸ¥åç¨±æ˜¯å¦é‡è¤‡
                const existingNames = Object.values(classesData)
                    .filter(c => c !== classData)
                    .map(c => c.name);
                
                if (existingNames.includes(trimmedName)) {
                    alert('ç­ç´šåç¨±å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨ä¸åŒçš„åç¨±ï¼');
                    return;
                }
                
                classData.name = trimmedName;
                updateClassSelector();
                updateClassList();
                alert(`ç­ç´šåç¨±å·²æ›´æ–°ç‚ºã€Œ${trimmedName}ã€`);
            }
        }

        // åˆªé™¤ç­ç´š
        function deleteClass(classId) {
            if (Object.keys(classesData).length <= 1) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹ç­ç´šï¼');
                return;
            }
            
            const classData = classesData[classId];
            const studentCount = classData.students.filter(s => s !== null).length;
            
            const confirmMessage = `ç¢ºå®šè¦åˆªé™¤ç­ç´šã€Œ${classData.name}ã€å—ï¼Ÿ\n\nâ€¢ å°‡æœƒæ°¸ä¹…åˆªé™¤ ${studentCount} ä½å­¸ç”Ÿçš„è³‡æ–™\nâ€¢ æ­¤æ“ä½œç„¡æ³•å¾©åŸ\n\nè«‹è¼¸å…¥ç­ç´šåç¨±ä»¥ç¢ºèªåˆªé™¤ï¼š`;
            
            const confirmation = prompt(confirmMessage);
            if (confirmation === classData.name) {
                delete classesData[classId];
                
                // å¦‚æœåˆªé™¤çš„æ˜¯ç›®å‰ç­ç´šï¼Œåˆ‡æ›åˆ°ç¬¬ä¸€å€‹å¯ç”¨ç­ç´š
                if (classId === currentClassId) {
                    currentClassId = Object.keys(classesData)[0];
                    loadCurrentClassData();
                    initializeSeating();
                }
                
                updateClassSelector();
                updateClassList();
                alert(`ç­ç´šã€Œ${classData.name}ã€å·²åˆªé™¤`);
            } else if (confirmation !== null) {
                alert('ç­ç´šåç¨±ä¸æ­£ç¢ºï¼Œåˆªé™¤æ“ä½œå·²å–æ¶ˆ');
            }
        }

        // åˆå§‹åŒ–åº§ä½è¡¨
        function initializeSeating() {
            const grid = document.getElementById('seatingGrid');
            grid.innerHTML = '';
            
            // æ›´æ–°ç¶²æ ¼æ¨£å¼
            grid.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
            
            for (let i = 0; i < totalSeats; i++) {
                const seat = document.createElement('div');
                seat.className = 'seat';
                seat.onclick = () => editSeat(i);
                seat.dataset.seatIndex = i;
                
                // è¨­å®šæ‹–æ‹‰åŠŸèƒ½
                seat.draggable = true;
                seat.addEventListener('dragstart', handleDragStart);
                seat.addEventListener('dragover', handleDragOver);
                seat.addEventListener('drop', handleDrop);
                seat.addEventListener('dragend', handleDragEnd);
                seat.addEventListener('dragenter', handleDragEnter);
                seat.addEventListener('dragleave', handleDragLeave);
                
                const seatNumber = document.createElement('div');
                seatNumber.className = 'seat-number';
                seatNumber.textContent = `åº§ä½ ${i + 1}`;
                
                const studentName = document.createElement('div');
                studentName.className = 'student-name';
                
                if (students[i]) {
                    if (studentLeaveStatus[i]) {
                        seat.classList.add('on-leave');
                    } else {
                        seat.classList.add('occupied');
                    }
                    studentName.textContent = students[i];
                    
                    // æ–°å¢æ‹–æ‹‰æŒ‡ç¤ºå™¨
                    const dragIndicator = document.createElement('div');
                    dragIndicator.className = 'drag-indicator';
                    dragIndicator.innerHTML = 'â‹®â‹®';
                    dragIndicator.title = 'æ‹–æ‹‰ç§»å‹•å­¸ç”Ÿ';
                    seat.appendChild(dragIndicator);
                    

                    
                    // æ–°å¢åˆ†æ•¸æ§åˆ¶å€åŸŸ
                    const scoreContainer = document.createElement('div');
                    scoreContainer.className = 'student-score';
                    
                    const minusBtn = document.createElement('button');
                    minusBtn.className = 'score-btn minus';
                    minusBtn.innerHTML = 'âˆ’';
                    
                    // å¦‚æœå­¸ç”Ÿè«‹å‡ï¼Œç¦ç”¨æŒ‰éˆ•
                    if (studentLeaveStatus[i]) {
                        minusBtn.disabled = true;
                        minusBtn.style.opacity = '0.3';
                        minusBtn.style.cursor = 'not-allowed';
                        minusBtn.title = 'è«‹å‡å­¸ç”Ÿç„¡æ³•èª¿æ•´åˆ†æ•¸';
                    } else {
                        minusBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            changeScore(i, -1);
                        });
                    }
                    
                    const scoreDisplay = document.createElement('div');
                    const score = studentScores[i] || 0;
                    scoreDisplay.className = score < 0 ? 'score-display negative' : 'score-display';
                    scoreDisplay.textContent = score;
                    scoreDisplay.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                    });
                    
                    const plusBtn = document.createElement('button');
                    plusBtn.className = 'score-btn plus';
                    plusBtn.innerHTML = '+';
                    
                    // å¦‚æœå­¸ç”Ÿè«‹å‡ï¼Œç¦ç”¨æŒ‰éˆ•
                    if (studentLeaveStatus[i]) {
                        plusBtn.disabled = true;
                        plusBtn.style.opacity = '0.3';
                        plusBtn.style.cursor = 'not-allowed';
                        plusBtn.title = 'è«‹å‡å­¸ç”Ÿç„¡æ³•èª¿æ•´åˆ†æ•¸';
                    } else {
                        plusBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            changeScore(i, 1);
                        });
                    }
                    
                    scoreContainer.appendChild(minusBtn);
                    scoreContainer.appendChild(scoreDisplay);
                    scoreContainer.appendChild(plusBtn);
                    
                    seat.appendChild(seatNumber);
                    seat.appendChild(studentName);
                    seat.appendChild(scoreContainer);
                } else {
                    studentName.className += ' empty-seat';
                    studentName.textContent = 'é»æ“Šç·¨è¼¯';
                    seat.appendChild(seatNumber);
                    seat.appendChild(studentName);
                }
                
                grid.appendChild(seat);
            }
            
            updateStats();
        }

        // ç·¨è¼¯åº§ä½
        function editSeat(index) {
            currentSeatIndex = index;
            const modal = document.getElementById('editModal');
            const input = document.getElementById('studentNameInput');
            
            input.value = students[index] || '';
            modal.style.display = 'block';
            input.focus();
        }

        // å„²å­˜å­¸ç”Ÿè³‡è¨Š
        function saveStudent() {
            const input = document.getElementById('studentNameInput');
            const name = input.value.trim();
            
            if (name) {
                students[currentSeatIndex] = name;
                // å¦‚æœæ˜¯æ–°å­¸ç”Ÿï¼Œåˆå§‹åŒ–åˆ†æ•¸ç‚º0
                if (studentScores[currentSeatIndex] === undefined) {
                    studentScores[currentSeatIndex] = 0;
                }
            } else {
                students[currentSeatIndex] = null;
                studentScores[currentSeatIndex] = 0;
            }
            
            // å„²å­˜åˆ°ç­ç´šè³‡æ–™
            saveCurrentClassData();
            
            closeModal();
            initializeSeating();
        }

        // è®Šæ›´å­¸ç”Ÿåˆ†æ•¸
        function changeScore(seatIndex, change) {
            if (students[seatIndex]) {
                studentScores[seatIndex] = (studentScores[seatIndex] || 0) + change;
                // æ›´æ–°é¡¯ç¤º
                const seat = document.querySelector(`[data-seat-index="${seatIndex}"]`);
                const scoreDisplay = seat.querySelector('.score-display');
                if (scoreDisplay) {
                    const score = studentScores[seatIndex];
                    scoreDisplay.textContent = score;
                    scoreDisplay.className = score < 0 ? 'score-display negative' : 'score-display';
                }
                // å„²å­˜åˆ°ç­ç´šè³‡æ–™
                saveCurrentClassData();
            }
        }



        // é—œé–‰æ¨¡æ…‹æ¡†
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            currentSeatIndex = null;
        }

        // éš¨æ©Ÿæ’åº§ä½
        function randomizeSeats() {
            console.log('randomizeSeats å‡½æ•¸è¢«å‘¼å«');
            
            const occupiedStudents = students.filter(student => student !== null);
            console.log('ç¾æœ‰å­¸ç”Ÿ:', occupiedStudents);
            
            if (occupiedStudents.length === 0) {
                alert('è«‹å…ˆæ–°å¢ä¸€äº›å­¸ç”Ÿå†é€²è¡Œéš¨æ©Ÿæ’åº§ä½ï¼');
                return;
            }
            
            // é¡¯ç¤ºç¢ºèªè­¦ç¤ºè¦–çª—
            const confirmMessage = `ç¢ºå®šè¦é‡æ–°éš¨æ©Ÿæ’åˆ—æ‰€æœ‰å­¸ç”Ÿçš„åº§ä½å—ï¼Ÿ\n\nâ€¢ ç›®å‰æœ‰ ${occupiedStudents.length} ä½å­¸ç”Ÿ\nâ€¢ å°‡æœƒå®Œå…¨æ‰“äº‚ç¾æœ‰çš„åº§ä½å®‰æ’\nâ€¢ æ­¤æ“ä½œç„¡æ³•å¾©åŸ\n\né»æ“Šã€Œç¢ºå®šã€ç¹¼çºŒéš¨æ©Ÿæ’åº§ä½`;
            
            if (!confirm(confirmMessage)) {
                console.log('ç”¨æˆ¶å–æ¶ˆéš¨æ©Ÿæ’åº§ä½');
                return;
            }
            
            console.log('é–‹å§‹éš¨æ©Ÿæ’åº§ä½...');
            
            // ä¿å­˜ç¾æœ‰å­¸ç”Ÿçš„åˆ†æ•¸
            const studentScoreMap = {};
            for (let i = 0; i < totalSeats; i++) {
                if (students[i]) {
                    studentScoreMap[students[i]] = studentScores[i] || 0;
                }
            }
            console.log('å­¸ç”Ÿåˆ†æ•¸å°æ‡‰:', studentScoreMap);
            
            // æ¸…ç©ºæ‰€æœ‰åº§ä½
            students.fill(null);
            studentScores.fill(0);
            
            // ä½¿ç”¨ Fisher-Yates æ´—ç‰Œç®—æ³•ä¾†ç¢ºä¿çœŸæ­£çš„éš¨æ©Ÿ
            function shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
            
            // éš¨æ©Ÿåˆ†é…åº§ä½
            const shuffledStudents = shuffleArray(occupiedStudents);
            const availableSeats = shuffleArray(Array.from({length: totalSeats}, (_, i) => i));
            
            console.log('éš¨æ©Ÿå¾Œçš„å­¸ç”Ÿé †åº:', shuffledStudents);
            console.log('éš¨æ©Ÿå¾Œçš„åº§ä½é †åº:', availableSeats.slice(0, shuffledStudents.length));
            
            shuffledStudents.forEach((student, index) => {
                const seatIndex = availableSeats[index];
                students[seatIndex] = student;
                studentScores[seatIndex] = studentScoreMap[student] || 0;
            });
            
            console.log('é‡æ–°åˆ†é…å¾Œçš„åº§ä½:', students);
            
            // é‡æ–°åˆå§‹åŒ–åº§ä½è¡¨
            initializeSeating();
            
            // é¡¯ç¤ºå®Œæˆè¨Šæ¯
            alert(`éš¨æ©Ÿæ’åº§ä½å®Œæˆï¼\nå·²é‡æ–°å®‰æ’ ${occupiedStudents.length} ä½å­¸ç”Ÿçš„åº§ä½ã€‚`);
            console.log('éš¨æ©Ÿæ’åº§ä½å®Œæˆ');
        }

        // æ¸…ç©ºæ‰€æœ‰åº§ä½
        function clearAllSeats() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰åº§ä½å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                students = new Array(totalSeats).fill(null);
                studentScores = new Array(totalSeats).fill(0);
                initializeSeating();
            }
        }

        // åŒ¯å‡ºExcelæª”æ¡ˆ
        function exportToExcel() {
            try {
                // å„²å­˜ç›®å‰ç­ç´šè³‡æ–™
                saveCurrentClassData();
                
                // æº–å‚™Excelè³‡æ–™
                const worksheetData = [];
                
                // æ¨™é¡Œè¡Œ
                worksheetData.push(['æ‰€æœ‰ç­ç´šåº§ä½è¡¨è³‡æ–™', '', '', '', '', '', '']);
                worksheetData.push(['åŒ¯å‡ºæ™‚é–“:', new Date().toLocaleString(), '', '', '', '', '']);
                worksheetData.push(['ç­ç´šæ•¸é‡:', Object.keys(classesData).length + ' å€‹ç­ç´š', '', '', '', '', '']);
                worksheetData.push(['']); // ç©ºè¡Œ
                
                let totalStudentsAllClasses = 0;
                let totalSeatsAllClasses = 0;
                
                // éæ­·æ‰€æœ‰ç­ç´š
                Object.keys(classesData).forEach((classId, classIndex) => {
                    const classData = classesData[classId];
                    const classStudents = classData.students;
                    const classScores = classData.studentScores;
                    const classColumns = classData.columns;
                    const classRows = classData.rows;
                    const classTotalSeats = classColumns * classRows;
                    const classOccupiedCount = classStudents.filter(s => s !== null).length;
                    
                    totalStudentsAllClasses += classOccupiedCount;
                    totalSeatsAllClasses += classTotalSeats;
                    
                    // ç­ç´šæ¨™é¡Œ
                    worksheetData.push([`ã€${classData.name}ã€‘`, '', '', '', '', '', '']);
                    worksheetData.push(['åº§ä½é…ç½®:', `${classColumns} åˆ— Ã— ${classRows} æ¬„ (å…± ${classTotalSeats} å€‹åº§ä½)`, '', '', '', '', '']);
                    worksheetData.push(['å­¸ç”Ÿäººæ•¸:', `${classOccupiedCount} ä½`, '', '', '', '', '']);
                    worksheetData.push(['']); // ç©ºè¡Œ
                    
                    // è¡¨é ­
                    worksheetData.push(['åº§ä½ç·¨è™Ÿ', 'å­¸ç”Ÿå§“å', 'åˆ†æ•¸', 'åˆ—', 'æ¬„', 'ç‹€æ…‹', 'ç­ç´š']);
                    
                    // å­¸ç”Ÿè³‡æ–™
                    for (let i = 0; i < classTotalSeats; i++) {
                        const row = Math.floor(i / classColumns) + 1; // ç¬¬å¹¾æ¬„
                        const col = (i % classColumns) + 1; // ç¬¬å¹¾åˆ—
                        
                        worksheetData.push([
                            i + 1, // åº§ä½ç·¨è™Ÿ
                            classStudents[i] || 'ç©ºåº§ä½', // å­¸ç”Ÿå§“å
                            classStudents[i] ? (classScores[i] || 0) : '', // åˆ†æ•¸
                            col, // åˆ—
                            row, // æ¬„
                            classStudents[i] ? 'å·²å®‰æ’' : 'ç©ºåº§ä½', // ç‹€æ…‹
                            classData.name // ç­ç´š
                        ]);
                    }
                    
                    // ç­ç´šçµ±è¨ˆ
                    const classEmptyCount = classTotalSeats - classOccupiedCount;
                    worksheetData.push(['']); // ç©ºè¡Œ
                    worksheetData.push(['ç­ç´šçµ±è¨ˆ', '', '', '', '', '', '']);
                    worksheetData.push(['å·²å®‰æ’åº§ä½:', classOccupiedCount, '', '', '', '', '']);
                    worksheetData.push(['ç©ºåº§ä½:', classEmptyCount, '', '', '', '', '']);
                    worksheetData.push(['ç¸½åº§ä½æ•¸:', classTotalSeats, '', '', '', '', '']);
                    
                    // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€å€‹ç­ç´šï¼Œæ·»åŠ åˆ†éš”ç·š
                    if (classIndex < Object.keys(classesData).length - 1) {
                        worksheetData.push(['']); // ç©ºè¡Œ
                        worksheetData.push(['='.repeat(50), '', '', '', '', '', '']); // åˆ†éš”ç·š
                        worksheetData.push(['']); // ç©ºè¡Œ
                    }
                });
                
                // ç¸½çµ±è¨ˆè³‡æ–™
                const totalEmptySeats = totalSeatsAllClasses - totalStudentsAllClasses;
                worksheetData.push(['']); // ç©ºè¡Œ
                worksheetData.push(['='.repeat(50), '', '', '', '', '', '']); // åˆ†éš”ç·š
                worksheetData.push(['ç¸½çµ±è¨ˆè³‡æ–™', '', '', '', '', '', '']);
                worksheetData.push(['ç¸½ç­ç´šæ•¸:', Object.keys(classesData).length, '', '', '', '', '']);
                worksheetData.push(['ç¸½å­¸ç”Ÿäººæ•¸:', totalStudentsAllClasses, '', '', '', '', '']);
                worksheetData.push(['ç¸½åº§ä½æ•¸:', totalSeatsAllClasses, '', '', '', '', '']);
                worksheetData.push(['ç¸½ç©ºåº§ä½:', totalEmptySeats, '', '', '', '', '']);
                
                // è½‰æ›ç‚ºCSVæ ¼å¼
                const csvContent = worksheetData.map(row => 
                    row.map(cell => {
                        // è™•ç†åŒ…å«é€—è™Ÿæˆ–å¼•è™Ÿçš„å…§å®¹
                        const cellStr = String(cell || '');
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            return '"' + cellStr.replace(/"/g, '""') + '"';
                        }
                        return cellStr;
                    }).join(',')
                ).join('\n');
                
                // æ·»åŠ BOMä»¥æ”¯æ´ä¸­æ–‡
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csvContent;
                
                // å‰µå»ºä¸‹è¼‰é€£çµ
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                // å‰µå»ºéš±è—çš„ä¸‹è¼‰é€£çµ
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = `æ‰€æœ‰ç­ç´šåº§ä½è¡¨_${new Date().toISOString().split('T')[0]}.csv`;
                downloadLink.style.display = 'none';
                
                // æ·»åŠ åˆ°é é¢ä¸¦è§¸ç™¼ä¸‹è¼‰
                document.body.appendChild(downloadLink);
                downloadLink.click();
                
                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                setTimeout(() => {
                    alert(`æ‰€æœ‰ç­ç´šExcelæª”æ¡ˆå·²æˆåŠŸåŒ¯å‡ºï¼\n\nâ€¢ æª”æ¡ˆæ ¼å¼ï¼šCSV (å¯ç”¨Excelé–‹å•Ÿ)\nâ€¢ ç­ç´šæ•¸é‡ï¼š${Object.keys(classesData).length} å€‹ç­ç´š\nâ€¢ ç¸½å­¸ç”Ÿäººæ•¸ï¼š${totalStudentsAllClasses} ä½\nâ€¢ ç¸½åº§ä½æ•¸ï¼š${totalSeatsAllClasses} å€‹\nâ€¢ æª”æ¡ˆåç¨±ï¼šæ‰€æœ‰ç­ç´šåº§ä½è¡¨_${new Date().toISOString().split('T')[0]}.csv\n\nğŸ“‹ åŒ…å«ç­ç´šï¼š\n${Object.values(classesData).map(c => `â€¢ ${c.name}`).join('\n')}\n\nğŸ’¡ æç¤ºï¼šç”¨Excelé–‹å•ŸCSVæª”æ¡ˆæ™‚ï¼Œè«‹ç¢ºä¿ç·¨ç¢¼è¨­å®šç‚ºUTF-8ä»¥æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡ã€‚`);
                }, 200);
                
            } catch (error) {
                console.error('ExcelåŒ¯å‡ºå¤±æ•—:', error);
                alert('ExcelåŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤è©³æƒ…ï¼š' + error.message);
            }
        }

        // åŒ¯å‡ºè³‡æ–™
        function exportData() {
            try {
                // å„²å­˜ç›®å‰ç­ç´šè³‡æ–™
                saveCurrentClassData();
                
                // è¨ˆç®—æ‰€æœ‰ç­ç´šçš„çµ±è¨ˆè³‡æ–™
                let totalStudents = 0;
                let totalClasses = Object.keys(classesData).length;
                
                Object.values(classesData).forEach(classData => {
                    totalStudents += classData.students.filter(s => s !== null).length;
                });
                
                // æº–å‚™åŒ¯å‡ºçš„è³‡æ–™ï¼ˆåŒ…å«æ‰€æœ‰ç­ç´šï¼‰
                const exportData = {
                    version: '2.0', // ç‰ˆæœ¬å‡ç´šä»¥æ”¯æ´å¤šç­ç´š
                    timestamp: new Date().toISOString(),
                    currentClassId: currentClassId,
                    classesData: classesData,
                    // ç‚ºäº†å‘å¾Œç›¸å®¹ï¼Œä¿ç•™èˆŠæ ¼å¼ï¼ˆç›®å‰ç­ç´šçš„è³‡æ–™ï¼‰
                    seatingConfig: {
                        columns: columns,
                        rows: rows,
                        totalSeats: totalSeats
                    },
                    students: students,
                    studentScores: studentScores
                };
                
                // è½‰æ›ç‚º JSON å­—ä¸²
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // å‰µå»ºä¸‹è¼‰é€£çµ
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                // å‰µå»ºéš±è—çš„ä¸‹è¼‰é€£çµ
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = `æ‰€æœ‰ç­ç´šåº§ä½è³‡æ–™_${new Date().toISOString().split('T')[0]}.json`;
                downloadLink.style.display = 'none';
                
                // æ·»åŠ åˆ°é é¢ä¸¦è§¸ç™¼ä¸‹è¼‰
                document.body.appendChild(downloadLink);
                downloadLink.click();
                
                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                setTimeout(() => {
                    alert(`æ‰€æœ‰ç­ç´šè³‡æ–™å·²æˆåŠŸåŒ¯å‡ºï¼\n\nâ€¢ æª”æ¡ˆæ ¼å¼ï¼šJSON\nâ€¢ ç­ç´šæ•¸é‡ï¼š${totalClasses} å€‹ç­ç´š\nâ€¢ ç¸½å­¸ç”Ÿäººæ•¸ï¼š${totalStudents} ä½\nâ€¢ æª”æ¡ˆåç¨±ï¼šæ‰€æœ‰ç­ç´šåº§ä½è³‡æ–™_${new Date().toISOString().split('T')[0]}.json\n\nğŸ“‹ åŒ…å«ç­ç´šï¼š\n${Object.values(classesData).map(c => `â€¢ ${c.name}`).join('\n')}`);
                }, 200);
                
            } catch (error) {
                console.error('åŒ¯å‡ºå¤±æ•—:', error);
                
                // å‚™ç”¨æ–¹æ¡ˆï¼šé¡¯ç¤ºè³‡æ–™è®“ç”¨æˆ¶æ‰‹å‹•è¤‡è£½
                const exportData = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    currentClassId: currentClassId,
                    classesData: classesData
                };
                
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // é¡¯ç¤ºè¤‡è£½å°è©±æ¡†
                showExportFallback(jsonString);
            }
        }

        // å‚™ç”¨åŒ¯å‡ºæ–¹æ¡ˆ
        function showExportFallback(jsonString) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <h3 class="modal-title">ğŸ’¾ åŒ¯å‡ºåº§ä½è³‡æ–™</h3>
                    <p style="color: #718096; margin-bottom: 15px;">è«‹è¤‡è£½ä»¥ä¸‹å…§å®¹ä¸¦å„²å­˜ç‚º .json æª”æ¡ˆï¼š</p>
                    <textarea id="exportTextarea" style="width: 100%; height: 300px; font-family: monospace; font-size: 12px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; resize: vertical;">${jsonString}</textarea>
                    <div style="margin: 15px 0; padding: 10px; background: #f0f8ff; border-radius: 8px; font-size: 0.9rem; color: #2c5282;">
                        ğŸ’¡ <strong>ä½¿ç”¨èªªæ˜ï¼š</strong><br>
                        1. é»æ“Šã€Œè¤‡è£½åˆ°å‰ªè²¼ç°¿ã€æŒ‰éˆ•<br>
                        2. é–‹å•Ÿæ–‡å­—ç·¨è¼¯å™¨ï¼ˆå¦‚è¨˜äº‹æœ¬ï¼‰<br>
                        3. è²¼ä¸Šå…§å®¹ä¸¦å„²å­˜ç‚º .json æª”æ¡ˆ
                    </div>
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" onclick="document.body.removeChild(this.closest('.modal'))">é—œé–‰</button>
                        <button class="btn btn-primary" onclick="copyExportData()">ğŸ“‹ è¤‡è£½åˆ°å‰ªè²¼ç°¿</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // è‡ªå‹•é¸ä¸­æ–‡å­—
            const textarea = modal.querySelector('#exportTextarea');
            textarea.select();
        }

        // è¤‡è£½åŒ¯å‡ºè³‡æ–™åˆ°å‰ªè²¼ç°¿
        function copyExportData() {
            const textarea = document.getElementById('exportTextarea');
            textarea.select();
            
            try {
                document.execCommand('copy');
                alert('è³‡æ–™å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼è«‹è²¼åˆ°æ–‡å­—ç·¨è¼¯å™¨ä¸­å„²å­˜ç‚º .json æª”æ¡ˆã€‚');
            } catch (error) {
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–ä¸¦è¤‡è£½æ–‡å­—å€åŸŸçš„å…§å®¹ã€‚');
            }
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStats() {
            const occupied = students.filter(student => student !== null && student !== undefined && student.trim() !== '').length;
            const empty = totalSeats - occupied;
            
            document.getElementById('occupiedCount').textContent = occupied;
            document.getElementById('emptyCount').textContent = empty;
            document.getElementById('totalSeatsCount').textContent = totalSeats;
            
            // åŒæ™‚æ›´æ–°ç­ç´šçµ±è¨ˆ
            updateClassStats();
        }

        // é¡¯ç¤ºåŒ¯å…¥æ¨¡æ…‹æ¡†
        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
            switchImportMode('text'); // é è¨­ç‚ºæ‰‹å‹•è¼¸å…¥æ¨¡å¼
        }

        // é—œé–‰åŒ¯å…¥æ¨¡æ…‹æ¡†
        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('studentListInput').value = '';
            document.getElementById('fileInput').value = '';
        }

        // åˆ‡æ›åŒ¯å…¥æ¨¡å¼
        function switchImportMode(mode) {
            const textMode = document.getElementById('textInputMode');
            const fileMode = document.getElementById('fileInputMode');
            const textBtn = document.getElementById('textInputBtn');
            const fileBtn = document.getElementById('fileInputBtn');

            if (mode === 'text') {
                textMode.style.display = 'block';
                fileMode.style.display = 'none';
                textBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                textBtn.style.color = 'white';
                fileBtn.style.background = '#f7fafc';
                fileBtn.style.color = '#4a5568';
            } else {
                textMode.style.display = 'none';
                fileMode.style.display = 'block';
                fileBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                fileBtn.style.color = 'white';
                textBtn.style.background = '#f7fafc';
                textBtn.style.color = '#4a5568';
            }
        }

        // åŒ¯å…¥å­¸ç”Ÿåå–®
        function importStudents() {
            const textMode = document.getElementById('textInputMode').style.display !== 'none';
            let studentNames = [];

            if (textMode) {
                // æ‰‹å‹•è¼¸å…¥æ¨¡å¼
                const input = document.getElementById('studentListInput').value.trim();
                if (!input) {
                    alert('è«‹è¼¸å…¥å­¸ç”Ÿå§“åï¼');
                    return;
                }
                studentNames = input.split('\n')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);
            } else {
                // æª”æ¡ˆä¸Šå‚³æ¨¡å¼
                const fileInput = document.getElementById('fileInput');
                if (!fileInput.files[0]) {
                    alert('è«‹é¸æ“‡ä¸€å€‹æ–‡å­—æª”æ¡ˆï¼');
                    return;
                }

                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const content = e.target.result;
                    studentNames = content.split('\n')
                        .map(name => name.trim())
                        .filter(name => name.length > 0);
                    
                    processImportedStudents(studentNames);
                };
                
                reader.readAsText(file, 'UTF-8');
                return; // ç­‰å¾…æª”æ¡ˆè®€å–å®Œæˆ
            }

            processImportedStudents(studentNames);
        }

        // è™•ç†åŒ¯å…¥çš„å­¸ç”Ÿåå–®
        function processImportedStudents(studentNames) {
            if (studentNames.length === 0) {
                alert('æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å­¸ç”Ÿå§“åï¼');
                return;
            }

            if (studentNames.length > totalSeats) {
                alert(`å­¸ç”Ÿäººæ•¸è¶…éåº§ä½æ•¸é‡ï¼å°‡åªåŒ¯å…¥å‰ ${totalSeats} ä½å­¸ç”Ÿã€‚\nï¼ˆå…± ${studentNames.length} ä½å­¸ç”Ÿï¼‰`);
                studentNames = studentNames.slice(0, totalSeats);
            }

            // æ¸…ç©ºç¾æœ‰åº§ä½å’Œåˆ†æ•¸
            students = new Array(totalSeats).fill(null);
            studentScores = new Array(totalSeats).fill(0);

            // æŒ‰é †åºåˆ†é…åº§ä½ï¼ˆå¾åº§ä½1é–‹å§‹ï¼‰
            studentNames.forEach((name, index) => {
                students[index] = name;
                studentScores[index] = 0; // åˆå§‹åŒ–åˆ†æ•¸ç‚º0
            });

            // å„²å­˜åˆ°ç­ç´šè³‡æ–™
            saveCurrentClassData();

            closeImportModal();
            initializeSeating();
            
            alert(`æˆåŠŸåŒ¯å…¥ ${studentNames.length} ä½å­¸ç”Ÿä¸¦æŒ‰é †åºåˆ†é…åº§ä½ï¼`);
        }

        // é¡¯ç¤ºåº§ä½é…ç½®æ¨¡æ…‹æ¡†
        function showLayoutModal() {
            document.getElementById('layoutModal').style.display = 'block';
            document.getElementById('columnsSlider').value = columns;
            document.getElementById('rowsSlider').value = rows;
            updateLayoutPreview();
        }

        // é—œé–‰åº§ä½é…ç½®æ¨¡æ…‹æ¡†
        function closeLayoutModal() {
            document.getElementById('layoutModal').style.display = 'none';
        }

        // æ›´æ–°é…ç½®é è¦½
        function updateLayoutPreview() {
            const newColumns = parseInt(document.getElementById('columnsSlider').value);
            const newRows = parseInt(document.getElementById('rowsSlider').value);
            const newTotalSeats = newColumns * newRows;
            const currentStudents = students.filter(s => s !== null).length;

            document.getElementById('columnsValue').textContent = newColumns;
            document.getElementById('rowsValue').textContent = newRows;
            document.getElementById('totalSeatsPreview').textContent = newTotalSeats;
            document.getElementById('layoutPreview').textContent = `${newColumns} åˆ— Ã— ${newRows} æ¬„`;
            document.getElementById('currentStudentsCount').textContent = currentStudents;
            document.getElementById('maxStudentsText').textContent = newTotalSeats;

            // é¡¯ç¤ºè­¦å‘Š
            const warning = document.getElementById('layoutWarning');
            if (newTotalSeats < currentStudents) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }

        // å¥—ç”¨é…ç½®è®Šæ›´
        function applyLayoutChanges() {
            const newColumns = parseInt(document.getElementById('columnsSlider').value);
            const newRows = parseInt(document.getElementById('rowsSlider').value);
            const newTotalSeats = newColumns * newRows;
            
            // æ”¶é›†ç¾æœ‰å­¸ç”Ÿè³‡æ–™ï¼ˆæŒ‰åº§ä½é †åºï¼‰
            const currentStudentData = [];
            for (let i = 0; i < totalSeats; i++) {
                if (students[i]) {
                    currentStudentData.push({
                        name: students[i],
                        score: studentScores[i] || 0,
                        originalSeat: i + 1
                    });
                }
            }

            let removedStudents = [];
            if (newTotalSeats < currentStudentData.length) {
                // è¨ˆç®—è¦åˆªé™¤çš„å­¸ç”Ÿï¼ˆå¾æœ€å¾Œé¢é–‹å§‹åˆªé™¤ï¼‰
                removedStudents = currentStudentData.slice(newTotalSeats);
                const removedNames = removedStudents.map(s => `${s.name} (åŸåº§ä½${s.originalSeat})`).join('ã€');
                
                if (!confirm(`æ–°é…ç½®åªæœ‰ ${newTotalSeats} å€‹åº§ä½ï¼Œä½†ç›®å‰æœ‰ ${currentStudentData.length} ä½å­¸ç”Ÿã€‚\n\nå°‡åˆªé™¤ä»¥ä¸‹å­¸ç”Ÿï¼š\n${removedNames}\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`)) {
                    return;
                }
            }

            // æ›´æ–°é…ç½®
            columns = newColumns;
            rows = newRows;
            totalSeats = newTotalSeats;

            // é‡æ–°åˆ†é…å­¸ç”Ÿï¼ˆæŒ‰é †åºæ’åˆ—ï¼Œåªä¿ç•™å‰é¢çš„å­¸ç”Ÿï¼‰
            const newStudents = new Array(totalSeats).fill(null);
            const newStudentScores = new Array(totalSeats).fill(0);
            const studentsToKeep = currentStudentData.slice(0, newTotalSeats);
            
            // æŒ‰é †åºåˆ†é…å­¸ç”Ÿåˆ°æ–°åº§ä½ï¼ˆå¾åº§ä½1é–‹å§‹ï¼‰
            studentsToKeep.forEach((studentData, index) => {
                newStudents[index] = studentData.name;
                newStudentScores[index] = studentData.score;
            });

            students = newStudents;
            studentScores = newStudentScores;
            
            // å„²å­˜åˆ°ç­ç´šè³‡æ–™
            saveCurrentClassData();
            
            closeLayoutModal();
            initializeSeating();

            let message = `åº§ä½é…ç½®å·²æ›´æ–°ç‚º ${columns} åˆ— Ã— ${rows} æ¬„ (å…± ${totalSeats} å€‹åº§ä½)\nå­¸ç”Ÿå·²æŒ‰åŸé †åºé‡æ–°æ’åˆ—`;
            if (removedStudents.length > 0) {
                message += `\n\nå·²åˆªé™¤ ${removedStudents.length} ä½å­¸ç”Ÿï¼š\n${removedStudents.map(s => s.name).join('ã€')}`;
            }
            
            alert(message);
        }

        // é¡¯ç¤ºåŒ¯å…¥è³‡æ–™æ¨¡æ…‹æ¡†
        function showImportDataModal() {
            document.getElementById('importDataModal').style.display = 'block';
            document.getElementById('dataFileInput').value = '';
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•ç­ç´šæœ‰è³‡æ–™ï¼Œé¡¯ç¤ºè­¦å‘Š
            let hasData = false;
            Object.values(classesData).forEach(classData => {
                if (classData.students.some(student => student !== null)) {
                    hasData = true;
                }
            });
            
            const warning = document.getElementById('importDataWarning');
            if (hasData) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }

        // é—œé–‰åŒ¯å…¥è³‡æ–™æ¨¡æ…‹æ¡†
        function closeImportDataModal() {
            document.getElementById('importDataModal').style.display = 'none';
            document.getElementById('dataFileInput').value = '';
        }

        // åŒ¯å…¥è³‡æ–™
        function importData() {
            const fileInput = document.getElementById('dataFileInput');
            if (!fileInput.files[0]) {
                alert('è«‹é¸æ“‡ä¸€å€‹ JSON è³‡æ–™æª”æ¡ˆï¼');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°ç‰ˆæœ¬ï¼ˆå¤šç­ç´šï¼‰æ ¼å¼
                    if (importedData.version === '2.0' && importedData.classesData) {
                        // æ–°ç‰ˆæœ¬å¤šç­ç´šæ ¼å¼
                        const classCount = Object.keys(importedData.classesData).length;
                        const totalStudents = Object.values(importedData.classesData)
                            .reduce((total, classData) => total + classData.students.filter(s => s !== null).length, 0);
                        
                        if (!confirm(`å³å°‡åŒ¯å…¥å¤šç­ç´šè³‡æ–™ï¼š\nâ€¢ ${classCount} å€‹ç­ç´š\nâ€¢ ç¸½å…± ${totalStudents} ä½å­¸ç”Ÿ\n\né€™å°‡æœƒè¦†è“‹ç›®å‰æ‰€æœ‰çš„ç­ç´šå’Œå­¸ç”Ÿè³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`)) {
                            return;
                        }
                        
                        // åŒ¯å…¥æ‰€æœ‰ç­ç´šè³‡æ–™
                        classesData = { ...importedData.classesData };
                        currentClassId = importedData.currentClassId || Object.keys(classesData)[0];
                        
                        // è¼‰å…¥ç›®å‰ç­ç´šè³‡æ–™
                        loadCurrentClassData();
                        
                        // æ›´æ–°ä»‹é¢
                        updateClassSelector();
                        initializeSeating();
                        
                        // è‡ªå‹•å„²å­˜åˆ° localStorage
                        saveToLocalStorage();
                        
                        alert(`å¤šç­ç´šè³‡æ–™åŒ¯å…¥æˆåŠŸï¼\nâ€¢ åŒ¯å…¥ç­ç´šæ•¸ï¼š${classCount} å€‹\nâ€¢ ç¸½å­¸ç”Ÿäººæ•¸ï¼š${totalStudents} ä½\nâ€¢ ç›®å‰ç­ç´šï¼š${classesData[currentClassId].name}\nâ€¢ è³‡æ–™å·²è‡ªå‹•å„²å­˜åˆ°æœ¬åœ°`);
                        
                    } else if (importedData.seatingConfig && importedData.students && importedData.studentScores) {
                        // èˆŠç‰ˆæœ¬å–®ç­ç´šæ ¼å¼
                        const importedStudents = importedData.students.filter(s => s !== null).length;
                        
                        if (!confirm(`å³å°‡åŒ¯å…¥å–®ç­ç´šè³‡æ–™ï¼š\nâ€¢ 1 å€‹ç­ç´š\nâ€¢ ${importedStudents} ä½å­¸ç”Ÿ\n\né€™å°‡æœƒè¦†è“‹ç›®å‰ç­ç´šçš„åº§ä½å®‰æ’å’Œå­¸ç”Ÿè³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`)) {
                            return;
                        }
                        
                        // åŒ¯å…¥åˆ°ç›®å‰ç­ç´š
                        columns = importedData.seatingConfig.columns;
                        rows = importedData.seatingConfig.rows;
                        totalSeats = importedData.seatingConfig.totalSeats;
                        
                        students = [...importedData.students];
                        studentScores = [...importedData.studentScores];
                        
                        // ç¢ºä¿é™£åˆ—é•·åº¦æ­£ç¢º
                        while (students.length < totalSeats) students.push(null);
                        while (studentScores.length < totalSeats) studentScores.push(0);
                        
                        // å„²å­˜åˆ°ç­ç´šè³‡æ–™
                        saveCurrentClassData();
                        
                        // æ›´æ–°ä»‹é¢
                        updateClassSelector();
                        initializeSeating();
                        
                        // è‡ªå‹•å„²å­˜åˆ° localStorage
                        saveToLocalStorage();
                        
                        alert(`è³‡æ–™åŒ¯å…¥æˆåŠŸï¼\nâ€¢ åº§ä½é…ç½®ï¼š${columns} åˆ— Ã— ${rows} æ¬„\nâ€¢ å­¸ç”Ÿäººæ•¸ï¼š${importedStudents} ä½\nâ€¢ åŒ¯å…¥æ™‚é–“ï¼š${importedData.timestamp ? new Date(importedData.timestamp).toLocaleString() : 'æœªçŸ¥'}\nâ€¢ è³‡æ–™å·²è‡ªå‹•å„²å­˜åˆ°æœ¬åœ°`);
                        
                    } else {
                        throw new Error('ä¸æ”¯æ´çš„è³‡æ–™æ ¼å¼');
                    }
                    
                    closeImportDataModal();
                    
                } catch (error) {
                    alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤æˆ–è³‡æ–™æå£ï¼Œè«‹ç¢ºèªé¸æ“‡çš„æ˜¯æ­£ç¢ºçš„åº§ä½è³‡æ–™æª”æ¡ˆï¼\néŒ¯èª¤è©³æƒ…ï¼š' + error.message);
                }
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        // æŠ½ç±¤åŠŸèƒ½è®Šæ•¸
        let isSpinning = false;
        let availableStudents = [];
        let selectedStudents = []; // å·²æŠ½ä¸­çš„å­¸ç”Ÿ
        let lotteryHistory = []; // æŠ½ç±¤æ­·å²

        // éŸ³æ•ˆåŠŸèƒ½
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // æª¢æŸ¥éŸ³æ•ˆæ˜¯å¦é–‹å•Ÿ
        function isSoundEnabled() {
            const soundCheckbox = document.getElementById('soundEnabled');
            return soundCheckbox && soundCheckbox.checked;
        }

        // å‰µå»ºä¸åŒé »ç‡çš„éŸ³æ•ˆ
        function playSound(frequency, duration, type = 'sine') {
            if (!isSoundEnabled()) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (error) {
                console.log('éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', error);
            }
        }

        // æ’­æ”¾æŠ½ç±¤å‹•ç•«éŸ³æ•ˆï¼ˆå¿«é€Ÿå—¶å—¶è²ï¼‰
        function playLotteryTickSound() {
            playSound(800, 0.1, 'square');
        }

        // æ’­æ”¾çµæœéŸ³æ•ˆï¼ˆæˆåŠŸéŸ³æ•ˆï¼‰
        function playResultSound() {
            if (!isSoundEnabled()) return;
            // æ’­æ”¾ä¸€å€‹ä¸Šå‡çš„éŸ³éš
            setTimeout(() => playSound(523, 0.2), 0);    // C5
            setTimeout(() => playSound(659, 0.2), 100);  // E5
            setTimeout(() => playSound(784, 0.3), 200);  // G5
            setTimeout(() => playSound(1047, 0.4), 300); // C6
        }

        // æ’­æ”¾é‡è¨­éŸ³æ•ˆ
        function playResetSound() {
            playSound(400, 0.3, 'sawtooth');
        }

        // é¡¯ç¤ºæŠ½ç±¤æ§åˆ¶é¢æ¿
        function showLotteryControls() {
            // ç²å–æ‰€æœ‰æœ‰å­¸ç”Ÿçš„åº§ä½
            updateAvailableStudents();
            
            if (availableStudents.length === 0) {
                alert('ç›®å‰æ²’æœ‰å­¸ç”Ÿå¯ä»¥æŠ½ç±¤ï¼è«‹å…ˆæ–°å¢ä¸€äº›å­¸ç”Ÿã€‚');
                return;
            }

            document.getElementById('lotteryControls').style.display = 'block';
            updateLotteryStatus();
        }

        // éš±è—æŠ½ç±¤æ§åˆ¶é¢æ¿
        function hideLotteryControls() {
            document.getElementById('lotteryControls').style.display = 'none';
            // æ¸…é™¤æ‰€æœ‰é«˜äº®
            clearAllHighlights();
        }

        // æ›´æ–°å¯ç”¨å­¸ç”Ÿåˆ—è¡¨
        function updateAvailableStudents() {
            const mode = document.getElementById('lotteryMode').value;
            
            if (mode === 'reset') {
                // é‡è¤‡æŠ½ç±¤æ¨¡å¼ï¼šæ‰€æœ‰å­¸ç”Ÿéƒ½å¯ä»¥è¢«æŠ½åˆ°ï¼ˆæ’é™¤è«‹å‡å­¸ç”Ÿï¼‰
                availableStudents = [];
                for (let i = 0; i < totalSeats; i++) {
                    if (students[i] && !studentLeaveStatus[i]) {
                        availableStudents.push({
                            name: students[i],
                            seatIndex: i
                        });
                    }
                }
            } else {
                // é€£çºŒæŠ½ç±¤æ¨¡å¼ï¼šæ’é™¤å·²æŠ½ä¸­çš„å­¸ç”Ÿå’Œè«‹å‡å­¸ç”Ÿ
                availableStudents = [];
                for (let i = 0; i < totalSeats; i++) {
                    if (students[i] && !selectedStudents.includes(i) && !studentLeaveStatus[i]) {
                        availableStudents.push({
                            name: students[i],
                            seatIndex: i
                        });
                    }
                }
            }
        }

        // æ›´æ–°æŠ½ç±¤ç‹€æ…‹é¡¯ç¤º
        function updateLotteryStatus() {
            const mode = document.getElementById('lotteryMode').value;
            const totalStudents = students.filter(s => s !== null).length;
            const selectedCount = selectedStudents.length;
            const availableCount = availableStudents.length;
            
            let statusText = '';
            if (mode === 'reset') {
                statusText = `ç¸½å­¸ç”Ÿï¼š${totalStudents} äºº | æ¯æ¬¡éƒ½å¾å…¨éƒ¨å­¸ç”Ÿä¸­æŠ½å–`;
            } else {
                statusText = `ç¸½å­¸ç”Ÿï¼š${totalStudents} äºº | å·²æŠ½ä¸­ï¼š${selectedCount} äºº | å‰©é¤˜ï¼š${availableCount} äºº`;
            }
            
            document.getElementById('availableStudentsInfo').textContent = statusText;
        }

        // é–‹å§‹ç›´æ¥æŠ½ç±¤
        function startDirectLottery() {
            updateAvailableStudents();
            
            if (availableStudents.length === 0) {
                alert('æ²’æœ‰å¯æŠ½ç±¤çš„å­¸ç”Ÿäº†ï¼è«‹é‡è¨­æŠ½ç±¤æˆ–åˆ‡æ›åˆ°é‡è¤‡æŠ½ç±¤æ¨¡å¼ã€‚');
                return;
            }

            const count = parseInt(document.getElementById('lotteryCount').value);
            const actualCount = Math.min(count, availableStudents.length);
            
            if (actualCount < count) {
                if (!confirm(`å‰©é¤˜å­¸ç”Ÿä¸è¶³ ${count} äººï¼Œå°‡æŠ½å– ${actualCount} äººï¼Œç¢ºå®šç¹¼çºŒå—ï¼Ÿ`)) {
                    return;
                }
            }

            const mode = document.getElementById('lotteryMode').value;
            
            // æ ¹æ“šæ¨¡å¼æ±ºå®šæ˜¯å¦æ¸…é™¤ä¹‹å‰çš„é«˜äº®
            if (mode === 'reset') {
                // é‡è¤‡æŠ½ç±¤æ¨¡å¼ï¼šæ¸…é™¤æ‰€æœ‰é«˜äº®
                clearAllHighlights();
            } else {
                // é€£çºŒæŠ½ç±¤æ¨¡å¼ï¼šåªæ¸…é™¤å‹•ç•«é«˜äº®ï¼Œä¿ç•™å·²é¸ä¸­çš„
                clearAnimationHighlights();
            }

            // éš¨æ©Ÿé¸æ“‡å­¸ç”Ÿ
            const selectedInThisRound = [];
            const shuffled = [...availableStudents].sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < actualCount; i++) {
                selectedInThisRound.push(shuffled[i]);
            }

            // é¡¯ç¤ºæŠ½ç±¤å‹•ç•«
            showLotteryAnimation(selectedInThisRound);
        }

        // é¡¯ç¤ºæŠ½ç±¤å‹•ç•«
        function showLotteryAnimation(selectedInThisRound) {
            const seats = document.querySelectorAll('.seat');
            let animationStep = 0;
            const maxSteps = 20; // å‹•ç•«æ­¥æ•¸
            
            const animationInterval = setInterval(() => {
                // æ¸…é™¤ä¹‹å‰çš„è‡¨æ™‚é«˜äº®ï¼ˆä½†ä¿ç•™å·²é¸ä¸­çš„ï¼‰
                seats.forEach(seat => {
                    if (!seat.classList.contains('lottery-selected')) {
                        seat.classList.remove('lottery-animation');
                    }
                });
                
                if (animationStep < maxSteps) {
                    // æ’­æ”¾æŠ½ç±¤éŸ³æ•ˆ
                    playLotteryTickSound();
                    
                    // éš¨æ©Ÿé«˜äº®ä¸€äº›åº§ä½ï¼ˆæ’é™¤å·²é¸ä¸­çš„ï¼‰
                    const randomSeats = [...seats]
                        .filter(seat => {
                            const seatIndex = parseInt(seat.dataset.seatIndex);
                            return students[seatIndex] && !seat.classList.contains('lottery-selected');
                        })
                        .sort(() => Math.random() - 0.5)
                        .slice(0, selectedInThisRound.length);
                    
                    randomSeats.forEach(seat => {
                        seat.classList.add('lottery-animation');
                    });
                    
                    animationStep++;
                } else {
                    // å‹•ç•«çµæŸï¼Œé¡¯ç¤ºæœ€çµ‚çµæœ
                    clearInterval(animationInterval);
                    showFinalLotteryResult(selectedInThisRound);
                }
            }, 100);
        }

        // é¡¯ç¤ºæœ€çµ‚æŠ½ç±¤çµæœ
        function showFinalLotteryResult(selectedInThisRound) {
            // æ¸…é™¤å‹•ç•«æ¨£å¼
            const seats = document.querySelectorAll('.seat');
            seats.forEach(seat => {
                seat.classList.remove('lottery-animation');
            });

            const mode = document.getElementById('lotteryMode').value;

            // å…ˆå°‡ä¹‹å‰çš„ lottery-current æ”¹ç‚º lottery-previous
            seats.forEach(seat => {
                if (seat.classList.contains('lottery-current')) {
                    seat.classList.remove('lottery-current');
                    seat.classList.add('lottery-previous');
                }
            });

            // æ›´æ–°é¸ä¸­å­¸ç”Ÿåˆ—è¡¨ï¼ˆé€£çºŒæŠ½ç±¤æ¨¡å¼ï¼‰
            if (mode === 'continue') {
                selectedInThisRound.forEach(student => {
                    if (!selectedStudents.includes(student.seatIndex)) {
                        selectedStudents.push(student.seatIndex);
                    }
                });
            } else {
                // é‡è¤‡æŠ½ç±¤æ¨¡å¼ï¼šæ¸…é™¤ä¹‹å‰çš„é¸ä¸­ç‹€æ…‹
                seats.forEach(seat => {
                    seat.classList.remove('lottery-previous', 'lottery-selected');
                });
            }

            // é«˜äº®æœ¬æ¬¡æ–°é¸ä¸­çš„å­¸ç”Ÿï¼ˆç´…è‰²é–ƒçˆï¼‰
            selectedInThisRound.forEach(student => {
                const seat = document.querySelector(`[data-seat-index="${student.seatIndex}"]`);
                if (seat) {
                    seat.classList.remove('lottery-previous', 'lottery-selected');
                    seat.classList.add('lottery-current');
                }
            });

            // è¨˜éŒ„æŠ½ç±¤æ­·å²
            lotteryHistory.push({
                timestamp: new Date(),
                students: selectedInThisRound.map(s => s.name),
                mode: mode
            });

            // æ›´æ–°ç‹€æ…‹
            updateLotteryStatus();

            // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
            playResultSound();
            
            // é¡¯ç¤ºçµæœè¨Šæ¯
            const names = selectedInThisRound.map(s => s.name).join('ã€');
            const message = `ğŸ‰ æœ¬æ¬¡æŠ½ä¸­ï¼š${names}`;
            
            // å‰µå»ºçµæœæç¤º
            showLotteryResultMessage(message);

            // 5ç§’å¾Œå°‡æœ¬æ¬¡æŠ½ä¸­çš„æ”¹ç‚ºæ™®é€šé¸ä¸­ç‹€æ…‹ï¼ˆé€£çºŒæŠ½ç±¤æ¨¡å¼ï¼‰
            if (mode === 'continue') {
                setTimeout(() => {
                    selectedInThisRound.forEach(student => {
                        const seat = document.querySelector(`[data-seat-index="${student.seatIndex}"]`);
                        if (seat && seat.classList.contains('lottery-current')) {
                            seat.classList.remove('lottery-current');
                            seat.classList.add('lottery-previous');
                        }
                    });
                }, 5000);
            }
        }

        // é¡¯ç¤ºæŠ½ç±¤çµæœè¨Šæ¯
        function showLotteryResultMessage(message) {
            // å‰µå»ºçµæœé¡¯ç¤ºå…ƒç´ 
            const resultDiv = document.createElement('div');
            resultDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
                color: #2d3748;
                padding: 20px 30px;
                border-radius: 15px;
                font-size: 1.5rem;
                font-weight: bold;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 2000;
                animation: resultPop 0.5s ease-out;
                text-align: center;
                border: 3px solid #ff6b35;
            `;
            
            resultDiv.innerHTML = message;
            document.body.appendChild(resultDiv);
            
            // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
            setTimeout(() => {
                if (resultDiv.parentNode) {
                    resultDiv.parentNode.removeChild(resultDiv);
                }
            }, 3000);
        }

        // é¡¯ç¤ºæ¸…é™¤è³‡æ–™ç¢ºèªå°è©±æ¡†
        function showClearDataModal() {
            const totalClasses = Object.keys(classesData).length;
            const totalStudents = Object.values(classesData)
                .reduce((total, classData) => total + classData.students.filter(s => s !== null).length, 0);
            
            const confirmMessage = `âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ\n\nå°‡æœƒæ°¸ä¹…åˆªé™¤ï¼š\nâ€¢ ${totalClasses} å€‹ç­ç´š\nâ€¢ ${totalStudents} ä½å­¸ç”Ÿçš„è³‡æ–™\nâ€¢ æ‰€æœ‰åº§ä½å®‰æ’å’Œåˆ†æ•¸è¨˜éŒ„\nâ€¢ æœ¬åœ°å„²å­˜çš„è³‡æ–™\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼\n\nè«‹è¼¸å…¥ã€Œæ¸…é™¤æ‰€æœ‰è³‡æ–™ã€ä¾†ç¢ºèªï¼š`;
            
            const userInput = prompt(confirmMessage);
            
            if (userInput === 'æ¸…é™¤æ‰€æœ‰è³‡æ–™') {
                // æ¸…é™¤æ‰€æœ‰è³‡æ–™
                clearAllData();
                alert('æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤ï¼ç³»çµ±å·²é‡è¨­ç‚ºåˆå§‹ç‹€æ…‹ã€‚');
            } else if (userInput !== null) {
                alert('è¼¸å…¥ä¸æ­£ç¢ºï¼Œæ¸…é™¤æ“ä½œå·²å–æ¶ˆã€‚');
            }
        }

        // æ¸…é™¤æ‰€æœ‰è³‡æ–™
        function clearAllData() {
            // æ¸…é™¤ localStorage
            clearLocalStorage();
            
            // é‡è¨­ç‚ºåˆå§‹ç‹€æ…‹
            currentClassId = 'class1';
            classesData = {
                'class1': {
                    name: 'ä¸€å¹´ä¸€ç­',
                    columns: 6,
                    rows: 5,
                    students: new Array(30).fill(null),
                    studentScores: new Array(30).fill(0)
                }
            };
            
            // è¼‰å…¥é è¨­ç­ç´šè³‡æ–™
            loadCurrentClassData();
            
            // æ›´æ–°ä»‹é¢
            updateClassSelector();
            initializeSeating();
            
            // éš±è—æŠ½ç±¤æ§åˆ¶é¢æ¿
            document.getElementById('lotteryControls').style.display = 'none';
            clearAllHighlights();
        }

        // é‡è¨­æŠ½ç±¤
        function resetLottery() {
            playResetSound();
            selectedStudents = [];
            lotteryHistory = [];
            clearAllHighlights();
            updateAvailableStudents();
            updateLotteryStatus();
            
            alert('æŠ½ç±¤å·²é‡è¨­ï¼æ‰€æœ‰å­¸ç”Ÿéƒ½å¯ä»¥é‡æ–°åƒèˆ‡æŠ½ç±¤ã€‚');
        }

        // æ¸…é™¤æ‰€æœ‰é«˜äº®
        function clearAllHighlights() {
            const seats = document.querySelectorAll('.seat');
            seats.forEach(seat => {
                seat.classList.remove('lottery-selected', 'lottery-animation', 'lottery-current', 'lottery-previous');
            });
        }

        // æ¸…é™¤åƒ…å‹•ç•«é«˜äº®ï¼ˆä¿ç•™é¸ä¸­ç‹€æ…‹ï¼‰
        function clearAnimationHighlights() {
            const seats = document.querySelectorAll('.seat');
            seats.forEach(seat => {
                seat.classList.remove('lottery-animation');
            });
        }

        // é–‹å§‹æŠ½ç±¤ï¼ˆä¿ç•™åŸæœ‰çš„è¼ªç›¤æŠ½ç±¤åŠŸèƒ½ï¼‰
        function startLottery() {
            // ç²å–æ‰€æœ‰æœ‰å­¸ç”Ÿçš„åº§ä½
            availableStudents = [];
            for (let i = 0; i < totalSeats; i++) {
                if (students[i]) {
                    availableStudents.push({
                        name: students[i],
                        seatIndex: i
                    });
                }
            }

            if (availableStudents.length === 0) {
                alert('ç›®å‰æ²’æœ‰å­¸ç”Ÿå¯ä»¥æŠ½ç±¤ï¼è«‹å…ˆæ–°å¢ä¸€äº›å­¸ç”Ÿã€‚');
                return;
            }

            // é¡¯ç¤ºæŠ½ç±¤æ¨¡æ…‹æ¡†
            document.getElementById('lotteryModal').style.display = 'block';
            document.getElementById('lotteryStudentCount').textContent = availableStudents.length;
            
            // é‡ç½®æŠ½ç±¤ç‹€æ…‹
            resetLotteryDisplay();
        }

        // é‡ç½®æŠ½ç±¤é¡¯ç¤º
        function resetLotteryDisplay() {
            const wheelContainer = document.getElementById('wheelContainer');
            const resultDisplay = document.getElementById('resultDisplay');
            const readyMessage = document.getElementById('readyMessage');
            const lotteryBtn = document.getElementById('lotteryBtn');

            wheelContainer.style.transform = 'rotate(0deg)';
            resultDisplay.style.display = 'none';
            readyMessage.style.display = 'block';
            lotteryBtn.textContent = 'ğŸ² é–‹å§‹æŠ½ç±¤';
            lotteryBtn.onclick = spinWheel;
            isSpinning = false;
        }

        // è½‰å‹•è¼ªç›¤
        function spinWheel() {
            if (isSpinning || availableStudents.length === 0) return;

            isSpinning = true;
            const lotteryBtn = document.getElementById('lotteryBtn');
            const wheelContainer = document.getElementById('wheelContainer');
            const readyMessage = document.getElementById('readyMessage');

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            lotteryBtn.textContent = 'ğŸ² æŠ½ç±¤ä¸­...';
            lotteryBtn.disabled = true;
            readyMessage.textContent = 'æ­£åœ¨æŠ½ç±¤ä¸­ï¼Œè«‹ç¨å€™...';

            // æ’­æ”¾è¼ªç›¤è½‰å‹•éŸ³æ•ˆï¼ˆé€£çºŒçš„å—¶å—¶è²ï¼‰
            let tickCount = 0;
            const tickInterval = setInterval(() => {
                playLotteryTickSound();
                tickCount++;
                if (tickCount >= 25) { // æ’­æ”¾2.5ç§’çš„éŸ³æ•ˆ
                    clearInterval(tickInterval);
                }
            }, 100);

            // éš¨æ©Ÿé¸æ“‡å­¸ç”Ÿ
            const selectedIndex = Math.floor(Math.random() * availableStudents.length);
            const selectedStudent = availableStudents[selectedIndex];

            // è¨ˆç®—è½‰å‹•è§’åº¦ï¼ˆå¤šè½‰å¹¾åœˆå¢åŠ æ•ˆæœï¼‰
            const baseRotation = 1440; // 4åœˆ
            const randomRotation = Math.floor(Math.random() * 360);
            const totalRotation = baseRotation + randomRotation;

            // é–‹å§‹è½‰å‹•
            wheelContainer.style.transform = `rotate(${totalRotation}deg)`;

            // 3ç§’å¾Œé¡¯ç¤ºçµæœ
            setTimeout(() => {
                showLotteryResult(selectedStudent);
            }, 3000);
        }

        // é¡¯ç¤ºæŠ½ç±¤çµæœ
        function showLotteryResult(selectedStudent) {
            const resultDisplay = document.getElementById('resultDisplay');
            const readyMessage = document.getElementById('readyMessage');
            const selectedStudentSpan = document.getElementById('selectedStudent');
            const lotteryBtn = document.getElementById('lotteryBtn');

            // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
            playResultSound();

            // é¡¯ç¤ºçµæœ
            selectedStudentSpan.textContent = selectedStudent.name;
            resultDisplay.style.display = 'block';
            readyMessage.style.display = 'none';

            // é«˜äº®é¡¯ç¤ºè¢«é¸ä¸­çš„å­¸ç”Ÿåº§ä½
            highlightSelectedSeat(selectedStudent.seatIndex);

            // æ›´æ–°æŒ‰éˆ•
            lotteryBtn.textContent = 'ğŸ² å†æ¬¡æŠ½ç±¤';
            lotteryBtn.disabled = false;
            lotteryBtn.onclick = () => {
                resetLotteryDisplay();
                setTimeout(spinWheel, 100);
            };

            isSpinning = false;
        }

        // é«˜äº®é¡¯ç¤ºé¸ä¸­çš„åº§ä½
        function highlightSelectedSeat(seatIndex) {
            // ç§»é™¤ä¹‹å‰çš„é«˜äº®
            const allSeats = document.querySelectorAll('.seat');
            allSeats.forEach(seat => {
                seat.classList.remove('lottery-current', 'lottery-previous');
            });

            // æ·»åŠ æ–°çš„é«˜äº®ï¼ˆä½¿ç”¨ç´…è‰²é–ƒçˆæ•ˆæœï¼‰
            const selectedSeat = document.querySelector(`[data-seat-index="${seatIndex}"]`);
            if (selectedSeat) {
                selectedSeat.classList.add('lottery-current');
                
                // 8ç§’å¾Œç§»é™¤é«˜äº®
                setTimeout(() => {
                    selectedSeat.classList.remove('lottery-current');
                }, 8000);
            }
        }

        // é—œé–‰æŠ½ç±¤æ¨¡æ…‹æ¡†
        function closeLotteryModal() {
            document.getElementById('lotteryModal').style.display = 'none';
            
            // ç§»é™¤æ‰€æœ‰åº§ä½é«˜äº®
            const allSeats = document.querySelectorAll('.seat');
            allSeats.forEach(seat => {
                seat.classList.remove('lottery-selected', 'lottery-current', 'lottery-previous');
            });
            
            resetLotteryDisplay();
        }

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const importModal = document.getElementById('importModal');
            const layoutModal = document.getElementById('layoutModal');
            const importDataModal = document.getElementById('importDataModal');
            const lotteryModal = document.getElementById('lotteryModal');
            const addClassModal = document.getElementById('addClassModal');
            const manageClassModal = document.getElementById('manageClassModal');
            const leaveModal = document.getElementById('leaveModal');
            
            if (event.target === editModal) {
                closeModal();
            } else if (event.target === importModal) {
                closeImportModal();
            } else if (event.target === layoutModal) {
                closeLayoutModal();
            } else if (event.target === importDataModal) {
                closeImportDataModal();
            } else if (event.target === lotteryModal) {
                closeLotteryModal();
            } else if (event.target === addClassModal) {
                closeAddClassModal();
            } else if (event.target === manageClassModal) {
                closeManageClassModal();
            } else if (event.target === leaveModal) {
                closeLeaveModal();
            }
            
            const timerModal = document.getElementById('timerModal');
            if (event.target === timerModal) {
                closeTimerModal();
            }
        }

        // Enter éµå„²å­˜
        document.getElementById('studentNameInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                saveStudent();
            }
        });

        // æ‹–æ‹‰åŠŸèƒ½è®Šæ•¸
        let dragSourceIndex = null;

        // æ‹–æ‹‰é–‹å§‹
        function handleDragStart(e) {
            dragSourceIndex = parseInt(e.target.dataset.seatIndex);
            e.target.classList.add('drag-source');
            
            // åªå…è¨±æ‹–æ‹‰æœ‰å­¸ç”Ÿçš„åº§ä½
            if (!students[dragSourceIndex]) {
                e.preventDefault();
                return false;
            }
            
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
        }

        // æ‹–æ‹‰ç¶“é
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        // æ‹–æ‹‰é€²å…¥
        function handleDragEnter(e) {
            e.target.classList.add('drag-over');
        }

        // æ‹–æ‹‰é›¢é–‹
        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        // æ”¾ä¸‹
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const dropTargetIndex = parseInt(e.target.closest('.seat').dataset.seatIndex);
            
            if (dragSourceIndex !== dropTargetIndex) {
                // äº¤æ›å­¸ç”Ÿä½ç½®å’Œåˆ†æ•¸
                const sourceStudent = students[dragSourceIndex];
                const targetStudent = students[dropTargetIndex];
                const sourceScore = studentScores[dragSourceIndex];
                const targetScore = studentScores[dropTargetIndex];
                
                students[dragSourceIndex] = targetStudent;
                students[dropTargetIndex] = sourceStudent;
                studentScores[dragSourceIndex] = targetScore;
                studentScores[dropTargetIndex] = sourceScore;
                
                initializeSeating();
            }

            return false;
        }

        // æ‹–æ‹‰çµæŸ
        function handleDragEnd(e) {
            // æ¸…é™¤æ‰€æœ‰æ‹–æ‹‰æ¨£å¼
            const seats = document.querySelectorAll('.seat');
            seats.forEach(seat => {
                seat.classList.remove('drag-source', 'drag-over');
            });
            
            dragSourceIndex = null;
        }

        // éŸ³æ•ˆé–‹é—œäº‹ä»¶ç›£è½å™¨
        document.addEventListener('DOMContentLoaded', function() {
            const soundCheckbox = document.getElementById('soundEnabled');
            const soundStatus = document.getElementById('soundStatus');
            
            if (soundCheckbox && soundStatus) {
                soundCheckbox.addEventListener('change', function() {
                    soundStatus.textContent = this.checked ? 'é–‹å•Ÿ' : 'é—œé–‰';
                    
                    // æ’­æ”¾æ¸¬è©¦éŸ³æ•ˆï¼ˆå¦‚æœé–‹å•Ÿï¼‰
                    if (this.checked) {
                        setTimeout(() => playSound(523, 0.2), 100);
                    }
                });
            }
        });

        // é¡¯ç¤ºè«‹å‡ç®¡ç†æ¨¡æ…‹æ¡†
        function showLeaveModal() {
            document.getElementById('leaveModal').style.display = 'block';
            switchLeaveTab('leave');
            updateLeaveStudentSelect();
        }

        // é—œé–‰è«‹å‡ç®¡ç†æ¨¡æ…‹æ¡†
        function closeLeaveModal() {
            document.getElementById('leaveModal').style.display = 'none';
        }

        // åˆ‡æ›è«‹å‡ç®¡ç†é ç±¤
        function switchLeaveTab(tab) {
            // éš±è—æ‰€æœ‰é ç±¤å…§å®¹
            document.getElementById('leaveTab').style.display = 'none';
            document.getElementById('returnTab').style.display = 'none';
            document.getElementById('historyTab').style.display = 'none';
            
            // é‡è¨­æŒ‰éˆ•æ¨£å¼
            document.getElementById('leaveTabBtn').className = 'btn btn-secondary';
            document.getElementById('returnTabBtn').className = 'btn btn-secondary';
            document.getElementById('historyTabBtn').className = 'btn btn-secondary';
            
            // é¡¯ç¤ºé¸ä¸­çš„é ç±¤
            if (tab === 'leave') {
                document.getElementById('leaveTab').style.display = 'block';
                document.getElementById('leaveTabBtn').className = 'btn btn-primary';
                updateLeaveStudentSelect();
            } else if (tab === 'return') {
                document.getElementById('returnTab').style.display = 'block';
                document.getElementById('returnTabBtn').className = 'btn btn-primary';
                updateOnLeaveStudentsList();
            } else if (tab === 'history') {
                document.getElementById('historyTab').style.display = 'block';
                document.getElementById('historyTabBtn').className = 'btn btn-primary';
                updateLeaveHistoryList();
            }
        }

        // æ›´æ–°è«‹å‡å­¸ç”Ÿé¸æ“‡åˆ—è¡¨
        function updateLeaveStudentSelect() {
            const select = document.getElementById('leaveStudentSelect');
            select.innerHTML = '<option value="">è«‹é¸æ“‡å­¸ç”Ÿ</option>';
            
            for (let i = 0; i < totalSeats; i++) {
                if (students[i] && !studentLeaveStatus[i]) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${students[i]} (åº§ä½ ${i + 1})`;
                    select.appendChild(option);
                }
            }
            
            // è¨­å®šä»Šå¤©çš„æ—¥æœŸç‚ºé è¨­å€¼
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('leaveDateInput').value = today;
        }

        // è¨­å®šå­¸ç”Ÿè«‹å‡
        function setStudentLeave() {
            const seatIndex = parseInt(document.getElementById('leaveStudentSelect').value);
            const leaveType = document.getElementById('leaveTypeSelect').value;
            const leaveReason = document.getElementById('leaveReasonInput').value.trim();
            const leaveDate = document.getElementById('leaveDateInput').value;
            
            if (isNaN(seatIndex)) {
                alert('è«‹é¸æ“‡è¦è«‹å‡çš„å­¸ç”Ÿï¼');
                return;
            }
            
            if (!leaveDate) {
                alert('è«‹é¸æ“‡è«‹å‡æ—¥æœŸï¼');
                return;
            }
            
            const studentName = students[seatIndex];
            
            // è¨­å®šè«‹å‡ç‹€æ…‹
            studentLeaveStatus[seatIndex] = true;
            
            // ç¢ºä¿ç­ç´šè³‡æ–™çµæ§‹ä¸­çš„è«‹å‡ç‹€æ…‹é™£åˆ—å­˜åœ¨ä¸¦æ›´æ–°
            if (!classesData[currentClassId].studentLeaveStatus) {
                classesData[currentClassId].studentLeaveStatus = new Array(totalSeats).fill(false);
            }
            classesData[currentClassId].studentLeaveStatus[seatIndex] = true;
            
            // è¨˜éŒ„è«‹å‡è³‡è¨Š
            const leaveRecord = {
                id: Date.now(),
                studentName: studentName,
                seatIndex: seatIndex,
                leaveType: leaveType,
                leaveReason: leaveReason,
                leaveDate: leaveDate,
                leaveTime: new Date().toISOString(),
                returnTime: null,
                status: 'on-leave'
            };
            
            // æ·»åŠ åˆ°è«‹å‡è¨˜éŒ„
            if (!classesData[currentClassId].leaveHistory) {
                classesData[currentClassId].leaveHistory = [];
            }
            classesData[currentClassId].leaveHistory.push(leaveRecord);
            
            // å„²å­˜è³‡æ–™
            saveCurrentClassData();
            
            // æ›´æ–°åº§ä½é¡¯ç¤º
            initializeSeating();
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('leaveStudentSelect').value = '';
            document.getElementById('leaveReasonInput').value = '';
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            const typeNames = {
                'sick': 'ç—…å‡',
                'personal': 'äº‹å‡',
                'family': 'å®¶åº­äº‹å‡',
                'other': 'å…¶ä»–'
            };
            
            alert(`${studentName} çš„${typeNames[leaveType]}å·²è¨­å®šå®Œæˆï¼\nè«‹å‡æ—¥æœŸï¼š${leaveDate}\nåº§ä½å°‡é¡¯ç¤ºç‚ºè«‹å‡ç‹€æ…‹ã€‚`);
            
            // æ›´æ–°å­¸ç”Ÿé¸æ“‡åˆ—è¡¨
            updateLeaveStudentSelect();
        }

        // æ›´æ–°è«‹å‡å­¸ç”Ÿåˆ—è¡¨
        function updateOnLeaveStudentsList() {
            const container = document.getElementById('onLeaveStudentsList');
            container.innerHTML = '';
            
            const onLeaveStudents = [];
            for (let i = 0; i < totalSeats; i++) {
                if (students[i] && studentLeaveStatus[i]) {
                    // æ‰¾åˆ°æœ€æ–°çš„è«‹å‡è¨˜éŒ„
                    const leaveRecord = classesData[currentClassId].leaveHistory
                        .filter(record => record.seatIndex === i && record.status === 'on-leave')
                        .sort((a, b) => new Date(b.leaveTime) - new Date(a.leaveTime))[0];
                    
                    if (leaveRecord) {
                        onLeaveStudents.push({
                            seatIndex: i,
                            studentName: students[i],
                            leaveRecord: leaveRecord
                        });
                    }
                }
            }
            
            if (onLeaveStudents.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #718096;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ˜Š</div>
                        <div style="font-size: 1.1rem; font-weight: 600;">ç›®å‰æ²’æœ‰å­¸ç”Ÿè«‹å‡</div>
                        <div style="font-size: 0.9rem; margin-top: 8px;">æ‰€æœ‰å­¸ç”Ÿéƒ½åœ¨æ ¡ä¸Šèª²</div>
                    </div>
                `;
                return;
            }
            
            onLeaveStudents.forEach(student => {
                const typeNames = {
                    'sick': 'ç—…å‡ ğŸ¤’',
                    'personal': 'äº‹å‡ ğŸ“‹',
                    'family': 'å®¶åº­äº‹å‡ ğŸ ',
                    'other': 'å…¶ä»– ğŸ“'
                };
                
                const leaveItem = document.createElement('div');
                leaveItem.style.cssText = `
                    background: #fbb6ce;
                    border: 2px solid #ed64a6;
                    border-radius: 10px;
                    padding: 15px;
                    margin-bottom: 15px;
                    position: relative;
                `;
                
                leaveItem.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="font-weight: bold; color: #2d3748; margin-bottom: 8px; font-size: 1.1rem;">
                                ğŸ¥ ${student.studentName} (åº§ä½ ${student.seatIndex + 1})
                            </div>
                            <div style="color: #4a5568; font-size: 0.9rem; margin-bottom: 5px;">
                                <strong>è«‹å‡é¡å‹ï¼š</strong>${typeNames[student.leaveRecord.leaveType]}
                            </div>
                            <div style="color: #4a5568; font-size: 0.9rem; margin-bottom: 5px;">
                                <strong>è«‹å‡æ—¥æœŸï¼š</strong>${student.leaveRecord.leaveDate}
                            </div>
                            ${student.leaveRecord.leaveReason ? `
                                <div style="color: #4a5568; font-size: 0.9rem; margin-bottom: 5px;">
                                    <strong>è«‹å‡åŸå› ï¼š</strong>${student.leaveRecord.leaveReason}
                                </div>
                            ` : ''}
                            <div style="color: #718096; font-size: 0.8rem;">
                                è«‹å‡æ™‚é–“ï¼š${new Date(student.leaveRecord.leaveTime).toLocaleString()}
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="returnStudentFromLeave(${student.seatIndex})" style="background: #48bb78; border: none; padding: 8px 16px;">
                                âœ… éŠ·å‡è¿”æ ¡
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(leaveItem);
            });
        }

        // å­¸ç”ŸéŠ·å‡è¿”æ ¡
        function returnStudentFromLeave(seatIndex) {
            const studentName = students[seatIndex];
            
            if (!confirm(`ç¢ºå®šè¦ç‚º ${studentName} è¾¦ç†éŠ·å‡è¿”æ ¡å—ï¼Ÿ`)) {
                return;
            }
            
            // å–æ¶ˆè«‹å‡ç‹€æ…‹
            studentLeaveStatus[seatIndex] = false;
            
            // æ›´æ–°è«‹å‡è¨˜éŒ„ç‹€æ…‹
            const leaveHistory = classesData[currentClassId].leaveHistory || [];
            for (let i = leaveHistory.length - 1; i >= 0; i--) {
                if (leaveHistory[i].seatIndex === seatIndex && leaveHistory[i].status === 'on-leave') {
                    leaveHistory[i].status = 'returned';
                    leaveHistory[i].returnTime = new Date().toISOString();
                    break;
                }
            }
            
            // ç¢ºä¿ç­ç´šè³‡æ–™çµæ§‹ä¸­çš„è«‹å‡ç‹€æ…‹é™£åˆ—å­˜åœ¨ä¸¦æ›´æ–°
            if (!classesData[currentClassId].studentLeaveStatus) {
                classesData[currentClassId].studentLeaveStatus = new Array(totalSeats).fill(false);
            }
            classesData[currentClassId].studentLeaveStatus[seatIndex] = false;
            
            // å„²å­˜æ‰€æœ‰è³‡æ–™åˆ°ç­ç´šè³‡æ–™çµæ§‹
            saveCurrentClassData();
            
            // é‡æ–°è¼‰å…¥ç›®å‰ç­ç´šè³‡æ–™ä»¥ç¢ºä¿åŒæ­¥
            loadCurrentClassData();
            
            // é‡æ–°åˆå§‹åŒ–åº§ä½è¡¨ä»¥æ›´æ–°æ‰€æœ‰ç‹€æ…‹
            initializeSeating();
            
            // æ›´æ–°å¯ç”¨å­¸ç”Ÿåˆ—è¡¨ï¼ˆæŠ½ç±¤åŠŸèƒ½ï¼‰
            if (typeof updateAvailableStudents === 'function') {
                updateAvailableStudents();
            }
            if (typeof updateLotteryStatus === 'function') {
                updateLotteryStatus();
            }
            
            // æ›´æ–°è«‹å‡å­¸ç”Ÿåˆ—è¡¨
            updateOnLeaveStudentsList();
            
            // å¦‚æœç›®å‰åœ¨è«‹å‡è¨˜éŒ„é ç±¤ï¼Œä¹Ÿè¦æ›´æ–°
            if (document.getElementById('historyTab').style.display !== 'none') {
                updateLeaveHistoryList();
            }
            
            // æ›´æ–°è«‹å‡è¨­å®šé é¢çš„å­¸ç”Ÿé¸æ“‡åˆ—è¡¨
            if (document.getElementById('leaveTab').style.display !== 'none') {
                updateLeaveStudentSelect();
            }
            
            alert(`${studentName} å·²æˆåŠŸéŠ·å‡è¿”æ ¡ï¼\nåº§ä½ç‹€æ…‹å·²æ¢å¾©æ­£å¸¸ï¼Œå¯ä»¥é‡æ–°åƒèˆ‡æŠ½ç±¤æ´»å‹•ã€‚`);
        }

        // æ›´æ–°è«‹å‡è¨˜éŒ„åˆ—è¡¨
        function updateLeaveHistoryList() {
            const container = document.getElementById('leaveHistoryList');
            const leaveHistory = classesData[currentClassId].leaveHistory || [];
            
            // æ›´æ–°çµ±è¨ˆè³‡è¨Š
            const currentLeaveCount = studentLeaveStatus.filter(status => status).length;
            document.getElementById('currentLeaveCount').textContent = currentLeaveCount;
            document.getElementById('totalLeaveRecords').textContent = leaveHistory.length;
            
            container.innerHTML = '';
            
            if (leaveHistory.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #718096;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“‹</div>
                        <div style="font-size: 1.1rem; font-weight: 600;">æš«ç„¡è«‹å‡è¨˜éŒ„</div>
                        <div style="font-size: 0.9rem; margin-top: 8px;">å­¸ç”Ÿçš„è«‹å‡è¨˜éŒ„å°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
                    </div>
                `;
                return;
            }
            
            // æŒ‰æ™‚é–“å€’åºæ’åˆ—
            const sortedHistory = [...leaveHistory].sort((a, b) => new Date(b.leaveTime) - new Date(a.leaveTime));
            
            sortedHistory.forEach(record => {
                const typeNames = {
                    'sick': 'ç—…å‡ ğŸ¤’',
                    'personal': 'äº‹å‡ ğŸ“‹',
                    'family': 'å®¶åº­äº‹å‡ ğŸ ',
                    'other': 'å…¶ä»– ğŸ“'
                };
                
                const statusNames = {
                    'on-leave': 'è«‹å‡ä¸­',
                    'returned': 'å·²è¿”æ ¡'
                };
                
                const statusColors = {
                    'on-leave': '#fbb6ce',
                    'returned': '#c6f6d5'
                };
                
                const historyItem = document.createElement('div');
                historyItem.style.cssText = `
                    background: ${statusColors[record.status]};
                    border: 2px solid ${record.status === 'on-leave' ? '#ed64a6' : '#48bb78'};
                    border-radius: 10px;
                    padding: 15px;
                    margin-bottom: 10px;
                `;
                
                historyItem.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <div style="font-weight: bold; color: #2d3748; font-size: 1.1rem;">
                            ${record.studentName} (åº§ä½ ${record.seatIndex + 1})
                        </div>
                        <div style="background: ${record.status === 'on-leave' ? '#ed64a6' : '#48bb78'}; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">
                            ${statusNames[record.status]}
                        </div>
                    </div>
                    <div style="color: #4a5568; font-size: 0.9rem; margin-bottom: 5px;">
                        <strong>è«‹å‡é¡å‹ï¼š</strong>${typeNames[record.leaveType]}
                    </div>
                    <div style="color: #4a5568; font-size: 0.9rem; margin-bottom: 5px;">
                        <strong>è«‹å‡æ—¥æœŸï¼š</strong>${record.leaveDate}
                    </div>
                    ${record.leaveReason ? `
                        <div style="color: #4a5568; font-size: 0.9rem; margin-bottom: 5px;">
                            <strong>è«‹å‡åŸå› ï¼š</strong>${record.leaveReason}
                        </div>
                    ` : ''}
                    <div style="color: #718096; font-size: 0.8rem; margin-bottom: 3px;">
                        è«‹å‡æ™‚é–“ï¼š${new Date(record.leaveTime).toLocaleString()}
                    </div>
                    ${record.returnTime ? `
                        <div style="color: #718096; font-size: 0.8rem;">
                            è¿”æ ¡æ™‚é–“ï¼š${new Date(record.returnTime).toLocaleString()}
                        </div>
                    ` : ''}
                `;
                
                container.appendChild(historyItem);
            });
        }

        // æ¸…é™¤è«‹å‡è¨˜éŒ„
        function clearLeaveHistory() {
            const leaveHistory = classesData[currentClassId].leaveHistory || [];
            
            if (leaveHistory.length === 0) {
                alert('ç›®å‰æ²’æœ‰è«‹å‡è¨˜éŒ„å¯ä»¥æ¸…é™¤ã€‚');
                return;
            }
            
            // åˆ†é¡è¨˜éŒ„ï¼šè«‹å‡ä¸­ vs å·²éŠ·å‡
            const onLeaveRecords = leaveHistory.filter(record => record.status === 'on-leave');
            const returnedRecords = leaveHistory.filter(record => record.status === 'returned');
            
            if (returnedRecords.length === 0) {
                alert('ç›®å‰æ²’æœ‰å·²éŠ·å‡çš„è¨˜éŒ„å¯ä»¥æ¸…é™¤ã€‚\n\næ³¨æ„ï¼šåªèƒ½æ¸…é™¤å·²éŠ·å‡çš„æ­·å²è¨˜éŒ„ï¼Œç›®å‰è«‹å‡ä¸­çš„è¨˜éŒ„ä¸æœƒè¢«æ¸…é™¤ã€‚');
                return;
            }
            
            const confirmMessage = `ç¢ºå®šè¦æ¸…é™¤å·²éŠ·å‡çš„æ­·å²è¨˜éŒ„å—ï¼Ÿ\n\nâ€¢ å°‡æ¸…é™¤ï¼š${returnedRecords.length} ç­†å·²éŠ·å‡è¨˜éŒ„\nâ€¢ ä¿ç•™ï¼š${onLeaveRecords.length} ç­†è«‹å‡ä¸­è¨˜éŒ„\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // åªä¿ç•™è«‹å‡ä¸­çš„è¨˜éŒ„ï¼Œæ¸…é™¤å·²éŠ·å‡çš„è¨˜éŒ„
            classesData[currentClassId].leaveHistory = onLeaveRecords;
            
            // å„²å­˜è³‡æ–™
            saveCurrentClassData();
            
            // æ›´æ–°é¡¯ç¤º
            updateLeaveHistoryList();
            
            alert(`å·²æ¸…é™¤ ${returnedRecords.length} ç­†å·²éŠ·å‡çš„æ­·å²è¨˜éŒ„ï¼\n\nç›®å‰è«‹å‡ä¸­çš„ ${onLeaveRecords.length} ç­†è¨˜éŒ„å·²ä¿ç•™ã€‚`);
        }

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        function initializeApp() {
            // å˜—è©¦å¾ localStorage è¼‰å…¥è³‡æ–™
            const hasLocalData = loadFromLocalStorage();
            
            if (hasLocalData) {
                // è¼‰å…¥ç›®å‰ç­ç´šè³‡æ–™
                loadCurrentClassData();
                console.log('å·²è¼‰å…¥æœ¬åœ°å„²å­˜çš„è³‡æ–™');
            } else {
                console.log('ä½¿ç”¨é è¨­è³‡æ–™');
            }
            
            // æ›´æ–°ä»‹é¢
            updateClassSelector();
            initializeSeating();
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            if (hasLocalData) {
                const totalStudents = Object.values(classesData)
                    .reduce((total, classData) => total + classData.students.filter(s => s !== null).length, 0);
                
                console.log(`å·²è¼‰å…¥ ${Object.keys(classesData).length} å€‹ç­ç´šï¼Œå…± ${totalStudents} ä½å­¸ç”Ÿ`);
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // é é¢å¸è¼‰å‰è‡ªå‹•å„²å­˜
        window.addEventListener('beforeunload', function() {
            saveCurrentClassData();
        });

        // åˆ‡æ›åŠŸèƒ½è¡¨é¡¯ç¤º/éš±è—
        function toggleControls() {
            const controlsPanel = document.getElementById('controlsPanel');
            const toggleBtn = document.getElementById('toggleControlsBtn');
            
            if (controlsPanel.style.display === 'none') {
                controlsPanel.style.display = 'flex';
                toggleBtn.innerHTML = 'ğŸ“‹ éš±è—åŠŸèƒ½è¡¨';
                toggleBtn.style.background = '#f56565';
            } else {
                controlsPanel.style.display = 'none';
                toggleBtn.innerHTML = 'ğŸ“‹ é¡¯ç¤ºåŠŸèƒ½è¡¨';
                toggleBtn.style.background = '#4a5568';
            }
        }

        // åˆ‡æ›å…¨è¢å¹•é¡¯ç¤º
        function toggleFullscreen() {
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            
            if (!document.fullscreenElement) {
                // é€²å…¥å…¨è¢å¹•
                document.documentElement.requestFullscreen().then(() => {
                    fullscreenBtn.innerHTML = 'ğŸ–¥ï¸ é€€å‡ºå…¨è¢å¹•';
                    fullscreenBtn.style.background = '#f56565';
                }).catch(err => {
                    console.error('ç„¡æ³•é€²å…¥å…¨è¢å¹•æ¨¡å¼:', err);
                    alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å…¨è¢å¹•åŠŸèƒ½ï¼Œæˆ–è¢«å®‰å…¨è¨­å®šé˜»æ“‹ã€‚');
                });
            } else {
                // é€€å‡ºå…¨è¢å¹•
                document.exitFullscreen().then(() => {
                    fullscreenBtn.innerHTML = 'ğŸ–¥ï¸ å…¨è¢å¹•é¡¯ç¤º';
                    fullscreenBtn.style.background = '#38a169';
                }).catch(err => {
                    console.error('ç„¡æ³•é€€å‡ºå…¨è¢å¹•æ¨¡å¼:', err);
                });
            }
        }

        // ç›£è½å…¨è¢å¹•ç‹€æ…‹è®ŠåŒ–
        document.addEventListener('fullscreenchange', function() {
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            
            if (!document.fullscreenElement) {
                // å·²é€€å‡ºå…¨è¢å¹•
                fullscreenBtn.innerHTML = 'ğŸ–¥ï¸ å…¨è¢å¹•é¡¯ç¤º';
                fullscreenBtn.style.background = '#38a169';
            }
        });

        // å€’æ•¸è¨ˆæ™‚å™¨åŠŸèƒ½è®Šæ•¸
        let timerInterval = null;
        let timerTotalSeconds = 0;
        let timerRemainingSeconds = 0;
        let timerIsRunning = false;
        let timerIsPaused = false;

        // é¡¯ç¤ºè¨ˆæ™‚å™¨æ¨¡æ…‹æ¡†
        function showTimerModal() {
            document.getElementById('timerModal').style.display = 'block';
            resetTimer();
        }

        // é—œé–‰è¨ˆæ™‚å™¨æ¨¡æ…‹æ¡†
        function closeTimerModal() {
            document.getElementById('timerModal').style.display = 'none';
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            timerIsRunning = false;
            timerIsPaused = false;
        }

        // è¨­å®šå¿«é€Ÿè¨ˆæ™‚å™¨
        function setQuickTimer(minutes, seconds) {
            document.getElementById('timerMinutes').value = minutes;
            document.getElementById('timerSeconds').value = seconds;
            updateTimerDisplay();
        }

        // æ›´æ–°è¨ˆæ™‚å™¨é¡¯ç¤º
        function updateTimerDisplay() {
            const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
            
            timerTotalSeconds = minutes * 60 + seconds;
            timerRemainingSeconds = timerTotalSeconds;
            
            const displayMinutes = Math.floor(timerRemainingSeconds / 60);
            const displaySeconds = timerRemainingSeconds % 60;
            
            document.getElementById('timerText').textContent = 
                `${displayMinutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
            
            // æ›´æ–°é€²åº¦åœ“åœˆ
            updateTimerProgress();
        }

        // æ›´æ–°è¨ˆæ™‚å™¨é€²åº¦åœ“åœˆ
        function updateTimerProgress() {
            const progressCircle = document.getElementById('timerProgress');
            const timerCircle = document.getElementById('timerCircle');
            
            if (timerTotalSeconds === 0) {
                progressCircle.style.strokeDashoffset = '628.32';
                timerCircle.style.borderColor = '#e2e8f0';
                return;
            }
            
            const progress = (timerTotalSeconds - timerRemainingSeconds) / timerTotalSeconds;
            const offset = 628.32 - (progress * 628.32);
            progressCircle.style.strokeDashoffset = offset;
            
            // æ ¹æ“šå‰©é¤˜æ™‚é–“æ”¹è®Šé¡è‰²
            if (timerRemainingSeconds <= 10 && timerRemainingSeconds > 0) {
                progressCircle.style.stroke = '#f56565';
                timerCircle.style.borderColor = '#f56565';
                timerCircle.style.background = 'linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%)';
            } else if (timerRemainingSeconds <= 30) {
                progressCircle.style.stroke = '#ed8936';
                timerCircle.style.borderColor = '#ed8936';
                timerCircle.style.background = 'linear-gradient(135deg, #feebc8 0%, #fbd38d 100%)';
            } else {
                progressCircle.style.stroke = '#667eea';
                timerCircle.style.borderColor = '#667eea';
                timerCircle.style.background = 'linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%)';
            }
        }

        // é–‹å§‹è¨ˆæ™‚å™¨
        function startTimer() {
            const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
            
            if (minutes === 0 && seconds === 0) {
                alert('è«‹è¨­å®šè¨ˆæ™‚æ™‚é–“ï¼');
                return;
            }
            
            timerTotalSeconds = minutes * 60 + seconds;
            timerRemainingSeconds = timerTotalSeconds;
            timerIsRunning = true;
            timerIsPaused = false;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('startTimerBtn').style.display = 'none';
            document.getElementById('pauseTimerBtn').style.display = 'inline-block';
            document.getElementById('resumeTimerBtn').style.display = 'none';
            
            // æ›´æ–°ç‹€æ…‹æ–‡å­—
            document.getElementById('timerStatus').textContent = 'è¨ˆæ™‚é€²è¡Œä¸­...';
            document.getElementById('timerStatus').style.color = '#48bb78';
            
            // é–‹å§‹å€’æ•¸
            timerInterval = setInterval(() => {
                timerRemainingSeconds--;
                
                const displayMinutes = Math.floor(timerRemainingSeconds / 60);
                const displaySeconds = timerRemainingSeconds % 60;
                
                document.getElementById('timerText').textContent = 
                    `${displayMinutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
                
                updateTimerProgress();
                
                // æ’­æ”¾æ»´ç­”è²ï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
                if (document.getElementById('timerTickEnabled').checked && timerRemainingSeconds <= 10 && timerRemainingSeconds > 0) {
                    playTimerTickSound();
                }
                
                // è¨ˆæ™‚çµæŸ
                if (timerRemainingSeconds <= 0) {
                    timerFinished();
                }
            }, 1000);
        }

        // æš«åœè¨ˆæ™‚å™¨
        function pauseTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            timerIsPaused = true;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('pauseTimerBtn').style.display = 'none';
            document.getElementById('resumeTimerBtn').style.display = 'inline-block';
            
            // æ›´æ–°ç‹€æ…‹æ–‡å­—
            document.getElementById('timerStatus').textContent = 'è¨ˆæ™‚å·²æš«åœ';
            document.getElementById('timerStatus').style.color = '#ed8936';
        }

        // ç¹¼çºŒè¨ˆæ™‚å™¨
        function resumeTimer() {
            if (timerRemainingSeconds <= 0) return;
            
            timerIsPaused = false;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('pauseTimerBtn').style.display = 'inline-block';
            document.getElementById('resumeTimerBtn').style.display = 'none';
            
            // æ›´æ–°ç‹€æ…‹æ–‡å­—
            document.getElementById('timerStatus').textContent = 'è¨ˆæ™‚é€²è¡Œä¸­...';
            document.getElementById('timerStatus').style.color = '#48bb78';
            
            // ç¹¼çºŒå€’æ•¸
            timerInterval = setInterval(() => {
                timerRemainingSeconds--;
                
                const displayMinutes = Math.floor(timerRemainingSeconds / 60);
                const displaySeconds = timerRemainingSeconds % 60;
                
                document.getElementById('timerText').textContent = 
                    `${displayMinutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
                
                updateTimerProgress();
                
                // æ’­æ”¾æ»´ç­”è²ï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
                if (document.getElementById('timerTickEnabled').checked && timerRemainingSeconds <= 10 && timerRemainingSeconds > 0) {
                    playTimerTickSound();
                }
                
                // è¨ˆæ™‚çµæŸ
                if (timerRemainingSeconds <= 0) {
                    timerFinished();
                }
            }, 1000);
        }

        // é‡è¨­è¨ˆæ™‚å™¨
        function resetTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            timerIsRunning = false;
            timerIsPaused = false;
            
            // é‡è¨­æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('startTimerBtn').style.display = 'inline-block';
            document.getElementById('pauseTimerBtn').style.display = 'none';
            document.getElementById('resumeTimerBtn').style.display = 'none';
            
            // é‡è¨­ç‹€æ…‹æ–‡å­—
            document.getElementById('timerStatus').textContent = 'æº–å‚™é–‹å§‹è¨ˆæ™‚';
            document.getElementById('timerStatus').style.color = '#718096';
            
            // é‡è¨­é¡¯ç¤º
            updateTimerDisplay();
        }

        // è¨ˆæ™‚çµæŸ
        function timerFinished() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            timerIsRunning = false;
            timerRemainingSeconds = 0;
            
            // æ›´æ–°é¡¯ç¤º
            document.getElementById('timerText').textContent = '00:00';
            document.getElementById('timerStatus').textContent = 'â° è¨ˆæ™‚çµæŸï¼';
            document.getElementById('timerStatus').style.color = '#f56565';
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('startTimerBtn').style.display = 'inline-block';
            document.getElementById('pauseTimerBtn').style.display = 'none';
            document.getElementById('resumeTimerBtn').style.display = 'none';
            
            // æ’­æ”¾çµæŸéŸ³æ•ˆ
            if (document.getElementById('timerSoundEnabled').checked) {
                playTimerFinishedSound();
            }
            
            // é¡¯ç¤ºçµæŸé€šçŸ¥
            showTimerFinishedNotification();
            
            // è®“åœ“åœˆé–ƒçˆ
            const timerCircle = document.getElementById('timerCircle');
            timerCircle.style.animation = 'timerFinished 1s ease-in-out infinite alternate';
            
            setTimeout(() => {
                timerCircle.style.animation = 'none';
            }, 5000);
        }

        // æ’­æ”¾è¨ˆæ™‚å™¨æ»´ç­”è²
        function playTimerTickSound() {
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                oscillator.type = 'square';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (error) {
                console.log('æ»´ç­”è²æ’­æ”¾å¤±æ•—:', error);
            }
        }

        // æ’­æ”¾è¨ˆæ™‚çµæŸéŸ³æ•ˆ
        function playTimerFinishedSound() {
            try {
                // æ’­æ”¾ä¸€é€£ä¸²ä¸Šå‡éŸ³éš
                const notes = [523, 659, 784, 1047, 1319]; // C5, E5, G5, C6, E6
                notes.forEach((frequency, index) => {
                    setTimeout(() => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.3);
                    }, index * 150);
                });
            } catch (error) {
                console.log('çµæŸéŸ³æ•ˆæ’­æ”¾å¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºè¨ˆæ™‚çµæŸé€šçŸ¥
        function showTimerFinishedNotification() {
            // å‰µå»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
                color: white;
                padding: 30px 40px;
                border-radius: 20px;
                font-size: 2rem;
                font-weight: bold;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                z-index: 3000;
                text-align: center;
                border: 4px solid #c53030;
                animation: timerNotificationPulse 1s ease-in-out infinite alternate;
            `;
            
            notification.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 10px;">â°</div>
                <div>è¨ˆæ™‚çµæŸï¼</div>
                <div style="font-size: 1rem; margin-top: 10px; opacity: 0.9;">Time's Up!</div>
            `;
            
            document.body.appendChild(notification);
            
            // 5ç§’å¾Œè‡ªå‹•ç§»é™¤
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
            
            // é»æ“Šç§»é™¤
            notification.addEventListener('click', () => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            });
        }

        // ç›£è½è¨ˆæ™‚å™¨è¼¸å…¥è®ŠåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const minutesInput = document.getElementById('timerMinutes');
            const secondsInput = document.getElementById('timerSeconds');
            
            if (minutesInput && secondsInput) {
                minutesInput.addEventListener('input', updateTimerDisplay);
                secondsInput.addEventListener('input', updateTimerDisplay);
                
                // åˆå§‹åŒ–é¡¯ç¤º
                updateTimerDisplay();
            }
        });

        // åˆå§‹åŒ–ï¼ˆå‘å¾Œç›¸å®¹ï¼‰
        initializeApp();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9882185f06cd8098',t:'MTc1OTM4NjA0MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
